<!DOCTYPE html>
<html lang="zh-TW">
<head>
<link rel="apple-touch-icon" href="icon.png">
<link rel="shortcut icon" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®¶æ•™å°æœ¬æœ¬ (V165 CleanLayout)</title>
    <style>
        /* --- Pantone è«è˜­è¿ª æ¥µç°¡è‰²ç³» --- */
        :root {
            --bg-color: #F9F8F6; 
            --text-main: #544E4E; 
            --text-sub: #9E9E9E;
            --card-bg: #FFFFFF;
            --accent-rose: #D4A5A5; 
            --btn-dark: #544E4E;
            --gold: #C5A065; 
            --money-green: #06C755; 
            --btn-red-text: #D32F2F;
            --btn-green-text: #2E7D32;
            --ui-height: 44px;
        }

        .color-cloud { background: linear-gradient(135deg, #E0F2F1, #B2DFDB); color: #544E4E !important; }
        .color-sakura { background: linear-gradient(135deg, #FFEBEE, #FFCDD2); color: #544E4E !important; }
        .color-matcha { background: linear-gradient(135deg, #F1F8E9, #DCEDC8); color: #544E4E !important; }
        .color-taro { background: linear-gradient(135deg, #F3E5F5, #E1BEE7); color: #544E4E !important; }
        .color-latte { background: linear-gradient(135deg, #E6D2B5, #F2E3CF); color: #5D4B4B; }
        .color-lemon { background: linear-gradient(135deg, #FFFDE7, #FFF59D); color: #544E4E !important; }
        .color-sherbet { background: linear-gradient(135deg, #FBE9E7, #FFCCBC); color: #544E4E !important; }
        .color-fog { background: linear-gradient(135deg, #FAFAFA, #E0E0E0); color: #544E4E !important; }

        html, body { background-color: var(--bg-color); margin: 0; padding: 0; font-family: "Nunito", sans-serif; padding-bottom: 20px; -webkit-tap-highlight-color: transparent; user-select: none; overflow-x: hidden; width: 100vw; }
        
        body { padding-top: 110px; }

        header {
            background: rgba(255,255,255,0.98); backdrop-filter: blur(20px);
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: 30px; 
            padding-left: 24px; padding-right: 24px;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02); box-sizing: border-box;
            height: auto; 
        }
        
        #header-left { display: flex; flex-direction: column; justify-content: center; height: 100%; padding-top: 15px;}
        #header-brand { font-size: 13px; font-weight: 800; letter-spacing: 1px; margin-bottom: 2px; }
        #header-page-title { font-size: 24px; font-weight: 900; color: var(--accent-rose); transition: 0.3s; }
        .menu-btn { font-size: 26px; color: var(--text-sub); cursor: pointer; padding: 5px; margin-top: 15px; }

        .container { padding: 50px 24px 20px 24px; min-height: 80vh; }
        
        .floating-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        .section-label-floating { font-size: 14px; font-weight: 700; color: #AAA; letter-spacing: 1px; }

        .capsule-btn-uniform {
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 800; color: #FFFFFF;
            cursor: pointer; display: flex; justify-content: center; align-items: center; 
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.1s;
        }
        .capsule-btn-uniform:active { transform: scale(0.95); }
        .btn-pink { background: var(--accent-rose); }
        .btn-grey { background: var(--btn-dark); } 

        .card { background: var(--card-bg); border-radius: 32px; padding: 20px 24px; margin-bottom: 40px; box-shadow: var(--shadow-soft); border: 1px solid #F5F5F5; }

        .student-scroll-wrapper { display: flex; overflow-x: auto; gap: 12px; padding: 5px; scrollbar-width: none; min-height: 95px; }
        .student-scroll-wrapper::-webkit-scrollbar { display: none; }
        
        /* Student Avatar */
        .student-avatar-btn { 
            flex: 0 0 85px; height: 85px; border-radius: 24px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.06); border: 2px solid #FFF; 
            cursor: pointer; position: relative; transition: 0.2s; 
        }
        .student-avatar-btn:active { transform: scale(0.95); }
        .avatar-name { font-size: 11px; font-weight: 700; margin-top: 4px; color: inherit; pointer-events: none; }
        .avatar-grade { font-size: 9px; opacity: 0.8; color: inherit; pointer-events: none; }
        
        @keyframes jiggle { 0% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } 100% { transform: rotate(-2deg); } }
        .is-editing { animation: jiggle 0.25s infinite; }

        .delete-badge {
            display: none; position: absolute; top: -8px; right: -8px;
            width: 24px; height: 24px; border-radius: 50%;
            background: #FFFFFF; border: 1px solid var(--btn-red-text);
            color: var(--btn-red-text); font-size: 14px; font-weight: 900;
            justify-content: center; align-items: center;
            z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .is-editing .delete-badge { display: flex; }

        .schedule-item { background: #FFFFFF; border-radius: 28px; padding: 20px; margin-bottom: 16px; border-left: 5px solid var(--accent-rose); box-shadow: 0 5px 15px rgba(0,0,0,0.03); transition: 0.3s; position: relative; }
        .schedule-item.is-done { background: #FAFAFA; border-color: #EEE; border-left-color: #DDD !important; opacity: 0.8; }
        .schedule-item.is-done .sch-name, .schedule-item.is-done .inline-note, .schedule-item.is-done .sch-subject { opacity: 0.6; filter: grayscale(1); }
        
        .sch-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .sch-name-col { display: flex; flex-direction: column; }
        .sch-name { font-size: 17px; font-weight: 900; color: #544E4E; }
        .sch-subject { font-size: 13px; font-weight: 700; color: var(--accent-rose); margin-top: 4px; }
        
        .sch-status { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 10px; height: fit-content; }
        .status-prepared { background: #F0F4F8; color: #999; }
        .status-running { background: #E8F5E9; color: var(--money-green); animation: pulse 2s infinite; }
        .status-done { background: #DDD; color: #888; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0.2); } 70% { box-shadow: 0 0 0 10px rgba(6, 199, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0); } }

        .card-controls { display: flex; gap: 8px; margin-top: 15px; border-top: 1px dashed #EEE; padding-top: 15px; position: relative; }
        .btn-card-action { flex: 1; padding: 10px; border-radius: 14px; border: 1px solid #EEE; font-size: 13px; font-weight: 800; color: #666; background: #FFF; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; white-space: nowrap; transition: 0.1s;}
        .btn-card-action:active { transform: scale(0.98); }
        .btn-card-primary { background: var(--money-green); color: white; border: none; }
        
        /* White Buttons */
        .btn-card-cancel { background: #FFFFFF; color: var(--btn-red-text); border: 1px solid var(--btn-red-text); }
        .btn-card-start { background: #FFFFFF; color: var(--btn-green-text); border: 1px solid var(--btn-green-text); }
        .btn-card-stop { background: var(--accent-rose); color: white; border: none; }
        .btn-card-grey-trash { flex:0 0 50px; background: #F5F5F5; color: #666; font-size: 20px; border: none; }

        .more-menu-popover {
            position: absolute; bottom: 100%; left: 0; background: #FFF; border-radius: 16px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 1px solid #EEE;
            display: none; flex-direction: column; overflow: hidden; z-index: 20;
            margin-bottom: 8px; min-width: 120px;
        }
        .more-menu-item { padding: 12px 15px; font-size: 14px; font-weight: 700; color: #544E4E; cursor: pointer; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #F5F5F5; }
        .more-menu-item:last-child { border-bottom: none; }
        .more-menu-item:active { background: #F9F9F9; }

        .timer-display-inline { font-size: 40px; font-weight: 900; color: var(--text-main); text-align: center; margin: 15px 0; font-variant-numeric: tabular-nums; }
        .inline-note { width: 100%; padding: 12px; background: #F8F9FA; border: 1px solid #EEE; border-radius: 14px; font-size: 13px; color: #555; box-sizing: border-box; outline: none; resize: none; margin-top: 5px; margin-bottom: 0; font-family: inherit; transition: 0.3s; min-height: 40px; }
        
        .photo-grid { display: flex; gap: 8px; margin: 5px 0 10px 0; overflow-x: auto; scrollbar-width: none; padding: 2px; }
        .log-image-preview { 
            width: 60px; height: 60px; border-radius: 12px; 
            background-size: cover; background-position: center; 
            border: 2px solid #EEE; flex-shrink: 0; position: relative;
        }

        .portfolio-list { max-height: 50vh; overflow-y: auto; }
        .portfolio-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 16px; margin-bottom: 8px; background: #FFF; border: 1px solid #F0F0F0; }
        .portfolio-item-left { display: flex; flex-direction: column; gap: 4px; }
        .portfolio-title { font-size: 16px; font-weight: 800; color: #544E4E; }
        .portfolio-sub { font-size: 12px; font-weight: 700; color: #AAA; }
        .portfolio-right-col { display: flex; align-items: center; gap: 5px; }
        
        .icon-btn { width: 32px; height: 32px; border-radius: 10px; display: flex; justify-content: center; align-items: center; border: none; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-edit { background: #F0F4F8; }
        .btn-settle { background: #E8F5E9; }
        .btn-delete { background: #FFEBEE; }
        
        .student-link { color: #544E4E; text-decoration: underline; text-decoration-color: var(--accent-rose); text-underline-offset: 3px; cursor: pointer; font-weight: 900; }

        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1099; display: none; }
        .sidebar { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: #FFFFFF; z-index: 1100; transition: right 0.3s; padding: 30px; box-sizing: border-box; }
        .sidebar.active { right: 0; }
        .sidebar-header { text-align: center; margin-bottom: 40px; }
        
        .sidebar-avatar { 
            width: 80px; height: 80px; border-radius: 50% !important; 
            background: #FFF0F3; font-size: 40px; 
            display: flex; justify-content: center; align-items: center; 
            margin: 0 auto 10px auto; 
            border: 2px solid var(--accent-rose); cursor: pointer; 
            background-size: cover; background-position: center; 
            z-index: 10; position: relative;
            background-image: none; 
            flex-shrink: 0; 
        }
        
        .profile-avatar-large {
             width: 120px; height: 120px; border-radius: 50% !important;
             background: #FFF0F3; font-size: 60px;
             display: flex; justify-content: center; align-items: center;
             margin: 10px auto 20px auto;
             border: 3px solid var(--accent-rose); cursor: pointer;
             background-size: cover; background-position: center;
             flex-shrink: 0;
        }
        
        .sidebar-name { font-size: 18px; font-weight: 900; color: #544E4E; }
        .sidebar-item { padding: 15px; border-radius: 16px; background: #F9F9F9; font-size: 16px; font-weight: 700; color: #666; margin-bottom: 10px; cursor: pointer; }

        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(50, 50, 50, 0.1); backdrop-filter: blur(10px); 
            z-index: 2000; 
            justify-content: center; 
            align-items: center; /* Centered */
            padding: 20px; 
            box-sizing: border-box; 
        }
        #log-modal { z-index: 2100; }

        .modal-content { 
            background: #FFFFFF; width: 90%; max-width: 360px; 
            border-radius: 36px; padding: 28px; 
            max-height: 85vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            position: relative; margin: auto;
        }
        
        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 16px; border: 1px solid #EEE; border-radius: 16px; background: #FAFAFA; font-size: 16px; box-sizing: border-box; outline: none; }
        
        .clean-input-container { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; border-bottom: none; width: 100%; }
        .currency-symbol { font-size: 40px; font-weight: 900; color: #544E4E; margin-right: 5px; }
        
        .clean-input, .settle-input {
            border: none; background: transparent; font-size: 40px; font-weight: 900; color: #544E4E;
            text-align: left; width: auto; min-width: 100px; padding: 10px 0; margin-bottom: 0; border-radius: 0; outline: none;
        }
        
        #settlement-manual-hours {
            height: 44px; line-height: normal; font-size: 16px; padding: 0 10px; margin-bottom: 0;
            border: 1px solid #EEE; border-radius: 16px; background: #FAFAFA; text-align: center; font-weight: normal;
        }
        
        .clean-input::placeholder { color: #E0E0E0; }
        
        .date-input-wrapper { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; width: 100%; }
        input[type="date"] { flex: 1; height: var(--ui-height); line-height: var(--ui-height); padding: 0 12px; margin: 0; border-radius: 16px; border: 1px solid #EEE; box-sizing: border-box; }
        .add-date-btn { width: var(--ui-height); height: var(--ui-height); background: var(--accent-rose); color: white; border: none; border-radius: 12px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #date-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .date-tag { 
            background: #F0F4F8; color: #555; padding: 6px 12px; 
            border-radius: 20px; font-size: 13px; font-weight: 700; 
            display: flex; align-items: center; border: 1px solid #E0E0E0; 
            cursor: pointer;
        }

        .btn-group { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .select-btn { flex: 1 0 28%; height: var(--ui-height); border: 1px solid #EEE; background: #FAFAFA; border-radius: 16px; font-size: 14px; font-weight: 700; color: #AAA; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        .action-btn { width: 100%; padding: 18px; border: none; border-radius: 22px; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 10px; }
        .primary-btn { background: var(--btn-dark); color: white; }
        .secondary-btn { background: #F5F5F5; color: #999; margin-top: 10px; }
        
        .asset-total-card { 
            text-align: center; border: 3px solid var(--gold); 
            box-shadow: 0 15px 40px rgba(197, 160, 101, 0.15); 
            margin-bottom: 30px; position: relative; overflow: hidden; 
            background-color: #FFFFFF; 
            background-image: linear-gradient(115deg, transparent 75%, rgba(197, 160, 101, 0.1) 75%), linear-gradient(245deg, transparent 60%, rgba(197, 160, 101, 0.05) 60%), linear-gradient(to bottom, #FFFFFF, #FFFCF5);
        }
        
        .asset-value { font-size: 48px; font-weight: 900; color: var(--gold); letter-spacing: -1px; position: relative; z-index: 2; }
        .section-label-floating { position: relative; z-index: 2; }
        
        .asset-row { display: flex; align-items: center; justify-content: space-between; padding: 18px 0; border-bottom: 1px solid #F5F5F5; cursor: pointer; gap: 10px; }
        .asset-info { flex: 1; min-width: 0; }
        .asset-name { font-size: 16px; font-weight: 800; color: #544E4E; display: flex; align-items: center; gap: 5px; }
        .asset-desc { font-size: 12px; color: #BBB; margin-top: 2px; } 
        .asset-amount { font-size: 18px; font-weight: 800; color: #544E4E; }
        .bank-controls { display: flex; gap: 5px; margin-top: 8px; }
        .bank-btn { flex: 0 0 auto; padding: 4px 12px; border-radius: 8px; border: none; font-weight: 800; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .bank-btn-deposit { background: #EDF7ED; color: #388E3C; } 
        .bank-btn-withdraw { background: #FFEBEE; color: #D32F2F; } 
        
        .color-row { display: flex; gap: 15px; justify-content: center; padding: 10px 0 20px 0; }
        .color-dot { width: 44px; height: 44px; border-radius: 50%; flex-shrink: 0; border: 3px solid #FFF; box-shadow: 0 4px 10px rgba(0,0,0,0.08); cursor: pointer; transition: 0.2s; }
        .color-dot.selected { transform: scale(1.2); border-color: #544E4E; }
        
        .income-report-card { padding: 20px; border: 1px solid #EAEAEA; margin-top: 20px; }
        
        /* V165 Fix: Tight Spacing */
        .income-val-big { 
            font-size: 36px; font-weight: 900; color: var(--accent-rose); 
            text-align: center; 
            margin: 0 0 30px 0; /* Increase bottom margin for spacing with list title */
        }
        
        .income-estimate-small { 
            font-size: 13px; font-weight: 800; color: #BBB; 
            text-align: center; 
            margin-bottom: -5px; /* Pull closer to big number */
            letter-spacing: 0.5px; 
        }

        .year-total-footer { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #F5F5F5; font-size: 13px; font-weight: 800; color: #BBB; text-align: center; }
        .month-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
        .month-btn { background: #FFF; border: 1px solid #EEE; border-radius: 12px; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 18px; color: var(--accent-rose); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .month-display { font-size: 18px; font-weight: 900; color: #544E4E; }

        .portfolio-total-val { font-size: 32px; font-weight: 900; color: var(--gold); margin-top: 5px; text-align: center;}
        .portfolio-header { text-align: center; border-bottom: 1px solid #EEE; margin-bottom: 15px; padding-bottom: 15px;}
        
        /* Viewport for slider */
        #main-viewport {
            width: 100vw;
            overflow: hidden;
        }
        #page-slider {
            display: flex;
            width: 200vw;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateX(0);
        }
        .page {
            width: 100vw;
            flex-shrink: 0;
            display: block !important;
            opacity: 1 !important;
            padding: 50px 24px 20px 24px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-avatar" id="sidebar-avatar" onclick="openProfileModal()">ğŸ§¸</div>
        <div class="sidebar-name" id="sidebar-name">Shannon</div>
        <div class="sidebar-role">TEACHER</div>
    </div>
    <div class="sidebar-menu">
        <div class="sidebar-item" onclick="openProfileModal()">ğŸ“ å¿ƒæƒ…æ—¥è¨˜</div>
        <div class="sidebar-item" onclick="switchTab('home')">ğŸ—“ï¸ æ’èª²ç³»çµ±</div>
        <div class="sidebar-item" onclick="switchTab('stats')">ğŸ“Š è³‡ç”¢å ±è¡¨</div>
        <div class="sidebar-item" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</div>
        <div class="sidebar-item" onclick="triggerImport()">ğŸ“¥ åŒ¯å…¥è³‡æ–™</div>
        <input type="file" id="import-file" style="display:none" onchange="importData(this)">
    </div>
</div>

<header>
    <div id="header-left">
        <div id="header-brand">
            <span style="color:var(--gold)">SHANNON</span> 
            <span style="color:var(--text-main)">Â· å®¶æ•™å°æœ¬æœ¬</span>
        </div>
        <div id="header-page-title">æ’èª²ç³»çµ±</div>
    </div>
    <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
</header>

<div id="main-viewport">
    <div id="page-slider">
        <div id="home-page" class="page container">
            <div class="floating-section-header">
                <div class="section-label-floating">ğŸ§‘â€ğŸ“ å­¸ç”Ÿåˆ—è¡¨</div>
                <div class="capsule-btn-uniform btn-pink" onclick="openSetupModal()">+ æ–°å¢å­¸ç”Ÿ</div>
            </div>
            <div class="card" style="padding:15px;"><div class="student-scroll-wrapper" id="student-scroll"></div></div>
            <div class="floating-section-header">
                <div class="section-label-floating">ğŸ“ ä»Šæ—¥èª²è¡¨</div>
                <div class="capsule-btn-uniform btn-grey" onclick="openAllScheduleModal()">æ­·å²ç´€éŒ„</div>
            </div>
            <div id="today-schedule-list"></div>
            <div id="empty-schedule-hint" style="display:none; text-align:center; padding:40px; color:#DDD; font-size:12px;">ä»Šå¤©é‚„æ²’æ’èª²å–”</div>
        </div>

        <div id="stats-page" class="page container">
            <div class="card asset-total-card">
                <div class="section-label-floating">ğŸ’° æ‚¨çš„ç¸½è³‡ç”¢</div>
                <div class="asset-value" id="total-assets-val">$0</div>
            </div>
            <div class="card">
                <div class="floating-section-header" style="margin-top:0; margin-bottom:5px;">
                    <div class="section-label-floating">å¸³æˆ¶é¤˜é¡æ˜ç´°</div>
                </div>
                <div class="asset-row">
                    <div class="asset-info" onclick="openBankHistory('taiwan_bank')">
                        <div class="asset-name">ğŸ¦ å°ç£éŠ€è¡Œ</div>
                        <div class="asset-desc">å°å¹£å­˜æ¬¾</div>
                    </div>
                    <div class="asset-right-col">
                        <div class="asset-amount" id="taiwan-bank-balance" style="font-weight:900;">$100,000</div>
                        <div class="bank-controls">
                            <button class="bank-btn bank-btn-deposit" onclick="openBankInput('deposit', 'taiwan_bank')">+ å­˜å…¥</button>
                            <button class="bank-btn bank-btn-withdraw" onclick="openBankInput('withdraw', 'taiwan_bank')">- æé ˜</button>
                        </div>
                    </div>
                </div>
                <div class="asset-row">
                    <div class="asset-info" onclick="openBankHistory('sinopac')">
                        <div class="asset-name">ğŸ“‰ æ°¸è±è­‰åˆ¸</div>
                        <div class="asset-desc">è‚¡ç¥¨è³‡ç”¢</div>
                    </div>
                    <div class="asset-right-col">
                        <div class="asset-amount" id="sinopac-balance" style="font-weight:900;">$13,107</div>
                        <div class="bank-controls">
                            <button class="bank-btn bank-btn-deposit" onclick="openBankInput('deposit', 'sinopac')">+ å­˜å…¥</button>
                            <button class="bank-btn bank-btn-withdraw" onclick="openBankInput('withdraw', 'sinopac')">- æé ˜</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card income-report-card">
                <div class="month-nav">
                    <button class="month-btn" onclick="changeMonth(-1)">â®</button>
                    <div class="month-display" id="stats-month-display">2025å¹´ 12æœˆ</div>
                    <button class="month-btn" onclick="changeMonth(1)">â¯</button>
                </div>
                <div class="income-estimate-small" id="month-estimate-val">$0</div>
                <div class="income-val-big" id="month-total">$0</div>
                
                <div class="section-label-floating" style="margin-bottom:10px; border-bottom:1px solid #EEE; padding-bottom:5px;">æœ¬æœˆå®Œèª²ç´€éŒ„</div>
                <div id="all-logs"></div>
                <div class="year-total-footer">ğŸ“… <span id="year-label">2025</span> å…¨å¹´å·²çµç®—ï¼š<span id="year-total" style="color:#544E4E;">$0</span></div>
            </div>
        </div>
    </div>
</div>

<div id="log-modal" class="modal">
    <div class="modal-content">
        <h3 id="log-name-display" style="text-align:center; color:#544E4E;"></h3>
        <label>ä¸Šèª²æ™‚æ•¸</label>
        <div class="btn-group" id="log-hours-group">
            <div class="select-btn" onclick="forceSelectButton(1.5, this, 'log-hours')">1.5</div>
            <div class="select-btn" onclick="forceSelectButton(2.0, this, 'log-hours')">2.0</div>
            <div class="select-btn" onclick="forceSelectButton(2.5, this, 'log-hours')">2.5</div>
            <div class="select-btn" onclick="forceSelectButton(3.0, this, 'log-hours')">3.0</div>
        </div>
        <input type="number" id="log-hours" placeholder="æ‰‹å‹•è¼¸å…¥æ™‚æ•¸">
        
        <label>ç§‘ç›®å¿«é¸</label>
        <div class="btn-group" id="subject-group">
            <div class="select-btn" onclick="selectSubject('æ•¸å­¸', this)">æ•¸å­¸</div>
            <div class="select-btn" onclick="selectSubject('ç†åŒ–', this)">ç†åŒ–</div>
            <div class="select-btn" onclick="selectSubject('è‹±æ–‡', this)">è‹±æ–‡</div>
        </div>
        <input type="hidden" id="log-subject-selected">
        
        <label>ä¸Šèª²å…§å®¹ (é¸å¡«)</label><textarea id="log-content-modal" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç« è¤‡ç¿’"></textarea>
        <label>æ—¥æœŸ</label>
        <div class="date-input-wrapper">
            <input type="date" id="log-date">
            <button class="add-date-btn" onclick="addDateTag()">+</button>
        </div>
        <div id="date-tags" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:15px;"></div>
        <button class="action-btn primary-btn" onclick="saveBatchPlan()">ç¢ºèªå„²å­˜</button>
        <button class="action-btn secondary-btn" onclick="closeModal('log-modal')">å–æ¶ˆ</button>
    </div>
</div>

<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; color:#544E4E;">æ–°å¢å­¸ç”Ÿ</h3>
        <label>æš±ç¨±</label><input type="text" id="new-name" placeholder="è¼¸å…¥æš±ç¨±">
        <label>å¹´ç´š</label>
        <div class="btn-group">
            <div class="select-btn" onclick="forceSelectButton('åœ‹ä¸€', this, 'new-grade')">åœ‹ä¸€</div>
            <div class="select-btn" onclick="forceSelectButton('åœ‹äºŒ', this, 'new-grade')">åœ‹äºŒ</div>
            <div class="select-btn" onclick="forceSelectButton('åœ‹ä¸‰', this, 'new-grade')">åœ‹ä¸‰</div>
            <div class="select-btn" id="btn-trial" onclick="toggleTrialMode(this)">è©¦ä¸Š</div>
        </div>
        <input type="hidden" id="new-grade">
        
        <div id="trial-hours-section" style="display:none; background:#FFF0F3; padding:10px; border-radius:12px; margin-bottom:15px;">
            <label style="color:#D4A5A5;">è©¦ä¸Šæ™‚æ•¸</label>
            <div class="btn-group">
                <div class="select-btn" onclick="setNewTrialHours(1.0, this)">1.0</div>
                <div class="select-btn" onclick="setNewTrialHours(1.5, this)">1.5</div>
                <div class="select-btn" onclick="setNewTrialHours(2.0, this)">2.0</div>
                <div class="select-btn" onclick="setNewTrialHours(2.5, this)">2.5</div>
            </div>
            <input type="hidden" id="new-trial-hours">
        </div>

        <label id="rate-label">æ™‚è–ª</label>
        <div class="btn-group">
            <div class="select-btn" onclick="selectRate(600, this)">600</div>
            <div class="select-btn" onclick="selectRate(675, this)">675</div>
            <div class="select-btn" onclick="selectRate(750, this)">750</div>
            <div class="select-btn" onclick="selectRate(800, this)">800</div>
            <div class="select-btn" onclick="selectRate(850, this)">850</div>
        </div>
        <input type="number" id="new-rate" placeholder="æˆ–è¼¸å…¥è‡ªå®šç¾©é‡‘é¡">
        
        <label>ä»£è¡¨è‰²</label>
        <div class="color-row">
            <div class="color-dot color-sakura" onclick="selectColor('color-sakura', this)"></div>
            <div class="color-dot color-matcha" onclick="selectColor('color-matcha', this)"></div>
            <div class="color-dot color-latte" onclick="selectColor('color-latte', this)"></div>
            <div class="color-dot color-cloud" onclick="selectColor('color-cloud', this)"></div>
            <div class="color-dot color-fog" onclick="selectColor('color-fog', this)"></div>
        </div>
        <input type="hidden" id="new-color">
        <button class="action-btn primary-btn" onclick="addStudent()">ç¢ºèªæ–°å¢</button>
        <button class="action-btn secondary-btn" onclick="closeModal('setup-modal')">å–æ¶ˆ</button>
    </div>
</div>

<div id="all-schedule-modal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="portfolio-header">
            <h2 style="margin:0 0 5px 0; color:#544E4E;">ğŸ“š æ­·å²ç´€éŒ„</h2>
            <div style="font-size:12px; color:#AAA;">æ‰€æœ‰èª²ç¨‹ç´€éŒ„</div>
        </div>
        <div class="portfolio-list" id="all-schedule-list"></div>
        <button class="action-btn secondary-btn" onclick="closeModal('all-schedule-modal')">é—œé–‰</button>
    </div>
</div>

<div id="student-history-modal" class="modal">
    <div class="modal-content">
        <div class="portfolio-header">
            <h2 id="student-history-name" style="margin:0 0 5px 0; color:#544E4E;"></h2>
            <div style="font-size:12px; color:#AAA;">æœ¬æœˆè²¢ç»</div>
            <div class="portfolio-total-val" id="student-history-total">$0</div>
        </div>
        <div style="font-weight:800; color:#AAA; margin-bottom:10px; font-size:13px;">æœ¬æœˆèª²ç¨‹</div>
        <div class="portfolio-list" id="student-history-list"></div>
        <button class="action-btn secondary-btn" onclick="closeModal('student-history-modal')">é—œé–‰</button>
    </div>
</div>

<div id="settlement-modal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; margin-top:0; color:#544E4E;">ç¢ºèªæœ€çµ‚æ™‚æ•¸</h3>
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:13px; color:#AAA;">åŸæœ¬æ’å®š</div>
            <div id="settlement-planned-hours" style="font-size:24px; font-weight:700; color:#CCC;">2.0 å°æ™‚</div>
            <div style="font-size:13px; color:#AAA; margin-top:10px;">å¯¦éš›è¨ˆæ™‚</div>
            <div id="settlement-timer-display" style="font-size:32px; font-weight:900; color:#D4A5A5;">00:00:00</div>
        </div>
        <div style="border-top:2px dashed #F0F0F0; padding-top:15px; margin-bottom:15px;">
            <label>è«‹é¸æ“‡æˆ–è¼¸å…¥å¯¦éš›æ™‚æ•¸</label>
            <div class="btn-group" id="settlement-hours-group">
                <div class="select-btn" onclick="setSettlementInput(1.5, this)">1.5</div>
                <div class="select-btn" onclick="setSettlementInput(2.0, this)">2.0</div>
                <div class="select-btn" onclick="setSettlementInput(2.5, this)">2.5</div>
                <div class="select-btn" onclick="setSettlementInput(3.0, this)">3.0</div>
            </div>
            <label>ç¢ºèªè¼¸å…¥ (å¿…å¡«)</label>
            <input type="number" id="settlement-manual-hours" placeholder="ä¾‹å¦‚ 1.8">
        </div>
        <button class="action-btn primary-btn" onclick="confirmSettlement()">ç¢ºèªä¸¦çµç®—</button>
        <button class="action-btn secondary-btn" onclick="closeModal('settlement-modal')">å–æ¶ˆ</button>
    </div>
</div>

<div id="bank-input-modal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; color:#544E4E;" id="bank-input-title">å­˜å…¥é‡‘é¡</h3>
        <div id="bank-target-name" style="text-align:center; margin-bottom:15px; color:#888;"></div>
        
        <div class="clean-input-container">
            <span class="currency-symbol">$</span>
            <input type="number" id="bank-amount" class="clean-input" placeholder="0" autofocus>
        </div>
        
        <label>å‚™è¨»</label><input type="text" id="bank-note" placeholder="ä¾‹å¦‚ï¼šè–ªæ°´">
        <label>æ—¥æœŸ</label>
        <div class="date-input-wrapper"><input type="date" id="bank-date"></div>
        <button class="action-btn primary-btn" onclick="submitBankTransaction()">ç¢ºèª</button>
        <button class="action-btn secondary-btn" onclick="closeModal('bank-input-modal')">å–æ¶ˆ</button>
    </div>
</div>

<div id="bank-history-modal" class="modal">
    <div class="modal-content">
        <div class="portfolio-header">
            <h2 id="history-bank-name" style="margin:0; color:#544E4E;"></h2>
            <div style="font-size:12px; color:#AAA; margin-top:5px;">ç›®å‰é¤˜é¡</div>
            <div id="modal-bank-balance" class="portfolio-total-val"></div>
        </div>
        <div style="font-weight:800; color:#AAA; margin-bottom:10px; font-size:13px;">äº¤æ˜“æ˜ç´°</div>
        <div class="portfolio-list" id="bank-history-list"></div>
        <button class="action-btn secondary-btn" onclick="closeModal('bank-history-modal')">é—œé–‰</button>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <h3 style="text-align:center; margin-top:0; color:#544E4E;">ğŸ‘©â€ğŸ« è€å¸«å°ˆå±¬ç©ºé–“</h3>
        <input type="file" id="avatar-upload" style="display:none" accept="image/*" onchange="handleAvatarUpload(this)">
        <div class="profile-avatar-large" id="profile-avatar" onclick="triggerUpload()">ğŸ§¸</div>
        <div style="text-align:center; font-size:12px; color:#AAA; margin-bottom:20px;">(é»æ“Šæ›´æ›é ­åƒ / æ”¯æ´ç›¸ç°¿)</div>
        <label>ä»Šæ—¥å¿ƒæƒ…æ—¥è¨˜</label>
        <textarea id="mood-input" placeholder="å¯«é»ä»€éº¼..." style="height:80px;"></textarea>
        <button class="action-btn primary-btn" onclick="saveMood()">å­˜æª”</button>
        <div style="margin-top:20px; border-top:2px dashed #EEE; padding-top:15px;">
            <div style="font-size:14px; font-weight:800; color:#AAA; margin-bottom:10px;">éå¾€æ—¥è¨˜</div>
            <div id="mood-list" style="max-height:200px; overflow-y:auto;"></div>
        </div>
        <button class="action-btn secondary-btn" onclick="closeModal('profile-modal')">é—œé–‰</button>
    </div>
</div>

<script>
    const DB_STU = 'tutor_v10_students';
    const DB_LOG = 'tutor_v15_logs';
    const DB_BANK = 'tutor_v27_bank';
    const DB_PROFILE = 'tutor_v33_profile';

    window.students = JSON.parse(localStorage.getItem(DB_STU)) || [];
    window.logs = JSON.parse(localStorage.getItem(DB_LOG)) || [];
    window.bankLogs = JSON.parse(localStorage.getItem(DB_BANK)) || [];
    let profileData = { avatar: 'ğŸ§¸', avatarImg: null, moods: [] };
    try { profileData = JSON.parse(localStorage.getItem(DB_PROFILE)) || { avatar: 'ğŸ§¸', avatarImg: null, moods: [] }; } catch(e){}

    window.currentPlanningStuIdx = null;
    window.selectedDates = [];
    window.currentBankAction = 'deposit';
    window.currentAccountId = 'taiwan_bank';
    window.settlingLogTs = null;
    window.settlingTimerMs = "00:00:00";
    window.viewDate = new Date(); 
    window.editingLogTs = null;
    window.isTrialMode = false;
    
    // Swipe Navigation
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    let currentPage = 'home';
    let isSwipeIgnored = false;

    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        if (e.target.closest('.student-scroll-wrapper') || 
            e.target.closest('.photo-grid') || 
            e.target.closest('.modal')) {
            isSwipeIgnored = true;
        } else {
            isSwipeIgnored = false;
        }
    });

    document.addEventListener('touchend', e => {
        if (isSwipeIgnored) return; 
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
    });

    function handleSwipe() {
        if(Math.abs(touchEndY - touchStartY) > 50) return;
        if (touchEndX < touchStartX - 80) {
            if(currentPage === 'home') switchTab('stats');
        }
        if (touchEndX > touchStartX + 80) {
            if(currentPage === 'stats') switchTab('home');
        }
    }

    window.forceSelectButton = function(val, btn, inputId) {
        const container = btn.parentNode;
        const buttons = container.getElementsByClassName('select-btn');
        for (let b of buttons) {
            if(b.id !== 'btn-trial') {
                b.style.backgroundColor = "#FAFAFA";
                b.style.color = "#AAA";
                b.style.borderColor = "#EEE";
            }
        }
        btn.style.backgroundColor = "#D4A5A5"; 
        btn.style.color = "#FFFFFF";
        btn.style.borderColor = "#D4A5A5";
        if(inputId) document.getElementById(inputId).value = val;
    }
    
    window.selectSubject = function(text, btn) {
        document.getElementById('log-subject-selected').value = text;
        const group = document.getElementById('subject-group');
        const buttons = group.getElementsByClassName('select-btn');
        for (let b of buttons) {
            b.style.backgroundColor = "#FAFAFA";
            b.style.color = "#AAA";
            b.style.borderColor = "#EEE";
        }
        if(btn) {
            btn.style.backgroundColor = "#D4A5A5";
            btn.style.color = "#FFFFFF";
            btn.style.borderColor = "#D4A5A5";
        }
    }
    
    window.toggleTrialMode = function(btn) {
        window.isTrialMode = !window.isTrialMode;
        if(window.isTrialMode) {
            btn.style.backgroundColor = "#D4A5A5";
            btn.style.color = "#FFFFFF";
            document.getElementById('trial-hours-section').style.display = 'block';
            document.getElementById('rate-label').innerText = 'è©¦ä¸Šç¸½è²»ç”¨';
        } else {
            btn.style.backgroundColor = "#FAFAFA";
            btn.style.color = "#AAA";
            document.getElementById('trial-hours-section').style.display = 'none';
            document.getElementById('rate-label').innerText = 'æ™‚è–ª';
        }
    }
    
    window.setNewTrialHours = function(h, btn) {
        const container = btn.parentNode;
        const buttons = container.querySelectorAll('.select-btn');
        buttons.forEach(b => { b.style.backgroundColor="#FAFAFA"; b.style.color="#AAA"; });
        btn.style.backgroundColor = "#D4A5A5";
        btn.style.color = "#FFFFFF";
        document.getElementById('new-trial-hours').value = h;
    }
    
    window.selectRate = function(v, btn) {
        forceSelectButton(v, btn, 'new-rate');
        let r = v;
        if(window.isTrialMode) {
            const h = parseFloat(document.getElementById('new-trial-hours').value);
            if(h) r = v * h;
        }
        document.getElementById('new-rate').value = r;
    }
    
    window.selectColor = function(color, btn) {
        document.getElementById('new-color').value = color;
        const dots = document.querySelectorAll('.color-dot');
        dots.forEach(d => d.style.transform = 'scale(1)');
        btn.style.transform = 'scale(1.2)';
    }

    window.closeModal = function(id) { document.getElementById(id).style.display='none'; }
    
    window.toggleSidebar = function() {
        const sb = document.getElementById('sidebar');
        sb.classList.toggle('active');
        document.getElementById('sidebar-overlay').style.display = sb.classList.contains('active') ? 'block' : 'none';
    }

    window.switchTab = function(page) {
        currentPage = page;
        const slider = document.getElementById('page-slider');
        if (page === 'home') {
            slider.style.transform = 'translateX(0)';
            document.getElementById('header-page-title').innerText = 'æ’èª²ç³»çµ±';
        } else {
            slider.style.transform = 'translateX(-50%)'; 
            document.getElementById('header-page-title').innerText = 'è³‡ç”¢å ±è¡¨';
        }
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        closeSidebar();
        window.renderSchedule(); window.updateAssetDisplay();
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebar-overlay').style.display = 'none';
    }
    
    window.exportData = function() {
        const data = { students: window.students, logs: window.logs, bankLogs: window.bankLogs, profile: profileData };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tutor_backup_' + new Date().toISOString().slice(0,10) + '.json';
        a.click();
    }
    
    window.triggerImport = function() { document.getElementById('import-file').click(); }
    
    window.importData = function(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.students) localStorage.setItem(DB_STU, JSON.stringify(data.students));
                    if(data.logs) localStorage.setItem(DB_LOG, JSON.stringify(data.logs));
                    if(data.bankLogs) localStorage.setItem(DB_BANK, JSON.stringify(data.bankLogs));
                    if(data.profile) localStorage.setItem(DB_PROFILE, JSON.stringify(data.profile));
                    alert('åŒ¯å…¥æˆåŠŸï¼');
                    location.reload();
                } catch(err) { alert('åŒ¯å…¥å¤±æ•—ï¼Œæ ¼å¼éŒ¯èª¤'); }
            };
            reader.readAsText(input.files[0]);
        }
    }

    window.renderStudents = function() {
        const div = document.getElementById('student-scroll');
        div.innerHTML = window.students.map((s, idx) => `
            <div class="student-avatar-btn ${s.color||'color-cloud'}" onmousedown="setupLongPress(this, 'student', ${idx})" ontouchstart="setupLongPress(this, 'student', ${idx})" onclick="handleStudentClick(${idx})">
                <div class="delete-badge" onclick="event.stopPropagation(); deleteStudent(${idx})">Ã—</div>
                <div class="avatar-name">${s.name}</div>
                <div class="avatar-grade">${s.grade||'å­¸ç”Ÿ'}</div>
            </div>
        `).join('');
    }
    
    let pressTimer;
    window.setupLongPress = function(el, type, id) {
        el.onmouseup = el.ontouchend = cancelLongPress;
        el.onmousemove = el.ontouchmove = cancelLongPress;
        pressTimer = setTimeout(() => {
            if(type === 'student') document.querySelectorAll('.student-avatar-btn').forEach(b => b.classList.add('is-editing'));
            if(type === 'photo') document.querySelectorAll('.log-image-preview').forEach(b => b.classList.add('is-editing'));
            setTimeout(() => document.addEventListener('click', clearEditMode, {once:true}), 100);
        }, 800);
    }
    
    function cancelLongPress() { clearTimeout(pressTimer); }
    
    function clearEditMode() {
        document.querySelectorAll('.is-editing').forEach(el => el.classList.remove('is-editing'));
    }
    
    window.handleStudentClick = function(idx) {
        if(document.querySelector('.student-avatar-btn.is-editing')) return; 
        openBatchPlanModal(idx);
    }
    
    window.deleteStudent = function(idx) {
        if(confirm('åˆªé™¤å­¸ç”Ÿï¼Ÿ')) {
            window.students.splice(idx, 1);
            localStorage.setItem(DB_STU, JSON.stringify(window.students));
            window.renderStudents();
        }
    }
    
    window.toggleMoreMenu = function(ts) {
        const menu = document.getElementById(`more-menu-${ts}`);
        if (menu) {
            const isVisible = menu.style.display === 'flex';
            document.querySelectorAll('.more-menu-popover').forEach(m => m.style.display = 'none');
            menu.style.display = isVisible ? 'none' : 'flex';
        }
    };
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.card-controls')) {
             document.querySelectorAll('.more-menu-popover').forEach(m => m.style.display = 'none');
        }
    });
    
    window.setupPhotoLongPress = function(el, ts, index) {
         el.onmouseup = el.ontouchend = cancelLongPress;
         el.onmousemove = el.ontouchmove = cancelLongPress;
         pressTimer = setTimeout(() => {
            const container = el.parentElement;
            container.querySelectorAll('.log-image-preview').forEach(b => b.classList.add('is-editing'));
            container.querySelectorAll('.log-image-preview').forEach((preview, idx) => {
                 if(!preview.querySelector('.delete-badge')) {
                     const btn = document.createElement('div');
                     btn.className = 'delete-badge';
                     btn.innerText = 'Ã—';
                     btn.onclick = (e) => { e.stopPropagation(); deletePhoto(ts, idx); };
                     preview.appendChild(btn);
                 }
            });
            setTimeout(() => document.addEventListener('click', clearEditMode, {once:true}), 100);
         }, 800);
    }

    window.deletePhoto = function(ts, index) {
        const log = window.logs.find(l => l.ts === ts);
        if(log && log.images) {
            log.images.splice(index, 1);
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            window.renderSchedule();
        }
    }

    window.renderSchedule = function() {
        const div = document.getElementById('today-schedule-list');
        const todayStr = new Date().toISOString().split('T')[0];
        const todays = window.logs.filter(l => l.date === todayStr || l.status === 'running');
        document.getElementById('empty-schedule-hint').style.display = todays.length ? 'none' : 'block';
        
        div.innerHTML = todays.map(l => {
            let statusHtml = '';
            let controlsHtml = '';
            const subjectHtml = l.subject ? `<div class="sch-subject">${l.subject}</div>` : '';
            
            if (l.status === 'running') {
                statusHtml = '<span class="sch-status status-running">ä¸Šèª²ä¸­</span>';
                controlsHtml = `
                    <div class="timer-display-inline" id="timer-${l.ts}">00:00:00</div>
                    <textarea class="inline-note" placeholder="ä¸Šèª²å…§å®¹..." onblur="updateContent(${l.ts}, this.value)">${l.content || ''}</textarea>
                    <div class="card-controls">
                        <div class="btn-card-action btn-card-stop" onclick="openSettlementModal(${l.ts})">â¹ï¸ ä¸‹èª²/çµç®—</div>
                    </div>`;
            } else if (l.status === 'done') {
                statusHtml = '<span class="sch-status status-done">å·²å®Œæˆ</span>';
                const actualTime = l.actualDuration ? `<div style="text-align:right; font-size:11px; color:#CCC; margin-top:4px;">â±ï¸ å¯¦éš›è¨ˆæ™‚ï¼š${l.actualDuration}</div>` : '';
                
                let imagesHtml = '';
                if(l.images && l.images.length > 0) {
                     imagesHtml = `<div class="photo-grid">` + 
                         l.images.map((img, idx) => `
                            <div class="log-image-preview" style="background-image:url(${img})" 
                                 onmousedown="setupPhotoLongPress(this, ${l.ts}, ${idx})" 
                                 ontouchstart="setupPhotoLongPress(this, ${l.ts}, ${idx})">
                            </div>`).join('') + 
                         `</div>`;
                } else if (l.image) { 
                     l.images = [l.image];
                     imagesHtml = `<div class="photo-grid"><div class="log-image-preview" style="background-image:url(${l.images[0]})"><div class="delete-badge" onclick="event.stopPropagation(); deletePhoto(${l.ts}, 0)">Ã—</div></div></div>`;
                }

                controlsHtml = `
                    <textarea class="inline-note" placeholder="ä¸Šèª²å…§å®¹..." onblur="updateContent(${l.ts}, this.value)">${l.content || ''}</textarea>
                    ${imagesHtml}
                    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.03); padding:10px; border-radius:12px; margin-top:10px;">
                        <div><span style="font-size:12px; color:#A89B9B;">çµç®— </span><b>${l.hours}h</b></div>
                        <div><span style="font-size:12px; color:#A89B9B;">æ”¶å…¥ </span><b>$${l.income}</b></div>
                    </div>
                    ${actualTime}
                    
                    <div class="card-controls">
                        <input type="file" id="file-${l.ts}" hidden onchange="handleLogImageUpload(event, ${l.ts})" accept="image/*" multiple>
                        
                        <div class="btn-card-action" onclick="toggleMoreMenu(${l.ts})">â‹¯ æ›´å¤š</div>
                        <div id="more-menu-${l.ts}" class="more-menu-popover">
                            <div class="more-menu-item" onclick="deleteLog(${l.ts})">ğŸ—‘ï¸ åˆªé™¤</div>
                            <div class="more-menu-item" onclick="openEditModal(${l.ts})">âœï¸ è£œç™»</div>
                        </div>

                        <div class="btn-card-action" onclick="triggerLogImageUpload(${l.ts})">ğŸ“· ç…§ç‰‡</div>
                        <div class="btn-card-action btn-card-primary" onclick="shareToLine(${l.ts})">ğŸš€ å›å ±</div>
                    </div>`;
            } else {
                statusHtml = '<span class="sch-status status-prepared">å¾…ä¸Šèª²</span>';
                controlsHtml = `
                    <textarea class="inline-note" placeholder="ä¸Šèª²å…§å®¹..." onblur="updateContent(${l.ts}, this.value)">${l.content || ''}</textarea>
                    <div class="card-controls">
                        <div class="btn-card-action btn-card-cancel" onclick="deleteLog(${l.ts})">âœ–ï¸ å–æ¶ˆèª²ç¨‹</div>
                        <div class="btn-card-action btn-card-start" onclick="startClass(${l.ts})">â–¶ï¸ é–‹å§‹ä¸Šèª²</div>
                    </div>`;
            }

            return `
            <div class="schedule-item ${l.status==='done'?'is-done':''}" style="border-left-color: #D4A5A5">
                <div class="sch-header">
                    <div class="sch-name-col">
                        <div class="sch-name">${l.name}</div>
                        ${subjectHtml}
                    </div>
                    ${statusHtml}
                </div>
                ${controlsHtml}
            </div>
            `;
        }).join('');
    }

    window.openSetupModal = function() {
        document.getElementById('new-name').value = '';
        document.getElementById('new-rate').value = '';
        document.getElementById('new-grade').value = '';
        document.getElementById('new-color').value = 'color-cloud';
        window.isTrialMode = false;
        document.getElementById('trial-hours-section').style.display = 'none';
        
        const buttons = document.querySelectorAll('.select-btn');
        for (let b of buttons) {
            b.style.backgroundColor = "#FAFAFA";
            b.style.color = "#AAA";
            b.style.borderColor = "#EEE";
        }
        document.getElementById('setup-modal').style.display = 'flex';
    }

    window.openBatchPlanModal = function(idx) {
        window.currentPlanningStuIdx = idx;
        window.editingLogTs = null;
        const s = window.students[idx];
        document.getElementById('log-name-display').innerText = `ç‚º ${s.name} æ’èª²`;
        document.getElementById('log-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('log-hours').value = '';
        document.getElementById('log-content-modal').value = '';
        document.getElementById('log-subject-selected').value = '';
        
        const subjGroup = document.getElementById('subject-group');
        const subjButtons = subjGroup.getElementsByClassName('select-btn');
        for (let b of subjButtons) { b.style.backgroundColor="#FAFAFA"; b.style.color="#AAA"; }
        
        window.selectedDates = []; 
        document.getElementById('date-tags').innerHTML = '';
        
        const buttons = document.getElementById('log-hours-group').getElementsByClassName('select-btn');
        for(let b of buttons) { b.style.backgroundColor="#FAFAFA"; b.style.color="#AAA"; }
        document.getElementById('log-modal').style.display = 'flex';
    }
    
    window.openEditModal = function(ts) {
        window.editingLogTs = ts;
        const log = window.logs.find(l => l.ts === ts);
        if(!log) return;
        
        document.getElementById('log-name-display').innerText = `ç·¨è¼¯ï¼š${log.name}`;
        document.getElementById('log-hours').value = log.hours;
        document.getElementById('log-content-modal').value = log.content || '';
        document.getElementById('log-date').value = log.date;
        document.getElementById('log-subject-selected').value = log.subject || '';
        window.selectedDates = [];
        document.getElementById('date-tags').innerHTML = '';
        
        const buttons = document.getElementById('log-hours-group').getElementsByClassName('select-btn');
        for(let b of buttons) { 
            b.style.backgroundColor="#FAFAFA"; b.style.color="#AAA";
            if(b.innerText.trim() == log.hours) {
                b.style.backgroundColor="#D4A5A5"; b.style.color="#FFFFFF";
            }
        }
        
        const subjGroup = document.getElementById('subject-group');
        const subjButtons = subjGroup.getElementsByClassName('select-btn');
        for (let b of subjButtons) {
            b.style.backgroundColor="#FAFAFA"; b.style.color="#AAA";
            if(log.subject && b.innerText.trim() == log.subject) {
                b.style.backgroundColor="#D4A5A5"; b.style.color="#FFFFFF";
            }
        }
        
        document.getElementById('log-modal').style.display = 'flex';
    }

    window.saveBatchPlan = function() {
        const d = document.getElementById('log-date').value;
        const h = document.getElementById('log-hours').value;
        const content = document.getElementById('log-content-modal').value;
        const subject = document.getElementById('log-subject-selected').value;
        if(!d || !h) return alert('è«‹å¡«å¯«å®Œæ•´');
        
        try {
            if (window.editingLogTs) {
                const logIndex = window.logs.findIndex(l => l.ts === window.editingLogTs);
                if(logIndex > -1) {
                    window.logs[logIndex].date = d;
                    window.logs[logIndex].hours = h;
                    window.logs[logIndex].content = content;
                    window.logs[logIndex].subject = subject;
                    window.logs[logIndex].income = Math.round(h * window.logs[logIndex].rate);
                    window.editingLogTs = null;
                }
            } else {
                const s = window.students[window.currentPlanningStuIdx];
                if (!s) throw new Error("Student data error");
                let dates = [d, ...window.selectedDates];
                dates = [...new Set(dates)];
                dates.forEach(date => {
                    window.logs.unshift({ ts: Date.now() + Math.random(), name: s.name, date: date, hours: h, rate: s.rate, status: 'prepared', income: 0, content: content, subject: subject });
                });
            }
            
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            window.closeModal('log-modal'); 
            
            setTimeout(() => {
                window.renderSchedule(); 
                window.updateAssetDisplay();
                if(document.getElementById('all-schedule-modal').style.display !== 'none') {
                    window.openAllScheduleModal();
                }
            }, 100); 
        } catch (e) {
            alert('å­˜æª”å¤±æ•—ï¼Œè«‹é‡è©¦');
            console.error(e);
        }
    }
    
    window.addDateTag = function() {
        const d = document.getElementById('log-date').value;
        if (!d) return;
        if (!window.selectedDates.includes(d)) {
            window.selectedDates.push(d);
            renderDateTags(); 
        }
    }

    window.removeDateTag = function(dateToRemove) {
        window.selectedDates = window.selectedDates.filter(d => d !== dateToRemove);
        renderDateTags();
    }

    function renderDateTags() {
        const container = document.getElementById('date-tags');
        container.innerHTML = '';
        window.selectedDates.forEach(d => {
            const tag = document.createElement('div');
            tag.className = 'date-tag';
            tag.innerHTML = `${d} <span style="margin-left:8px; opacity:0.6; font-size:16px;">Ã—</span>`;
            tag.onclick = () => removeDateTag(d);
            container.appendChild(tag);
        });
    }

    window.addStudent = function() {
        const n = document.getElementById('new-name').value;
        let r = parseFloat(document.getElementById('new-rate').value);
        const g = document.getElementById('new-grade').value || 'åœ‹ä¸­';
        const c = document.getElementById('new-color').value || 'color-cloud';
        
        if(n && r) {
            window.students.push({ name: n, rate: r, grade: g, color: c });
            localStorage.setItem(DB_STU, JSON.stringify(window.students));
            window.renderStudents(); window.closeModal('setup-modal');
        }
    }

    window.deleteLogFromHistory = function(ts) {
        if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) {
            window.logs = window.logs.filter(l => l.ts !== ts);
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            window.updateAssetDisplay();
            window.renderSchedule(); 
            window.openAllScheduleModal();
        }
    }

    window.deleteLog = function(ts) {
        if(confirm('åˆªé™¤ï¼Ÿ')) {
            window.logs = window.logs.filter(l => l.ts !== ts);
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            window.renderSchedule(); window.updateAssetDisplay();
        }
    }
    
    window.shareToLine = async function(ts) {
        const log = window.logs.find(l => l.ts === ts); if(!log) return;
        let text = `ã€ä¸Šèª²ç´€éŒ„ã€‘\nğŸ“… æ—¥æœŸï¼š${log.date}\nğŸ§‘â€ğŸ“ å­¸ç”Ÿï¼š${log.name}\nğŸ“š ç§‘ç›®ï¼š${log.subject || 'æœªå¡«'}\nğŸ“ å…§å®¹ï¼š${log.content || 'ç„¡'}`;
        if(log.images && log.images.length > 0) text += `\n(å·²é™„ä¸Šä¸Šèª²ç…§ç‰‡)`;
        else if(log.image) text += `\n(å·²é™„ä¸Šä¸Šèª²ç…§ç‰‡)`;
        
        navigator.clipboard.writeText(text).then(() => {
            if ((log.images && log.images.length > 0) || log.image) {
                const imagesToShare = log.images || [log.image];
                const filesPromise = imagesToShare.map(img => fetch(img).then(res => res.blob()));
                
                Promise.all(filesPromise).then(blobs => {
                    const files = blobs.map((blob, i) => new File([blob], `photo_${i}.png`, { type: "image/png" }));
                    if (navigator.canShare && navigator.canShare({ files: files })) {
                        navigator.share({
                            files: files,
                            text: text
                        }).catch(e => {
                            window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
                        });
                    } else {
                        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
                    }
                });
            } else {
                window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
            }
        });
    }

    window.startClass = function(ts) {
        const log = window.logs.find(l => l.ts === ts);
        if(log) { 
            log.status = 'running'; 
            log.startTime = Date.now(); 
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); 
            window.renderSchedule(); 
        }
    }
    
    window.updateRunningTimers = function() {
        window.logs.filter(l => l.status === 'running').forEach(l => {
            const el = document.getElementById(`timer-${l.ts}`);
            if (el) {
                const diff = Date.now() - l.startTime;
                const hrs = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                const pad = n => n.toString().padStart(2, '0');
                el.innerText = `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
            }
        });
    }
    
    window.openSettlementModal = function(ts) {
        window.settlingLogTs = ts;
        const log = window.logs.find(l => l.ts === ts);
        if(!log) return;
        const el = document.getElementById(`timer-${log.ts}`);
        window.settlingTimerMs = el ? el.innerText : "00:00:00";
        document.getElementById('settlement-timer-display').innerText = window.settlingTimerMs;
        document.getElementById('settlement-planned-hours').innerText = (log.hours || 0) + ' å°æ™‚';
        document.getElementById('settlement-manual-hours').value = ''; 
        
        const buttons = document.getElementById('settlement-hours-group').getElementsByClassName('select-btn');
        for (let b of buttons) { b.style.backgroundColor = "#FAFAFA"; b.style.color = "#AAA"; }

        document.getElementById('settlement-modal').style.display = 'flex';
    }
    
    window.setSettlementInput = function(val, btn) { forceSelectButton(val, btn, 'settlement-manual-hours'); }
    window.setLogHours = function(v, btn) { forceSelectButton(v, btn, 'log-hours'); }
    
    window.confirmSettlement = function() {
        let finalHours = parseFloat(document.getElementById('settlement-manual-hours').value);
        if (!finalHours || finalHours <= 0) { alert('è«‹è¼¸å…¥æ™‚æ•¸'); return; }
        
        const log = window.logs.find(l => l.ts === window.settlingLogTs);
        if (log) {
            log.status = 'done'; 
            log.endTime = Date.now(); 
            log.hours = finalHours; 
            log.actualDuration = window.settlingTimerMs;
            log.income = Math.round(parseFloat(log.hours) * parseFloat(log.rate));
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            window.closeModal('settlement-modal'); 
            window.renderSchedule(); 
            window.updateAssetDisplay();
        }
    }
    
    window.quickSettle = function(ts) {
        const log = window.logs.find(l => l.ts === ts);
        if(log && confirm(`ç¢ºèªçµç®— ${log.date} ${log.name} çš„èª²ç¨‹ï¼Ÿ`)) {
            log.status = 'done';
            log.income = Math.round(log.hours * log.rate);
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            window.updateAssetDisplay();
            window.openAllScheduleModal(); 
        }
    }
    
    window.updateContent = function(ts, val) { 
        const log = window.logs.find(l => l.ts === ts); 
        if (log) { log.content = val; localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); } 
    }
    
    window.triggerLogImageUpload = function(ts) { document.getElementById(`file-${ts}`).click(); }
    
    window.handleLogImageUpload = function(event, ts) {
        const input = event.target;
        if (input.files && input.files.length > 0) {
            const log = window.logs.find(l => l.ts === ts);
            if(log) {
                if(!log.images) log.images = [];
                const files = Array.from(input.files);
                
                Promise.all(files.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            log.images.push(e.target.result);
                            resolve();
                        };
                        reader.readAsDataURL(file);
                    });
                })).then(() => {
                    localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
                    window.renderSchedule(); 
                });
            }
        }
    }

    // --- Bank Logic ---
    window.openBankInput = function(type, accId) {
        window.currentBankAction = type;
        window.currentAccountId = accId;
        const accName = accId === 'taiwan_bank' ? 'å°ç£éŠ€è¡Œ' : 'æ°¸è±è­‰åˆ¸';
        document.getElementById('bank-input-title').innerText = type === 'deposit' ? 'å­˜å…¥' : 'æé ˜';
        document.getElementById('bank-target-name').innerText = accName;
        document.getElementById('bank-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('bank-amount').value = '';
        document.getElementById('bank-note').value = '';
        document.getElementById('bank-input-modal').style.display = 'flex';
    }

    window.submitBankTransaction = function() {
        const amt = parseInt(document.getElementById('bank-amount').value);
        const note = document.getElementById('bank-note').value;
        const date = document.getElementById('bank-date').value;
        if(!amt) return alert('è«‹è¼¸å…¥é‡‘é¡');
        
        window.bankLogs.unshift({
            ts: Date.now(),
            accountId: window.currentAccountId,
            type: window.currentBankAction,
            amount: amt,
            date: date,
            note: note
        });
        localStorage.setItem(DB_BANK, JSON.stringify(window.bankLogs));
        window.closeModal('bank-input-modal');
        window.updateAssetDisplay();
    }

    window.openBankHistory = function(accId) {
        const list = document.getElementById('bank-history-list');
        list.innerHTML = '';
        const accName = accId === 'taiwan_bank' ? 'å°ç£éŠ€è¡Œ' : 'æ°¸è±è­‰åˆ¸';
        document.getElementById('history-bank-name').innerText = accName;
        
        let total = accId === 'taiwan_bank' ? 100000 : 13107;
        const myLogs = window.bankLogs.filter(b => b.accountId === accId);
        myLogs.forEach(b => {
             if(b.type === 'deposit') total += parseInt(b.amount);
             else total -= parseInt(b.amount);
        });
        document.getElementById('modal-bank-balance').innerText = '$' + total.toLocaleString();

        list.innerHTML += `<div class="portfolio-item"><div>åˆå§‹æœ¬é‡‘</div><div class="portfolio-right-col">$${(accId==='taiwan_bank'?100000:13107).toLocaleString()}</div></div>`;
        
        myLogs.sort((a, b) => new Date(b.date) - new Date(a.date));

        myLogs.forEach(b => {
            const isDep = b.type === 'deposit';
            list.innerHTML += `
                <div class="portfolio-item">
                    <div>
                        <div style="font-weight:800; color:#544E4E;">${formatDateShort(b.date)}</div>
                        <div style="font-size:12px; color:#AAA;">${b.note || (isDep?'å­˜å…¥':'æé ˜')}</div>
                    </div>
                    <div class="portfolio-right-col" style="color:${isDep?'var(--money-green)':'#C62828'};">
                        ${isDep?'+':'-'}$${parseInt(b.amount).toLocaleString()}
                    </div>
                </div>
            `;
        });
        document.getElementById('bank-history-modal').style.display = 'flex';
    }

    window.changeMonth = function(offset) {
        window.viewDate.setMonth(window.viewDate.getMonth() + offset);
        window.updateAssetDisplay();
    }

    window.formatDateShort = function(d) {
        const date = new Date(d);
        const days = ['(æ—¥)', '(ä¸€)', '(äºŒ)', '(ä¸‰)', '(å››)', '(äº”)', '(å…­)'];
        return `${date.getMonth()+1}/${date.getDate()} ${days[date.getDay()]}`;
    }

    window.updateAssetDisplay = function() {
        let tw = 100000, sp = 13107;
        window.bankLogs.forEach(b => {
            const amt = parseInt(b.amount);
            if(b.accountId === 'taiwan_bank') tw += (b.type==='deposit'?amt:-amt);
            else sp += (b.type==='deposit'?amt:-amt);
        });
        
        const y = window.viewDate.getFullYear(); 
        const m = window.viewDate.getMonth() + 1;
        const viewMonthStr = `${y}-${m.toString().padStart(2, '0')}`;
        document.getElementById('stats-month-display').innerText = `${y}å¹´ ${m}æœˆ`;
        
        let monthIncome = 0; 
        let yearIncome = 0;
        let totalIncome = 0;
        let estimatedIncome = 0;
        
        const allDiv = document.getElementById('all-logs'); 
        if(allDiv) allDiv.innerHTML = ''; 

        window.logs.forEach(l => { 
            if(l.status==='done') {
                totalIncome += (l.income || 0);
                if (l.date.startsWith(viewMonthStr)) {
                    monthIncome += (l.income || 0);
                    if(allDiv) {
                        allDiv.innerHTML += `
                        <div class="portfolio-item">
                            <div class="portfolio-item-left">
                                <div class="portfolio-title">${formatDateShort(l.date)} <span class="student-link" onclick="openStudentMonthStats('${l.name}')">${l.name}</span></div>
                                <div class="portfolio-sub">${l.subject || 'æœªå¡«'} ${l.hours}H</div>
                            </div>
                            <div class="portfolio-right-col" style="color:var(--money-green);">+$${l.income}</div>
                        </div>`;
                    }
                }
                if (l.date.startsWith(`${y}-`)) yearIncome += (l.income || 0);
            }
            
            if (l.date.startsWith(viewMonthStr)) {
                 const potential = (l.status === 'done') ? (l.income || 0) : (l.hours * l.rate);
                 estimatedIncome += Math.round(potential);
            }
        });
        
        document.getElementById('total-assets-val').innerText = '$' + (tw + sp).toLocaleString(); 
        document.getElementById('taiwan-bank-balance').innerText = '$' + tw.toLocaleString();
        document.getElementById('sinopac-balance').innerText = '$' + sp.toLocaleString();
        document.getElementById('month-total').innerText = '$' + monthIncome.toLocaleString();
        // V165 Fix: Remove prefix text, only numbers
        document.getElementById('month-estimate-val').innerText = '$' + estimatedIncome.toLocaleString();
        
        document.getElementById('year-label').innerText = y;
        document.getElementById('year-total').innerText = '$' + yearIncome.toLocaleString();
    }

    window.openStudentMonthStats = function(name) {
        const y = window.viewDate.getFullYear(); 
        const m = (window.viewDate.getMonth() + 1).toString().padStart(2, '0');
        const viewMonthStr = `${y}-${m}`;
        
        let total = 0;
        const listDiv = document.getElementById('student-history-list');
        listDiv.innerHTML = '';
        
        window.logs.forEach(l => {
            if (l.name === name && l.status === 'done' && l.date.startsWith(viewMonthStr)) {
                total += l.income;
                listDiv.innerHTML += `
                    <div class="portfolio-item">
                        <div><div style="font-weight:800; color:#544E4E;">${formatDateShort(l.date)}</div></div>
                        <div class="portfolio-right-col" style="color:var(--money-green);">+$${l.income}</div>
                    </div>`;
            }
        });
        
        document.getElementById('student-history-name').innerText = `${name}`;
        document.getElementById('student-history-total').innerText = '$' + total.toLocaleString();
        document.getElementById('student-history-modal').style.display = 'flex';
    }

    window.openAllScheduleModal = function() {
        const modal = document.getElementById('all-schedule-modal');
        const list = document.getElementById('all-schedule-list');
        list.innerHTML = '';
        window.logs.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        window.logs.forEach(l => {
            let rightContent = '';
            
            if (l.status === 'done') {
                rightContent = `<span style="font-weight:900; color:var(--money-green);">$${l.income}</span>`;
            } else {
                rightContent = `
                    <button class="icon-btn" style="background:#F0F4F8;" onclick="openEditModal(${l.ts})">âœï¸</button>
                    ${(new Date(l.date) < new Date()) ? `<button class="icon-btn" style="background:#E8F5E9;" onclick="quickSettle(${l.ts})">ğŸ’°</button>` : ''}
                `;
            }

            list.innerHTML += `
                <div class="portfolio-item">
                    <div class="portfolio-item-left">
                        <div class="portfolio-title">${formatDateShort(l.date)} ${l.name}</div>
                        <div class="portfolio-sub">${l.subject || 'æœªå¡«'} ${l.hours}H</div>
                    </div>
                    <div class="portfolio-right-col">
                        ${rightContent}
                        <button class="icon-btn" style="background:#FFEBEE;" onclick="deleteLogFromHistory(${l.ts})">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
        });
        modal.style.display = 'flex';
    }

    window.openProfileModal = function() { 
        closeSidebar();
        document.getElementById('profile-avatar').innerText = profileData.avatar || 'ğŸ§¸';
        renderMoodList();
        document.getElementById('profile-modal').style.display = 'flex';
    }
    
    // V165 Fix: Hide Bear Logic
    window.updateProfileDisplay = function() { 
        const el = document.getElementById('profile-avatar'); 
        const sb = document.getElementById('sidebar-avatar');
        if (!el || !sb) return;
        
        if(profileData.avatarImg) { 
            el.style.backgroundImage=`url(${profileData.avatarImg})`; 
            sb.style.backgroundImage=`url(${profileData.avatarImg})`; 
            el.innerText=''; sb.innerText=''; 
            el.style.color='transparent'; sb.style.color='transparent';
            el.style.backgroundColor='transparent'; sb.style.backgroundColor='transparent';
        }
        else { 
            const a=profileData.avatar||'ğŸ§¸'; 
            el.style.backgroundImage='none'; sb.style.backgroundImage='none'; 
            el.innerText=a; sb.innerText=a; 
            el.style.color=''; sb.style.color='';
            el.style.backgroundColor='#FFF0F3'; sb.style.backgroundColor='#FFF0F3';
        }
    }
    
    function saveMood() { 
        const t = document.getElementById('mood-input').value; 
        if(t) { 
            const d = new Date().toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}); 
            profileData.moods.unshift({date:d, text:t}); 
            localStorage.setItem(DB_PROFILE, JSON.stringify(profileData)); 
            document.getElementById('mood-input').value=''; 
            renderMoodList(); 
        } 
    }
    
    function renderMoodList() { 
        const l = document.getElementById('mood-list'); 
        l.innerHTML=''; 
        (profileData.moods||[]).forEach(m => l.innerHTML += `<div class="diary-entry"><div class="diary-date">${m.date}</div><div class="diary-text">${m.text}</div></div>`); 
    }
    
    function triggerUpload() { document.getElementById('avatar-upload').click(); }
    
    function handleAvatarUpload(input) { 
        if (input.files && input.files[0]) { 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                profileData.avatarImg = e.target.result; 
                localStorage.setItem(DB_PROFILE, JSON.stringify(profileData)); 
                updateProfileDisplay(); 
            }; 
            reader.readAsDataURL(input.files[0]); 
        } 
    }

    setInterval(window.updateRunningTimers, 1000);

    window.onload = function() {
        window.renderStudents(); window.renderSchedule(); window.updateAssetDisplay(); window.updateProfileDisplay();
    }
</script>
</body>
</html>