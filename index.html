<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#F7F6F2">
<meta name="format-detection" content="telephone=no">

<title>ÂÆ∂ÊïôÂ∞èÊú¨Êú¨ V287 (Liquid Glass)</title>

<link rel="apple-touch-icon" href="icon.png">
<link rel="shortcut icon" href="icon.png">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    /* --- V287 STYLE: Liquid Glass (iOS/VisionOS Aesthetic) --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root {
        --bg-color: #F7F6F2; 
        --card-bg: #FFFFFF;
        --text-main: #2D3748; 
        --text-sub: #718096;
        --accent-primary: #E07A5F; 
        --money-green: #059669; 
        --money-red: #E53E3E;
        --edit-blue: #4299E1;
        --shadow-card: 0 4px 20px -2px rgba(0, 0, 0, 0.05); 
        
        --input-bg: #F7FAFC;
        --input-border: #E2E8F0;
        --std-height: 52px; 
        --radius-std: 16px;

        /* Theme Colors */
        --theme-black: #2B2E35;
        --theme-green: #D4E09B;
        --theme-purple: #A4A4D6;
    }

    html, body { 
        background-color: var(--bg-color); margin: 0; padding: 0; 
        font-family: "Urbanist", "Noto Sans TC", sans-serif; 
        padding-bottom: 40px; overflow-x: hidden; width: 100vw; 
        color: var(--text-main); min-height: 100vh;
        overscroll-behavior-y: none;
        -webkit-font-smoothing: antialiased;
    }
    
    /* V287: Adjusted padding for floating header */
    body { padding-top: 140px !important; }

    #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none !important; z-index: 9999; }
    
    .btn-bubble { transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .btn-bubble:active { transform: scale(0.94); }

    /* HEADER: LIQUID GLASS EFFECT */
    header {
        /* The Liquid Glass Formula */
        background: rgba(255, 255, 255, 0.55); /* High transparency */
        backdrop-filter: saturate(200%) blur(30px); /* Vibrant Blur */
        -webkit-backdrop-filter: saturate(200%) blur(30px);
        
        /* 3D Thickness & Shine (Bead Effect) */
        box-shadow: 
            0 15px 35px -5px rgba(0,0,0,0.1), /* Soft shadow */
            inset 0 1px 2px rgba(255,255,255,0.9), /* Top Rim Highlight */
            inset 0 -2px 5px rgba(0,0,0,0.05); /* Bottom Rim Depth */
        
        border: 1px solid rgba(255,255,255,0.4); /* Subtle glass edge */
        
        /* Shape */
        height: 120px !important; /* Slightly shorter */
        border-bottom-left-radius: 40px;
        border-bottom-right-radius: 40px;
        
        padding-top: max(10px, env(safe-area-inset-top)); 
        padding-bottom: 10px; 
        padding-left: 24px; padding-right: 24px;
        position: fixed; top: 0; left: 0; width: 100%; z-index: 5000;
        display: grid; grid-template-columns: 44px 1fr 44px; align-items: center;
    }
    
    .header-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #header-title { font-size: 18px; font-weight: 800; letter-spacing: 1px; color: var(--text-main); text-transform: uppercase; margin-bottom: 6px; text-shadow: 0 1px 2px rgba(255,255,255,0.5); }
    
    .page-indicator { display: flex; gap: 6px; background: rgba(0,0,0,0.06); padding: 4px 8px; border-radius: 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.06); }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(0,0,0,0.2); transition: 0.3s; }
    .dot.active { background: var(--accent-primary); width: 20px; border-radius: 10px; }
    
    /* Glassy Menu Button */
    .menu-btn { 
        font-size: 24px; color: var(--text-main); cursor: pointer; 
        display: flex; justify-content: center; align-items: center; 
        height: 44px; width: 44px; border-radius: 50%; 
        background: rgba(255,255,255,0.3); 
        box-shadow: 0 4px 10px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.8);
        transition: 0.2s; border: 1px solid rgba(255,255,255,0.4);
    }
    .menu-btn:active { background: rgba(255,255,255,0.6); }

    /* SIDEBAR: LIQUID FLOATING GLASS */
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 55, 72, 0.25); z-index: 9998; display: none; backdrop-filter: blur(8px); }
    .sidebar { 
        position: fixed; top: 2%; bottom: 2%; right: -360px; width: 290px; 
        z-index: 9999; transition: right 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        padding: 60px 30px; display: flex; flex-direction: column;
        padding-top: max(60px, env(safe-area-inset-top));
        
        /* Liquid Glass Texture */
        background: rgba(255, 255, 255, 0.65); /* High transparency */
        backdrop-filter: saturate(200%) blur(40px); 
        -webkit-backdrop-filter: saturate(200%) blur(40px);
        border-radius: 44px; /* Big round corners */
        
        /* 3D Glass Edges */
        border: 1px solid rgba(255,255,255,0.5);
        box-shadow: 
            -20px 20px 60px rgba(0,0,0,0.2), /* Deep float shadow */
            inset 1px 1px 2px rgba(255,255,255,0.9), /* Top-Left Highlight */
            inset -1px -1px 2px rgba(200,200,200,0.2); /* Bottom-Right Depth */
    }
    .sidebar.active { right: 10px; }
    
    .sidebar-avatar { 
        width: 88px; height: 88px; border-radius: 50%; 
        background: rgba(255,255,255,0.5); 
        margin: 0 auto 20px auto; display: flex; justify-content: center; align-items: center; 
        font-size: 42px; cursor: pointer; 
        border: 2px solid rgba(255,255,255,0.8); 
        box-shadow: 0 10px 30px rgba(0,0,0,0.1), inset 0 2px 5px rgba(255,255,255,0.8);
        background-size: cover; background-position: center; 
    }
    .sidebar-name { text-align: center; font-size: 20px; font-weight: 800; margin-bottom: 40px; color: var(--text-main); text-shadow: 0 1px 1px rgba(255,255,255,0.8); }
    .sidebar-item { 
        padding: 18px; border-radius: 22px; margin-bottom: 12px; font-size: 16px; font-weight: 700; color: var(--text-main); 
        background: rgba(255, 255, 255, 0.4); 
        display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; 
        border: 1px solid rgba(255,255,255,0.4);
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .sidebar-item:active { background: rgba(255, 255, 255, 0.7); transform: scale(0.96); }

    /* LAYOUT */
    #main-viewport { width: 100vw; overflow: hidden; position: relative; z-index: 1; }
    #page-slider { display: flex; width: 200vw; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); transform: translateX(0); }
    .page { width: 100vw; flex-shrink: 0; padding: 10px 24px 100px 24px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 4px; }
    #today-title-display, .section-title { font-size: 13px; font-weight: 800; color: var(--text-sub); letter-spacing: 1.5px; text-transform: uppercase; }
    .header-action-btn { height: 40px; padding: 0 20px; border-radius: 20px; font-size: 13px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.08); border: none; transition: transform 0.1s; }
    .btn-style-main { background: var(--text-main); color: #FFF; border: 2px solid var(--text-main); }
    .card { background: var(--card-bg); border-radius: 28px; padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-card); border: 1px solid rgba(0,0,0,0.02); }

    .asset-card {
        background: linear-gradient(135deg, #2D3748 0%, #E07A5F 100%);
        border-radius: 32px; padding: 32px 28px; margin-bottom: 30px;
        color: #FFF; position: relative; overflow: hidden; box-shadow: var(--shadow-float); z-index: 1;
    }
    .asset-label { font-size: 14px; font-weight: 700; opacity: 0.8; margin-bottom: 8px; letter-spacing: 1px; }
    .asset-amount { font-size: 48px; font-weight: 800; color: #FFF; line-height: 1; letter-spacing: 0.5px; font-variant-numeric: tabular-nums; }

    .account-item { display: flex; justify-content: space-between; padding: 20px 0; border-bottom: 1px solid #EDF2F7; align-items: center; }
    .acc-name { font-size: 16px; font-weight: 800; color: var(--text-main); white-space: nowrap; margin-right: 15px; }
    .acc-right { display: flex; flex-direction: column; align-items: flex-end; width: 100%; }
    .acc-val { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 8px; }
    .btn-group { display: flex; gap: 8px; width: 100%; justify-content: flex-end; }
    .btn-bank { padding: 8px 16px; background: #F7FAFC; border-radius: 12px; font-size: 13px; font-weight: 700; border: none; cursor: pointer; color: var(--text-main); white-space: nowrap; }

    .est-income-val { font-family: 'Urbanist', sans-serif !important; font-size: 16px; font-weight: 700; color: #CBD5E0; margin-bottom: 0px; text-align: center; }
    #month-total { font-family: 'Urbanist', sans-serif !important; font-size:36px; font-weight:900; color:var(--text-main); }

    /* SCHEDULE PAGE */
    .student-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 5px 5px 20px 5px; scrollbar-width: none; }
    .student-wrapper { display: flex; flex-direction: column; align-items: center; width: 72px; flex-shrink: 0; position: relative; -webkit-user-select:none; user-select:none; }
    .student-chip { width: 72px; height: 72px; border-radius: 50%; background: #FFF; display: flex; justify-content: center; align-items: center; box-shadow: 0 8px 25px rgba(0,0,0,0.06); font-size: 24px; margin-bottom: 10px; border: 4px solid #FFF; transition: 0.2s; color: #FFF; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .student-wrapper:active .student-chip { transform: scale(0.95); }
    .chip-name { font-size: 13px; font-weight: 700; color: var(--text-main); text-align: center; width: 100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .delete-x { position: absolute; top: 0; right: 0; width: 24px; height: 24px; background: var(--money-red); color: #FFF; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 14px; border: 3px solid #FFF; z-index: 10; font-weight: 900; }
    .is-editing .delete-x { display: flex; }
    .is-editing .student-chip { animation: shake 0.3s infinite; }

    /* SOLID 3D CARDS */
    #today-schedule-list { display: flex; gap: 20px; overflow-x: auto; padding: 20px 24px 40px 24px; scroll-snap-type: x mandatory; scrollbar-width: none; margin-left: -24px; margin-right: -24px; }
    #today-schedule-list::-webkit-scrollbar { display: none; }

    .schedule-card { 
        flex: 0 0 82%; max-width: 320px; height: 420px; 
        scroll-snap-align: center; border-radius: 36px; padding: 28px 24px;
        position: relative; display: flex; flex-direction: column; justify-content: space-between;
        transition: transform 0.2s; 
        box-shadow: 0 15px 35px -5px rgba(0,0,0,0.15); border: none;
    }
    .schedule-card:active { transform: scale(0.98); }

    .card-theme-1 { background-color: var(--theme-black); color: #FFFFFF; }
    .card-theme-2 { background-color: var(--theme-green); color: var(--text-main); }
    .card-theme-3 { background-color: var(--theme-purple); color: #FFFFFF; }
    
    .schedule-card.paid { 
        background: #EDF2F7; /* Light Gray */
        color: #A0AEC0; /* Dimmed Text */
        border: none; box-shadow: none; 
    }
    .schedule-card.paid .sch-title { color: #718096; }
    .schedule-card.paid .sch-badge { background: #E2E8F0; color: #A0AEC0; }
    .schedule-card.paid .inline-note { background: #E2E8F0; color: #718096; }

    .sch-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .sch-title { font-size: 28px; font-weight: 800; line-height: 1.1; margin-bottom: 6px; }
    .sch-time-info { font-size: 15px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; opacity: 0.7; }
    .sch-badge { font-size: 13px; padding: 6px 14px; border-radius: 20px; font-weight: 800; display: inline-block; }

    .card-theme-1 .sch-badge { background: rgba(255,255,255,0.2); color: #FFF; }
    .card-theme-2 .sch-badge { background: #FFF; color: var(--text-main); }
    .card-theme-3 .sch-badge { background: rgba(255,255,255,0.25); color: #FFF; }

    .cal-top-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
    .card-theme-1 .cal-top-btn { background: #3A3D45; color: #FFF; }
    .card-theme-2 .cal-top-btn { background: #FFF; color: var(--text-main); }
    .card-theme-3 .cal-top-btn { background: rgba(255,255,255,0.25); color: #FFF; }

    .note-wrapper { position: relative; flex: 1; margin: 15px 0; }
    .inline-note { width: 100%; height: 100%; padding: 20px; border: none; border-radius: 28px; font-size: 16px; font-weight: 500; outline: none; resize: none; box-sizing: border-box; }
    .card-theme-1 .inline-note { background: #3A3D45; color: #FFF; }
    .card-theme-2 .inline-note { background: #FFF; color: var(--text-main); }
    .card-theme-3 .inline-note { background: rgba(255,255,255,0.2); color: #FFF; }
    .schedule-card.paid .inline-note { background: #F7FAFC; color: var(--text-main); }

    .sch-cost-overlay { position: absolute; bottom: 16px; right: 20px; font-size: 13px; font-weight: 800; pointer-events: none; opacity: 0.6; }

    .card-footer { display: flex; gap: 12px; align-items: center; height: 60px; }
    .btn-trash-card { width: 60px; height: 60px; border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: none; cursor: pointer; }
    .card-theme-1 .btn-trash-card { background: #3A3D45; color: #FF6B6B; }
    .card-theme-2 .btn-trash-card { background: #FFF; color: #FF6B6B; }
    .card-theme-3 .btn-trash-card { background: rgba(255,255,255,0.2); color: #FFD1D1; }
    
    .btn-main-action { flex: 1; height: 60px; border-radius: 24px; font-size: 16px; font-weight: 800; border: none; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
    .btn-main-action:active { transform: scale(0.95); }
    .card-theme-1 .btn-main-action { background: #FFFFFF; color: #2B2E35; }
    .card-theme-2 .btn-main-action { background: #2B2E35; color: #FFFFFF; }
    .card-theme-3 .btn-main-action { background: #FFFFFF; color: #5E5B9E; }
    
    .timer-display { font-size: 36px; font-weight: 800; text-align: center; font-feature-settings: "tnum"; margin-top: auto; margin-bottom: auto;}

    /* MODALS */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
    .modal-content { background: #FFF; width: 90%; max-width: 380px; border-radius: 32px; padding: 28px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; transition: 0.1s; }
    .modal-content.shake-error { animation: shake 0.3s; border: 2px solid var(--money-red); }
    .modal-title { font-size: 18px; font-weight: 800; color: var(--text-sub); text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }

    #edit-log-modal { z-index: 9100 !important; }

    /* UNIFIED FORM ELEMENTS */
    .setup-group { margin-bottom: 16px; }
    .setup-label { font-size: 13px; font-weight: 800; color: var(--text-main); margin-bottom: 8px; margin-left: 2px; }
    
    input, select, .opt-btn, .modal-btn, .add-date-btn { height: var(--std-height); box-sizing: border-box; border-radius: var(--radius-std); }
    input, select, textarea { width: 100%; padding: 0 16px; border: 2px solid var(--input-border); font-size: 16px; font-weight: 700; outline: none; background: var(--input-bg); color: var(--text-main); -webkit-appearance: none; margin-bottom: 0; display: flex; align-items: center; }
    textarea { padding: 14px; line-height: 1.4; height: auto; min-height: 80px; }
    input:focus, textarea:focus { border-color: var(--text-main); background: #FFF; }

    #bank-amount { border: none; background: transparent; font-size: 48px; text-align: center; height: auto; border-radius: 0; padding: 20px 0; font-family: 'Urbanist', sans-serif; }
    #bank-amount::placeholder { color: #E2E8F0; }

    .btn-options { display: flex; gap: 6px; flex-wrap: nowrap; overflow-x: auto; scrollbar-width: none; align-items: center; width: 100%; }
    .opt-btn { padding: 0 16px; background: #EDF2F7; font-size: 13px; font-weight: 700; color: var(--text-sub); cursor: pointer; border: 2px solid transparent; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .opt-btn.selected { background: var(--text-main); color: #FFF; border-color: var(--text-main); }

    .vertical-stack { display: flex; flex-direction: column; gap: 8px; width: 100%; }
    .date-row { display: flex; gap: 8px; width: 100%; }
    .date-input-wrapper { flex: 1; }
    .add-date-btn { width: var(--std-height); background: var(--text-main); color: #FFF; font-size: 24px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }

    .color-picker { display: flex; gap: 12px; justify-content: center; margin-bottom: 24px; padding: 10px 0; }
    .color-opt { width: 42px; height: 42px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.15s; position: relative; }
    .color-opt.selected { transform: scale(1.15); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .color-opt.selected::after { content:'‚úì'; color:#FFF; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:16px; font-weight:800; }

    .modal-btn { width: 100%; border: none; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; }
    .btn-confirm { background: var(--text-main); color: #FFF; }
    .btn-cancel { background: transparent; color: var(--text-sub); }

    .tag-container { display: flex; flex-wrap: wrap; gap: 6px; min-height: 0; margin-bottom: 10px; }
    .date-tag-item { background: var(--text-main); color: #FFF; border-radius: 12px; padding: 6px 12px; font-size: 13px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }

    /* HISTORY LIST */
    .swipe-container { position: relative; overflow: hidden; width: 100%; border-bottom: 1px solid #F0F0F0; touch-action: pan-y; height: 72px; background: #FFF; }
    .swipe-bg-delete { position: absolute; top: 0; right: 0; bottom: 0; width: 90px; background: var(--money-red); color: #FFF; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; z-index: 1; cursor: pointer; }
    .swipe-content { position: relative; background: #FFF; z-index: 2; width: 100%; height: 100%; display: flex; align-items: center; padding: 0 5px; transition: transform 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28); will-change: transform; }

    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 5px; border-bottom: 1px solid #F0F0F0; }
    .list-date { width: 70px; font-weight: 700; color: #718096; font-size: 13px; white-space: nowrap; flex-shrink: 0; text-align: center;}
    .list-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; justify-content:center; margin-right: 5px; margin-left: 5px; min-width: 0; }
    .history-name-link { font-size: 16px; font-weight: 800; color: var(--text-main) !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; text-align: left; }
    .list-right { display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; gap: 6px; flex-shrink: 0; }
    .list-income { font-weight: 700; white-space: nowrap; font-size: 15px; text-align: right; margin-right: 4px; }
    
    .btn-mini-icon { width: 28px; height: 28px; border-radius: 8px; background: #F0F4F8; color: #718096; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; flex-shrink: 0; }
    .btn-mini-icon:active { background: #CBD5E0; }
    .btn-mini-edit { background: #EBF8FF; color: #4299E1; }
    .btn-mini-edit:active { background: #BEE3F8; }

    .btn-mini-pay { padding: 6px 12px; background: var(--money-green); color: #FFF; border: none; border-radius: 10px; font-size: 12px; font-weight: 800; cursor: pointer; box-shadow: 0 2px 8px rgba(56, 161, 105, 0.4); white-space: nowrap; flex-shrink: 0; display: inline-block; }
    .month-group-header { padding: 16px 16px; background: #EDF2F7; border-radius: 16px; margin-bottom: 10px; margin-top: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: var(--text-main); font-size: 15px; }
</style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-avatar" id="sidebar-avatar" onclick="openProfileModal()">üß∏</div>
        <div class="sidebar-name" id="sidebar-name">Tutor</div>
    </div>
    <div class="sidebar-item" onclick="openProfileModal()">üìí ÂøÉÊÉÖÊó•Ë®ò</div>
    <div class="sidebar-item" onclick="switchTab(0)">üóìÔ∏è ÊéíË™≤Á≥ªÁµ±</div>
    <div class="sidebar-item" onclick="switchTab(1)">üìä Ë≥áÁî¢Â†±Ë°®</div>
    <div class="sidebar-item" onclick="exportData()">üì§ ÂÇô‰ªΩË≥áÊñô</div>
    <div class="sidebar-item" onclick="triggerImport()">üì• ÈÇÑÂéüË≥áÊñô</div>
    <div class="sidebar-item" style="color:red; margin-top:auto;" onclick="hardReset()">‚ö†Ô∏è ÈáçÁΩÆÊâÄÊúâË≥áÊñô</div>
    <input type="file" id="import-file" style="display:none" onchange="importData(this)">
</div>

<header>
    <div class="menu-btn" style="opacity:0; pointer-events:none;">‚ò∞</div> 
    <div class="header-center">
        <div id="header-title">ÊéíË™≤Á≥ªÁµ±</div>
        <div class="page-indicator">
            <div class="dot active"></div>
            <div class="dot"></div>
        </div>
    </div>
    <div class="menu-btn" onclick="toggleSidebar()">‚ò∞</div>
</header>

<div id="main-viewport">
    <div id="page-slider">
        <!-- PAGE 1: SCHEDULE -->
        <div id="page-schedule" class="page">
            <div class="section-header">
                <div class="section-title">Students</div>
                <button class="header-action-btn btn-style-main btn-bubble" onclick="openSetupModal()">+ NEW</button>
            </div>
            
            <div class="card" style="padding: 20px 0;">
                <div class="student-scroll" id="student-scroll" style="padding: 0 20px;"></div>
            </div>
            
            <div class="section-header" style="margin-top: 30px;">
                <div id="today-title-display">TODAY</div>
                <button class="header-action-btn btn-style-main btn-bubble" onclick="openAllScheduleModal()">Ê≠∑Âè≤Á¥ÄÈåÑ</button>
            </div>
            
            <div id="today-schedule-list"></div>
            <div id="empty-schedule-hint" style="text-align:center; padding: 60px 20px; color:#AAA; font-weight:700;">No classes today üåø</div>
        </div>

        <!-- PAGE 2: ASSETS -->
        <div id="page-assets" class="page">
            <div class="asset-card">
                <div class="asset-label">NET ASSETS</div>
                <div class="asset-amount" id="total-assets-val">$0</div>
            </div>
            
            <div class="card">
                <div class="section-header" style="margin-top:0;">
                    <div class="section-title">Accounts</div>
                </div>
                <div class="account-item">
                    <div class="acc-name">üè¶ Âè∞ÁÅ£ÈäÄË°å</div>
                    <div class="acc-right">
                        <div id="taiwan-bank-balance" class="acc-val">$0</div>
                        <div class="btn-group">
                            <button class="btn-bank btn-bubble" onclick="openBankInput('deposit', 'taiwan_bank')">Â≠ò</button>
                            <button class="btn-bank btn-bubble" onclick="openBankInput('withdraw', 'taiwan_bank')">Êèê</button>
                            <button class="btn-bank btn-bubble" onclick="openBankHistory('taiwan_bank')">ÊòéÁ¥∞</button>
                        </div>
                    </div>
                </div>
                <div class="account-item" style="border-bottom:none;">
                    <div class="acc-name">üìâ Ê∞∏Ë±êË≠âÂà∏</div>
                    <div class="acc-right">
                        <div id="sinopac-balance" class="acc-val">$0</div>
                        <div class="btn-group">
                            <button class="btn-bank btn-bubble" onclick="openBankInput('deposit', 'sinopac')">Â≠ò</button>
                            <button class="btn-bank btn-bubble" onclick="openBankInput('withdraw', 'sinopac')">Êèê</button>
                            <button class="btn-bank btn-bubble" onclick="openBankHistory('sinopac')">ÊòéÁ¥∞</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div style="text-align:center; padding-top:10px;">
                    <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:5px;">
                        <button onclick="changeMonth(-1)" style="border:none; background:none; font-size:24px; color:#999; cursor:pointer;">‚ùÆ</button>
                        <div id="stats-month-display" style="font-weight:800; font-size:16px;">--</div>
                        <button onclick="changeMonth(1)" style="border:none; background:none; font-size:24px; color:#999; cursor:pointer;">‚ùØ</button>
                    </div>
                    
                    <div class="est-income-val">$<span id="month-est">0</span></div>
                    <div style="font-size:36px; font-weight:900; color:var(--text-main);" id="month-total">$0</div>
                </div>
                <div id="all-logs" style="margin-top:20px; border-top:1px dashed #EEE; padding-top:10px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">Êñ∞Â¢ûÂ≠∏Áîü</h3>
        
        <div class="color-picker" id="new-color-picker">
            <div class="color-opt selected" style="background:#E07A5F;" onclick="selectColor('#E07A5F', this)"></div> 
            <div class="color-opt" style="background:#81B29A;" onclick="selectColor('#81B29A', this)"></div> 
            <div class="color-opt" style="background:#F2CC8F;" onclick="selectColor('#F2CC8F', this)"></div> 
            <div class="color-opt" style="background:#9D8189;" onclick="selectColor('#9D8189', this)"></div> 
            <div class="color-opt" style="background:#3D405B;" onclick="selectColor('#3D405B', this)"></div> 
        </div>
        <input type="hidden" id="new-color-val" value="#E07A5F">

        <div class="setup-group">
            <div class="setup-label">ÂßìÂêç</div>
            <input id="new-name" placeholder="Ëº∏ÂÖ•ÂßìÂêç">
        </div>

        <div class="setup-group">
            <div class="setup-label">ÊôÇËñ™</div>
            <div class="vertical-stack">
                <input type="number" id="new-rate" placeholder="$" inputmode="decimal">
                <div class="btn-options">
                    <div class="opt-btn" onclick="setInputValue('new-rate', 650, this)">650</div>
                    <div class="opt-btn" onclick="setInputValue('new-rate', 750, this)">750</div>
                    <div class="opt-btn" onclick="setInputValue('new-rate', 800, this)">800</div>
                    <div class="opt-btn" onclick="setInputValue('new-rate', 1000, this)">1000</div>
                </div>
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">Âπ¥Á¥ö</div>
            <div class="btn-options" style="flex-wrap: nowrap; overflow-x: auto;">
                <div class="opt-btn" onclick="selectOptionGroup('new-grade', 'ÂúãÂ∞è', this)">ÂúãÂ∞è</div>
                <div class="opt-btn" onclick="selectOptionGroup('new-grade', 'Âúã‰∏Ä', this)">Âúã‰∏Ä</div>
                <div class="opt-btn" onclick="selectOptionGroup('new-grade', 'Âúã‰∫å', this)">Âúã‰∫å</div>
                <div class="opt-btn" onclick="selectOptionGroup('new-grade', 'Âúã‰∏â', this)">Âúã‰∏â</div>
            </div>
            <input type="hidden" id="new-grade">
        </div>
        
        <!-- V285/V286: Subject Removed from Setup -->
        <input type="hidden" id="new-subject-def" value="">
        
        <button onclick="addStudent()" class="modal-btn btn-confirm btn-bubble">Á¢∫Ë™çÊñ∞Â¢û</button>
        <button onclick="closeModal('setup-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<div id="log-modal" class="modal">
    <div class="modal-content">
        <h3 id="log-name-display" class="modal-title">ÊéíË™≤Ë®≠ÂÆö</h3>
        
        <div class="setup-group">
            <div class="setup-label">ÊôÇÊï∏</div>
            <div class="vertical-stack">
                <input type="number" id="log-hours" placeholder="hr" inputmode="decimal">
                <div class="btn-options">
                    <div class="opt-btn" onclick="setInputValue('log-hours', 1.5, this)">1.5</div>
                    <div class="opt-btn" onclick="setInputValue('log-hours', 2.0, this)">2.0</div>
                    <div class="opt-btn" onclick="setInputValue('log-hours', 2.5, this)">2.5</div>
                    <div class="opt-btn" onclick="setInputValue('log-hours', 3.0, this)">3.0</div>
                </div>
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÁßëÁõÆ</div>
            <div class="btn-options" id="log-subject-group">
                <div class="opt-btn" onclick="selectOptionGroup('log-subject', 'Êï∏Â≠∏', this)">Êï∏Â≠∏</div>
                <div class="opt-btn" onclick="selectOptionGroup('log-subject', 'Ëã±Êñá', this)">Ëã±Êñá</div>
                <div class="opt-btn" onclick="selectOptionGroup('log-subject', 'ÁêÜÂåñ', this)">ÁêÜÂåñ</div>
                <div class="opt-btn" onclick="selectOptionGroup('log-subject', 'ÁîüÁâ©', this)">ÁîüÁâ©</div>
            </div>
            <input type="hidden" id="log-subject">
        </div>

        <div class="setup-group">
            <div class="setup-label">ÊôÇÈñìËàáÊó•Êúü</div>
            <div class="vertical-stack">
                <input type="time" id="log-time" style="width:100%;">
                <div class="date-row">
                    <div class="date-input-wrapper">
                        <input type="date" id="log-date">
                    </div>
                    <button onclick="addDateTag()" class="add-date-btn btn-bubble">+</button>
                </div>
            </div>
            <div id="date-tags" class="tag-container" style="margin-top:10px;"></div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÂÇôË®ª</div>
            <textarea id="log-content-modal" placeholder="ÂÇôË®ª..." style="height:70px;"></textarea>
        </div>
        
        <button onclick="saveBatchPlan()" class="modal-btn btn-confirm btn-bubble">ÂÑ≤Â≠òË°åÁ®ã</button>
        <button onclick="closeModal('log-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<div id="edit-log-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">‰øÆÊîπË™≤Á®ã</h3>
        <input type="hidden" id="edit-log-ts">
        
        <div class="setup-group">
            <div class="setup-label">Êó•ÊúüËàáÊôÇÈñì</div>
            <div class="vertical-stack">
                 <input type="time" id="edit-log-time">
                 <input type="date" id="edit-log-date">
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÊôÇÊï∏</div>
            <div class="vertical-stack">
                <input type="number" id="edit-log-hours" inputmode="decimal">
                <div class="btn-options">
                    <div class="opt-btn" onclick="setInputValue('edit-log-hours', 1.5, this)">1.5</div>
                    <div class="opt-btn" onclick="setInputValue('edit-log-hours', 2.0, this)">2.0</div>
                    <div class="opt-btn" onclick="setInputValue('edit-log-hours', 2.5, this)">2.5</div>
                    <div class="opt-btn" onclick="setInputValue('edit-log-hours', 3.0, this)">3.0</div>
                </div>
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÁßëÁõÆ</div>
            <div class="vertical-stack">
                <input type="text" id="edit-log-subject">
                <div class="btn-options" id="edit-subject-group">
                    <div class="opt-btn" onclick="selectOptionGroup('edit-log-subject', 'Êï∏Â≠∏', this)">Êï∏Â≠∏</div>
                    <div class="opt-btn" onclick="selectOptionGroup('edit-log-subject', 'Ëã±Êñá', this)">Ëã±Êñá</div>
                    <div class="opt-btn" onclick="selectOptionGroup('edit-log-subject', 'ÁêÜÂåñ', this)">ÁêÜÂåñ</div>
                    <div class="opt-btn" onclick="selectOptionGroup('edit-log-subject', 'ÁîüÁâ©', this)">ÁîüÁâ©</div>
                </div>
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÂÇôË®ª</div>
            <textarea id="edit-log-content" style="height:70px;"></textarea>
        </div>

        <button onclick="saveEditedLog()" class="modal-btn btn-confirm btn-bubble">‰øùÂ≠ò‰øÆÊîπ</button>
        <button onclick="closeModal('edit-log-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<div id="bank-input-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title" id="bank-title">Â≠òÂÖ•</h3>
        <div class="setup-group">
            <div class="setup-label">Êó•Êúü</div>
            <input type="date" id="bank-date" style="text-align:center;">
        </div>
        <div class="setup-group" style="margin-top:20px;">
             <div class="setup-label">ÈáëÈ°ç</div>
             <input id="bank-amount" type="number" inputmode="decimal" placeholder="$0">
        </div>
        <button onclick="submitBankTransaction()" class="modal-btn btn-confirm btn-bubble">Á¢∫Ë™ç</button>
        <button onclick="closeModal('bank-input-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<div id="bank-history-modal" class="modal"><div class="modal-content" style="height:60vh; display:flex; flex-direction:column;"><h3 class="modal-title">‰∫§ÊòìÊòéÁ¥∞</h3><div id="bank-history-list" style="overflow-y:auto; flex:1;"></div><button onclick="closeModal('bank-history-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button></div></div>
<div id="all-schedule-modal" class="modal"><div class="modal-content" style="height:70vh; display:flex; flex-direction:column;"><h3 class="modal-title">Ê≠∑Âè≤Á¥ÄÈåÑ</h3><div id="all-schedule-list" style="overflow-y:auto; flex:1;"></div><button onclick="closeModal('all-schedule-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button></div></div>
<div id="settlement-modal" class="modal"><div class="modal-content"><h3 class="modal-title">ÁµêÁÆó</h3><div style="text-align:center; font-size:36px; font-weight:800; margin-bottom:20px; color:var(--text-main);" id="settlement-timer-display">00:00:00</div>
    <div class="setup-label">ÊôÇÊï∏</div>
    <div class="vertical-stack" style="margin-bottom:15px;">
        <input id="settlement-manual-hours" type="number" inputmode="decimal" placeholder="Á¢∫Ë™çÊôÇÊï∏">
        <div class="btn-options"><div class="opt-btn" onclick="setInputValue('settlement-manual-hours', 1.5, this)">1.5</div><div class="opt-btn" onclick="setInputValue('settlement-manual-hours', 2.0, this)">2.0</div><div class="opt-btn" onclick="setInputValue('settlement-manual-hours', 2.5, this)">2.5</div></div>
    </div>
    <button onclick="confirmSettlement()" class="modal-btn btn-confirm btn-bubble">Á¢∫Ë™ç</button>
    <button onclick="closeModal('settlement-modal')" class="modal-btn btn-cancel">ËøîÂõû</button>
</div></div>

<div id="student-history-modal" class="modal"><div class="modal-content modal-stats-content"><h3 id="stu-history-name" class="modal-title"></h3><div style="text-align:center; font-size:36px; font-weight:900; color:var(--accent-primary); margin-bottom:20px;" id="stu-history-total">$0</div><div id="stu-history-list" style="flex:1; overflow-y:auto; margin-bottom:10px; border-top:1px solid #EEE; padding-top:10px;"></div><button id="btn-delete-all-logs" class="modal-btn btn-delete-all btn-bubble">üóë Âà™Èô§Êú¨ÊúàÊâÄÊúâÁ¥ÄÈåÑ</button><button onclick="closeModal('student-history-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button></div></div>

<div id="profile-modal" class="modal">
    <div class="modal-content" style="max-height:80vh; overflow-y:auto;">
        <h3 class="modal-title">ÂøÉÊÉÖÊó•Ë®ò</h3>
        <input type="file" id="avatar-upload" style="display:none" onchange="handleAvatarUpload(this)">
        <div class="sidebar-avatar" id="profile-avatar" onclick="triggerUpload()" style="margin-bottom:10px; margin-left:auto; margin-right:auto;">üß∏</div>
        <div style="text-align:center; margin-bottom:15px; color:#999; font-size:12px;">ÈªûÊìäÈ†≠ÂÉèÊõ¥ÊèõÁÖßÁâá</div>
        <textarea id="mood-input" placeholder="‰ªäÂ§©ÁôºÁîü‰∫Ü‰ªÄÈ∫ºÂ•ΩÁé©ÁöÑ‰∫ãÔºü" style="height:80px;"></textarea>
        <button onclick="saveMood()" class="modal-btn btn-confirm btn-bubble">Ë®òÈåÑÂøÉÊÉÖ</button>
        <div id="mood-list" style="margin-top:20px; max-height:200px; overflow-y:auto;"></div>
        <button onclick="closeModal('profile-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button>
    </div>
</div>

<script>
    const DB_STU = 'tutor_v10_students';
    const DB_LOG = 'tutor_v15_logs';
    const DB_BANK = 'tutor_v27_bank';
    const DB_PROF = 'tutor_v33_profile'; 

    let currentPlanningStuIdx = null, selectedDates = [], touchStartX = 0, currentPage = 0;
    let currentBankAction = 'deposit', currentAccountId = 'taiwan_bank';
    let viewDate = new Date();
    viewDate.setDate(1); 
    
    let settlingLogTs = null;
    let currentStatsStudent = null;
    let lastTotalAssets = 0; 

    function safeLoad(key, defaultVal) {
        try { return JSON.parse(localStorage.getItem(key)) || defaultVal; } 
        catch (e) { console.error("Data Reset:", key); return defaultVal; }
    }

    window.students = safeLoad(DB_STU, []);
    window.logs = safeLoad(DB_LOG, []);
    window.bankLogs = safeLoad(DB_BANK, []);
    let profileData = safeLoad(DB_PROF, { avatar: 'üß∏', moods: [] });

    window.onload = function() {
        let needsSave = false;
        window.logs.forEach(l => {
            if(l.status === 'done' || !l.status) {
                l.status = 'unpaid';
                needsSave = true;
            }
        });
        if(needsSave) localStorage.setItem(DB_LOG, JSON.stringify(window.logs));

        renderStudents(); renderSchedule(); updateAssets(); updateProfileDisplay();
        setInterval(updateRunningTimers, 1000);
        
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.swipe-content')) {
                closeAllSwipes();
            }
        });
    };

    function hardReset() {
        if(confirm("Ë≠¶ÂëäÔºöÈÄôÂ∞áÂà™Èô§ÊâÄÊúâË≥áÊñô‰∏¶ÈáçÁΩÆÁ≥ªÁµ±„ÄÇÁ¢∫ÂÆöÂóéÔºü")) {
            localStorage.clear(); location.reload();
        }
    }

    function switchTab(idx) {
        currentPage = idx;
        const slider = document.getElementById('page-slider');
        const titles = ["ÊéíË™≤Á≥ªÁµ±", "Ë≥áÁî¢Â†±Ë°®"];
        document.getElementById('header-title').innerText = titles[idx];
        slider.style.transform = `translateX(-${idx * 100}vw)`;
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        if(idx === 1) updateAssets(); 
        const sb = document.getElementById('sidebar');
        if(sb.classList.contains('active')) toggleSidebar();
    }

    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebar-overlay');
        const active = sb.classList.contains('active');
        sb.classList.toggle('active', !active);
        ov.style.display = active ? 'none' : 'block';
    }

    document.addEventListener('touchstart', e => { 
        if(!e.target.closest('.student-scroll') && !e.target.closest('.modal')) touchStartX = e.changedTouches[0].screenX; 
    });
    document.addEventListener('touchend', e => {
        if(!e.target.closest('.student-scroll') && !e.target.closest('.modal')) {
            const touchEndX = e.changedTouches[0].screenX;
            if(Math.abs(touchEndX - touchStartX) > 100) switchTab(touchEndX < touchStartX ? 1 : 0);
        }
    });

    function changeMonth(d) {
        viewDate.setMonth(viewDate.getMonth() + d);
        updateAssets();
    }

    function updateAssets() {
        let tw = 100000; let sp = 13107;
        window.bankLogs.forEach(b => {
            const amt = parseInt(b.amount);
            if(b.accountId === 'taiwan_bank') tw += (b.type==='deposit'?amt:-amt);
            else sp += (b.type==='deposit'?amt:-amt);
        });
        
        let mTotal = 0; let estTotal = 0; 
        const y = viewDate.getFullYear();
        const m = String(viewDate.getMonth() + 1).padStart(2, '0');
        const ym = `${y}-${m}`;

        const histDiv = document.getElementById('all-logs');
        histDiv.innerHTML = '';
        
        window.logs.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(l => {
             if(l.date.startsWith(ym)) {
                 const income = parseInt(l.income || Math.round(l.hours * l.rate));
                 
                 if(['paid', 'unpaid', 'prepared', 'running'].includes(l.status)) estTotal += income;
                 if(l.status === 'paid') mTotal += income;

                 const dObj = new Date(l.date);
                 const dayName = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'][dObj.getDay()];
                 const dayStr = l.date.split('-')[2];
                 
                 let color = '#AAA'; 
                 if(l.status === 'paid') color = 'var(--money-green)';
                 if(l.status === 'unpaid') color = 'var(--accent-primary)';
                 if(l.status === 'running') color = '#C95D4E';

                 const dateHTML = `${dayStr}Êó• <span style="font-size:11px;font-weight:400">(${dayName})</span>`;
                 histDiv.innerHTML += generateSwipeItem(l, dateHTML, color, income);
             }
        });

        const finalTotal = tw + sp;
        animateValue(document.getElementById('total-assets-val'), 0, finalTotal, 1500);

        if(lastTotalAssets > 0 && Math.floor(finalTotal/50000) > Math.floor(lastTotalAssets/50000)) {
            launchConfetti();
        }
        lastTotalAssets = finalTotal;

        document.getElementById('taiwan-bank-balance').innerText = "$" + tw.toLocaleString();
        document.getElementById('sinopac-balance').innerText = "$" + sp.toLocaleString();
        document.getElementById('stats-month-display').innerText = `${y}Âπ¥ ${parseInt(m)}Êúà`;
        document.getElementById('month-total').innerText = "$" + mTotal.toLocaleString();
        document.getElementById('month-est').innerText = estTotal.toLocaleString();
    }

    /* HISTORY ITEM RENDER - V287 FIXED */
    function generateSwipeItem(l, dateHTML, color, income, specificYM = null) {
        let actionBtn = '';
        const clickYM = specificYM || l.date.slice(0, 7);
        const editBtn = `<div class="btn-mini-icon btn-mini-edit btn-bubble" onclick="openEditLogModal('${l.ts}')">‚úé</div>`;
        const calBtn = `<div class="btn-mini-icon btn-bubble" onclick="addToCalendar(event, '${l.ts}')">üìÖ</div>`;
        const settleBtn = `<button class="btn-mini-pay btn-bubble" style="background:transparent; border:1px solid #718096; color:#718096;" onclick="quickSettle(event, '${l.ts}')">‚úì</button>`;

        if(l.status === 'paid') {
            actionBtn = '';
        } else if (l.status === 'unpaid') {
            actionBtn = `
                ${editBtn}
                <button class="btn-mini-pay btn-bubble" onclick="markAsPaid(event, '${l.ts}')">üí∞ Êî∂Ê¨æ</button>
            `;
        } else if (l.status === 'running') {
            actionBtn = `<span style="font-size:11px; color:#C95D4E; font-weight:700;">(ÈÄ≤Ë°å‰∏≠)</span>`;
        } else {
            actionBtn = `
                ${editBtn}
                ${calBtn}
                ${settleBtn}
            `;
        }

        return `
        <div class="swipe-container" id="swipe-${l.ts}">
            <div class="swipe-bg-delete" onclick="deleteLog(event, '${l.ts}')">Âà™Èô§</div>
            <div class="swipe-content" 
                 ontouchstart="handleSwipeStart(event, '${l.ts}')" 
                 ontouchmove="handleSwipeMove(event, '${l.ts}')" 
                 ontouchend="handleSwipeEnd(event, '${l.ts}')">
                <div class="list-date">${dateHTML}</div>
                <div class="list-info">
                     <span class="history-name-link" onclick="event.stopPropagation(); openStudentMonthStats('${l.name}', '${clickYM}')">${l.name}</span>
                </div>
                <div class="list-right">
                    <div class="list-income" style="color:${color}">
                        ${l.status === 'paid' ? '+' : ''}$${income}
                    </div>
                    ${actionBtn}
                </div>
            </div>
        </div>`;
    }

    function quickSettle(e, ts) {
        if(e) e.stopPropagation();
        const log = window.logs.find(l => String(l.ts) === String(ts));
        if(log) {
            if(confirm(`Á¢∫Ë™çÂ∞á ${log.name} ÁöÑË™≤Á®ãÊ®ôË®òÁÇ∫„ÄåÂ∑≤ÁµêÁÆó/ÂæÖÊî∂Ê¨æ„ÄçÂóéÔºü`)) {
                log.status = 'unpaid';
                log.income = Math.round(log.hours * log.rate);
                localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
                updateAssets();
                renderSchedule();
                if(document.getElementById('all-schedule-modal').style.display === 'flex') {
                    const d = new Date(log.date);
                    const targetMonthKey = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`;
                    openAllScheduleModal(targetMonthKey); 
                }
            }
        }
    }

    /* Swipe Logic */
    let listSwipeStartX = 0;
    let listSwipeCurrentX = 0;
    let activeSwipeId = null;
    let isDragging = false;
    
    function handleSwipeStart(e, id) {
        if(activeSwipeId && activeSwipeId !== id) closeAllSwipes();
        listSwipeStartX = e.touches[0].clientX;
        listSwipeCurrentX = listSwipeStartX; 
        isDragging = false; 
        e.currentTarget.style.transition = 'none';
    }

    function handleSwipeMove(e, id) {
        listSwipeCurrentX = e.touches[0].clientX;
        const diff = listSwipeCurrentX - listSwipeStartX;
        if(Math.abs(diff) > 10) isDragging = true;
        if (diff < 0) {
            if(e.cancelable && Math.abs(diff) > 5) e.preventDefault();
            const el = e.currentTarget;
            if (diff > -100) el.style.transform = `translateX(${diff}px)`; 
        }
    }

    function handleSwipeEnd(e, id) {
        if (!isDragging) return;
        const diff = listSwipeCurrentX - listSwipeStartX;
        const el = e.currentTarget;
        el.style.transition = 'transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
        if (diff < -60) { 
            el.style.transform = 'translateX(-90px)'; 
            activeSwipeId = id;
        } else {
            el.style.transform = 'translateX(0)';
            activeSwipeId = null;
        }
        listSwipeStartX = 0;
        listSwipeCurrentX = 0;
        isDragging = false;
    }

    function closeAllSwipes() {
        document.querySelectorAll('.swipe-content').forEach(el => {
            el.style.transition = 'transform 0.2s ease-out';
            el.style.transform = 'translateX(0)';
        });
        activeSwipeId = null;
    }

    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = "$" + Math.floor(progress * (end - start) + start).toLocaleString();
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    function launchConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particles = [];
        for(let i=0; i<100; i++) {
            particles.push({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                size: Math.random() * 20 + 10, speedY: Math.random() * 2 + 1, speedX: Math.random() * 2 - 1, opacity: Math.random() * 0.5 + 0.5
            });
        }
        let startTime = Date.now();
        let duration = 6000;
        function draw() {
            let elapsed = Date.now() - startTime;
            let remaining = duration - elapsed;
            if (remaining <= 0) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
            ctx.clearRect(0,0,canvas.width,canvas.height);
            let globalAlpha = 1; if (remaining < 2000) globalAlpha = remaining / 2000;
            particles.forEach(p => {
                p.y += p.speedY; p.x += p.speedX;
                if(p.y > canvas.height) { p.y = -10; p.x = Math.random() * canvas.width; }
                ctx.globalAlpha = p.opacity * globalAlpha; ctx.fillStyle = "white"; ctx.font = `${p.size}px serif`; ctx.fillText("‚ùÑ", p.x, p.y);
            });
            requestAnimationFrame(draw);
        }
        draw();
    }

    /* --- V286: SOLID 3D CARDS STYLE (GRAY PAID FIX) --- */
    function renderSchedule() {
        const div = document.getElementById('today-schedule-list');
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;
        
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const weekDays = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        document.getElementById('today-title-display').innerText = `${months[now.getMonth()]} ${now.getDate()} ${weekDays[now.getDay()]}`;
        
        const todays = window.logs.filter(l => l.date === todayStr).sort((a,b) => (a.timeStart||'').localeCompare(b.timeStart||''));
        document.getElementById('empty-schedule-hint').style.display = todays.length ? 'none' : 'block';
        
        div.innerHTML = todays.map((l, index) => {
            const themeClass = `card-theme-${(index % 3) + 1}`;
            
            let timeDisplay = '';
            if (l.timeStart) {
                const [h, m] = l.timeStart.split(':').map(Number);
                const totalMin = h * 60 + m + (parseFloat(l.hours) * 60);
                const endH = Math.floor(totalMin / 60) % 24;
                const endM = Math.floor(totalMin % 60);
                const endTime = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
                timeDisplay = `<div class="sch-time-info">üïí ${l.timeStart} - ${endTime}</div>`;
            }

            const trashBtn = `<button class="btn-trash-card" onclick="deleteLog(event, '${l.ts}')">üóë</button>`;
            
            let costOverlay = '';
            if(l.status !== 'paid') {
                costOverlay = `<div class="sch-cost-overlay">${l.hours}h ‚Ä¢ $${Math.round(l.rate * l.hours)}</div>`;
            } else {
                costOverlay = `<div class="sch-cost-overlay" style="color:var(--money-green); opacity:1;">Â∑≤ÂÖ•Â∏≥ +$${l.income}</div>`;
            }

            let mainAction = '';
            let paidClass = '';

            if(l.status === 'running') {
                mainAction = `
                    <div class="timer-display" id="timer-${l.ts}">00:00:00</div>
                    <div class="card-footer">
                        <button class="btn-main-action" style="background:#C95D4E;" onclick="openSettlementModal('${l.ts}')">‚èπ ÁµêÊùü & ÁµêÁÆó</button>
                    </div>`;
            } else if(l.status === 'unpaid') {
                mainAction = `
                    <div class="card-footer">
                        ${trashBtn}
                        <button class="btn-main-action" style="background:var(--money-green);" onclick="markAsPaid(event, '${l.ts}')">üí∞ Á¢∫Ë™çÊî∂Ê¨æ</button>
                    </div>`;
            } else if(l.status === 'paid') {
                paidClass = 'paid';
                mainAction = `<div class="card-footer" style="justify-content:center; color:var(--money-green); font-weight:800;">(Â∑≤ÂÆåÊàê)</div>`;
            } else {
                mainAction = `
                    <div class="card-footer">
                        ${trashBtn}
                        <button class="btn-main-action" style="background:#FFF; color:#2D3748; flex:0 0 auto; width:80px; border:2px solid #E2E8F0;" onclick="openSettlementModal('${l.ts}')">ÁµêÁÆó</button>
                        <button class="btn-main-action" onclick="startClass(event, '${l.ts}')">‚ñ∂ ÈñãÂßã</button>
                    </div>`;
            }

            return `
            <div class="schedule-card ${themeClass} ${paidClass}">
                <div class="sch-top">
                    <div>
                        <div class="sch-title" onclick="openStudentMonthStats('${l.name}', '${todayStr.slice(0,7)}')">${l.name}</div>
                        ${timeDisplay}
                        <div class="sch-badge">${l.subject||'Ë™≤Á®ã'}</div>
                    </div>
                    <div class="cal-top-btn" onclick="addToCalendar(event, '${l.ts}')">üìÖ</div>
                </div>
                
                <div class="note-wrapper">
                    <textarea class="inline-note" placeholder="Á¥ÄÈåÑ‰∏äË™≤ÂÖßÂÆπ..." onblur="updateContent('${l.ts}', this.value)">${l.content || ''}</textarea>
                    ${costOverlay}
                </div>
                
                ${mainAction}
            </div>`; 
        }).join('');
    }

    function addToCalendar(e, ts) {
        if(e) e.stopPropagation();
        const log = window.logs.find(l => String(l.ts) === String(ts));
        if(!log) return;
        let startHour = 9, startMin = 0;
        if(log.timeStart) {
            [startHour, startMin] = log.timeStart.split(':').map(Number);
        } else {
            if(!confirm("Ê≠§Ë™≤Á®ãÊú™Ë®≠ÂÆöÊôÇÈñìÔºåÂ∞áÈ†êË®≠ÁÇ∫ 09:00ÔºåÁ¢∫ÂÆöÂä†ÂÖ•Ë°å‰∫ãÊõÜÂóéÔºü")) return;
        }
        const d = new Date(log.date);
        const format = (num) => String(num).padStart(2,'0');
        const totalStartMin = startHour * 60 + startMin;
        const totalEndMin = totalStartMin + (parseFloat(log.hours) * 60);
        const endHour = Math.floor(totalEndMin / 60);
        const endMin = totalEndMin % 60;
        const dtStart = `${d.getFullYear()}${format(d.getMonth()+1)}${format(d.getDate())}T${format(startHour)}${format(startMin)}00`;
        const dtEnd = `${d.getFullYear()}${format(d.getMonth()+1)}${format(d.getDate())}T${format(endHour)}${format(endMin)}00`;
        const icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//TutorApp//EN
BEGIN:VEVENT
UID:${log.ts}@tutorapp
DTSTAMP:${dtStart}Z
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${log.subject || 'ÂÆ∂Êïô'} - ${log.name}
DESCRIPTION:${log.content || ''}
END:VEVENT
END:VCALENDAR`;
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', `${log.name}_${log.date}.ics`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function updateContent(ts, val) {
        const log = window.logs.find(l => String(l.ts) === String(ts));
        if(log) { log.content = val; localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); }
    }

    function startClass(e, ts) { if(e) e.stopPropagation(); const log = window.logs.find(l => String(l.ts) === String(ts)); if(log) { log.status = 'running'; log.startTime = Date.now(); localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); renderSchedule(); } }
    
    function markAsPaid(e, ts) { 
        if(e) e.stopPropagation(); 
        const log = window.logs.find(l => String(l.ts) === String(ts)); 
        if(log) { 
            if(confirm(`Á¢∫Ë™çÊî∂Âà∞ $${log.income} ‰∫ÜÂóéÔºü`)) { 
                log.status = 'paid'; 
                localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); 
                renderSchedule(); 
                updateAssets(); 
                if(document.getElementById('all-schedule-modal').style.display === 'flex') {
                    const d = new Date(log.date);
                    const targetMonthKey = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`;
                    openAllScheduleModal(targetMonthKey); 
                } 
            } 
        } 
    }

    function updateRunningTimers() { window.logs.filter(l => l.status === 'running').forEach(l => { const el = document.getElementById(`timer-${l.ts}`); if (el) { const diff = Date.now() - l.startTime; const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000); el.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; } }); }

    function openSettlementModal(ts) { settlingLogTs = ts; const timerEl = document.getElementById(`timer-${ts}`); document.getElementById('settlement-timer-display').innerText = timerEl ? timerEl.innerText : "00:00:00"; document.getElementById('settlement-modal').style.display='flex'; }
    function confirmSettlement() { const h = document.getElementById('settlement-manual-hours').value; const log = window.logs.find(l => String(l.ts) === String(settlingLogTs)); if(h && log) { log.status = 'unpaid'; log.hours = h; log.income = Math.round(h * log.rate); localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); closeModal('settlement-modal'); renderSchedule(); updateAssets(); } }
    
    function renderStudents() { const div = document.getElementById('student-scroll'); div.innerHTML = window.students.map((s, idx) => `<div class="student-wrapper" onclick="openBatchPlanModal(${idx})" onmousedown="startLongPress(this)" ontouchstart="startLongPress(this)"><div class="student-chip" style="background:${s.color || '#FFF'}; border-color:${s.color || '#FFF'}">${s.name[0]}</div><div class="delete-x" onclick="event.stopPropagation(); deleteStudent(${idx})">√ó</div><div class="chip-name">${s.name}</div></div>`).join(''); }
    
    // V286: FIXED ADD STUDENT (Removed Subject check)
    function addStudent() { 
        const name = document.getElementById('new-name').value; 
        const rate = document.getElementById('new-rate').value; 
        const grade = document.getElementById('new-grade').value; 
        const color = document.getElementById('new-color-val').value; 

        if(!name || !rate || !grade) {
            const m = document.querySelector('#setup-modal .modal-content');
            m.classList.add('shake-error');
            setTimeout(() => m.classList.remove('shake-error'), 300);
            return;
        }

        window.students.push({name, rate, grade, color}); 
        localStorage.setItem(DB_STU, JSON.stringify(window.students)); 
        renderStudents(); closeModal('setup-modal'); 
    }

    function selectColor(color, el) { document.getElementById('new-color-val').value = color; document.querySelectorAll('.color-opt').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }
    function setInputValue(inputId, val, btn) { 
        document.getElementById(inputId).value = val; 
        Array.from(btn.parentElement.children).forEach(c => c.classList.remove('selected')); 
        btn.classList.add('selected'); 
    }
    function selectOptionGroup(inputId, val, btn) { 
        document.getElementById(inputId).value = val; 
        Array.from(btn.parentElement.children).forEach(c => c.classList.remove('selected')); 
        btn.classList.add('selected'); 
    }
    function deleteStudent(idx) { if(confirm('Âà™Èô§ÈÄô‰ΩçÂ≠∏ÁîüÔºü')) { window.students.splice(idx, 1); localStorage.setItem(DB_STU, JSON.stringify(window.students)); renderStudents(); } }
    
    function openBatchPlanModal(idx) { 
        currentPlanningStuIdx = idx; 
        const s = window.students[idx]; 
        document.getElementById('log-name-display').innerText = s.name; 
        document.getElementById('log-subject').value = s.subject || ''; 
        
        const subjContainer = document.getElementById('log-subject-group');
        if(subjContainer && s.subject) {
            Array.from(subjContainer.children).forEach(btn => {
                if(btn.innerText === s.subject) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
        }
        selectedDates = []; 
        renderDateTags(); 
        document.getElementById('log-date').value = new Date().toISOString().split('T')[0]; 
        document.getElementById('log-time').value = '';
        document.getElementById('log-modal').style.display = 'flex'; 
    }
    
    function renderDateTags() { const container = document.getElementById('date-tags'); container.innerHTML = selectedDates.map(date => `<div class="date-tag-item" onclick="removeDateTag('${date}')"><span>${date.slice(5)}</span><span style="font-size:16px;">‚úï</span></div>`).join(''); }
    function addDateTag() { const d = document.getElementById('log-date').value; if(d && !selectedDates.includes(d)) { selectedDates.push(d); renderDateTags(); } }
    function removeDateTag(date) { selectedDates = selectedDates.filter(d => d !== date); renderDateTags(); }
    
    function saveBatchPlan() { 
        const h = document.getElementById('log-hours').value; 
        const subj = document.getElementById('log-subject').value; 
        const note = document.getElementById('log-content-modal').value; 
        const timeVal = document.getElementById('log-time').value;
        const s = window.students[currentPlanningStuIdx]; 
        
        if (selectedDates.length === 0) { 
            const pickerDate = document.getElementById('log-date').value; 
            if (pickerDate) selectedDates.push(pickerDate); 
        } 
        
        if (!h || !subj || selectedDates.length === 0 || !timeVal) { 
            const modalContent = document.querySelector('#log-modal .modal-content'); 
            modalContent.classList.add('shake-error'); 
            setTimeout(() => modalContent.classList.remove('shake-error'), 300); 
            return; 
        } 
        
        const duplicateDates = selectedDates.filter(date => window.logs.some(l => l.date === date && l.name === s.name)); 
        if(duplicateDates.length > 0) { 
            alert(`‚ö†Ô∏è Ê≥®ÊÑèÔºö${duplicateDates.join(', ')} Â∑≤Á∂ìÊéíÈÅé ${s.name} ÁöÑË™≤‰∫ÜÔºÅ`); 
            selectedDates = selectedDates.filter(date => !duplicateDates.includes(date)); 
            if(selectedDates.length === 0) return; 
        } 
        
        selectedDates.forEach(date => { 
            window.logs.push({ 
                ts: Date.now() + Math.random(), 
                name: s.name, 
                rate: s.rate, 
                hours: h, 
                subject: subj, 
                content: note, 
                date: date, 
                timeStart: timeVal, 
                status: 'prepared', 
                income: Math.round(h * s.rate) 
            }); 
        }); 
        localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); 
        renderSchedule(); 
        closeModal('log-modal'); 
        updateAssets(); 
    }

    // V278: Edit Modal Logic with Highlighting
    function openEditLogModal(ts) { 
        closeAllSwipes(); 
        const log = window.logs.find(l => String(l.ts) === String(ts)); 
        if(!log) return; 
        document.getElementById('edit-log-ts').value = log.ts; 
        document.getElementById('edit-log-date').value = log.date; 
        document.getElementById('edit-log-time').value = log.timeStart || ''; 
        document.getElementById('edit-log-hours').value = log.hours; 
        document.getElementById('edit-log-subject').value = log.subject; 
        document.getElementById('edit-log-content').value = log.content || ''; 
        
        const hoursContainer = document.querySelector('#edit-log-modal .btn-options');
        if(hoursContainer) {
             Array.from(hoursContainer.children).forEach(btn => {
                 if(btn.innerText === String(log.hours)) btn.classList.add('selected');
                 else btn.classList.remove('selected');
             });
        }

        const subjContainer = document.getElementById('edit-subject-group');
        if(subjContainer) {
             Array.from(subjContainer.children).forEach(btn => {
                 if(btn.innerText === log.subject) btn.classList.add('selected');
                 else btn.classList.remove('selected');
             });
        }

        document.getElementById('edit-log-modal').style.display = 'flex'; 
    }

    function saveEditedLog() {
        const ts = document.getElementById('edit-log-ts').value;
        const log = window.logs.find(l => String(l.ts) === String(ts));
        if(!log) return;
        const newDate = document.getElementById('edit-log-date').value;
        const newTime = document.getElementById('edit-log-time').value;
        const newHours = document.getElementById('edit-log-hours').value;
        
        if(!newDate || !newHours) { alert('Êó•ÊúüÂíåÊôÇÊï∏ÁÇ∫ÂøÖÂ°´'); return; }

        log.date = newDate;
        log.timeStart = newTime;
        log.hours = newHours;
        log.subject = document.getElementById('edit-log-subject').value;
        log.content = document.getElementById('edit-log-content').value;
        log.income = Math.round(newHours * log.rate);
        localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
        closeModal('edit-log-modal');
        updateAssets();
        renderSchedule();
        if(document.getElementById('all-schedule-modal').style.display === 'flex') {
             const d = new Date(newDate);
             const targetMonthKey = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`;
             openAllScheduleModal(targetMonthKey); 
        }
    }

    function deleteLog(e, ts) { 
        if(e) { e.preventDefault(); e.stopPropagation(); } 
        if(confirm('Âà™Èô§Ê≠§Ë™≤Á®ãÁ¥ÄÈåÑÔºü')) { 
            const targetLog = window.logs.find(l => String(l.ts) === String(ts));
            let targetMonthKey = null;
            if(targetLog) {
                const d = new Date(targetLog.date);
                targetMonthKey = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`;
            }
            window.logs = window.logs.filter(l => String(l.ts) !== String(ts)); 
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); 
            if(document.getElementById('all-schedule-modal').style.display === 'flex') {
                openAllScheduleModal(targetMonthKey);
            }
            updateAssets(); renderSchedule(); 
        } 
    }

    function openBankInput(t, id) { currentBankAction=t; currentAccountId=id; document.getElementById('bank-title').innerText=t==='deposit'?'Â≠òÂÖ•':'ÊèêÈ†ò'; const now = new Date(); const y = now.getFullYear(); const m = String(now.getMonth()+1).padStart(2,'0'); const d = String(now.getDate()).padStart(2,'0'); document.getElementById('bank-date').value = `${y}-${m}-${d}`; document.getElementById('bank-input-modal').style.display='flex'; }
    function submitBankTransaction() { const amt = document.getElementById('bank-amount').value; const date = document.getElementById('bank-date').value; if(amt && date) { window.bankLogs.push({ts:Date.now(), amount:amt, type:currentBankAction, accountId:currentAccountId, date:date}); localStorage.setItem(DB_BANK, JSON.stringify(window.bankLogs)); closeModal('bank-input-modal'); updateAssets(); } }
    function openBankHistory(id) { const sortedLogs = window.bankLogs.filter(b=>b.accountId===id).sort((a,b) => new Date(b.date) - new Date(a.date)); document.getElementById('bank-history-list').innerHTML = sortedLogs.map(b=>`<div class="list-item"><div class="list-date" style="width:80px;">${b.date}</div><div style="flex:1; text-align:right; font-weight:700; color:${b.type==='deposit'?'var(--money-green)':'var(--money-red)'}">${b.type==='deposit'?'+':'-'}$${b.amount}</div></div>`).join(''); document.getElementById('bank-history-modal').style.display='flex'; }

    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openSetupModal() { document.getElementById('setup-modal').style.display='flex'; }
    function exportData() { const data = {students:window.students, logs:window.logs, bankLogs:window.bankLogs}; const blob = new Blob([JSON.stringify(data)],{type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.json'; a.click(); }
    function triggerImport() { document.getElementById('import-file').click(); }
    function importData(input) { 
        const reader = new FileReader(); 
        reader.onload = e => { 
            try {
                const d = JSON.parse(e.target.result); 
                if(!d.students && !d.logs) throw new Error("Invalid File");
                if(d.students) localStorage.setItem(DB_STU, JSON.stringify(d.students)); 
                if(d.logs) localStorage.setItem(DB_LOG, JSON.stringify(d.logs)); 
                if(d.bankLogs) localStorage.setItem(DB_BANK, JSON.stringify(d.bankLogs)); 
                location.reload(); 
            } catch(err) {
                alert("Ê™îÊ°àÊ†ºÂºèÈåØË™§ÔºÅË´ãÁ¢∫‰øùÊÇ®ÈÅ∏ÊìáÁöÑÊòØÊ≠£Á¢∫ÁöÑÂÇô‰ªΩÊ™î (JSON)„ÄÇ");
            }
        }; 
        reader.readAsText(input.files[0]); 
    }

    function openProfileModal() { document.getElementById('profile-modal').style.display='flex'; renderMoodList(); toggleSidebar(); }
    function saveMood() { const val = document.getElementById('mood-input').value; if(val) { profileData.moods.unshift({ date: new Date().toLocaleDateString(), text: val }); localStorage.setItem(DB_PROF, JSON.stringify(profileData)); document.getElementById('mood-input').value = ''; renderMoodList(); } }
    function renderMoodList() { document.getElementById('mood-list').innerHTML = profileData.moods.map(m => `<div style="margin-bottom:10px; padding:12px; background:#F8F8F8; border-radius:12px;"><div style="font-size:11px; color:#999; margin-bottom:4px;">${m.date}</div><div style="font-size:14px; color:#2C3B4D; line-height:1.4;">${m.text}</div></div>`).join(''); }
    function triggerUpload() { document.getElementById('avatar-upload').click(); }
    function handleAvatarUpload(input) { if(input.files[0]) { const reader = new FileReader(); reader.onload = e => { profileData.avatar = e.target.result; localStorage.setItem(DB_PROF, JSON.stringify(profileData)); updateProfileDisplay(); }; reader.readAsDataURL(input.files[0]); } }
    function updateProfileDisplay() { if(profileData.avatar && profileData.avatar.startsWith('data:')) { document.getElementById('sidebar-avatar').style.backgroundImage = `url(${profileData.avatar})`; document.getElementById('sidebar-avatar').innerText = ''; } }

    function openStudentMonthStats(name, specificYM) { currentStatsStudent = name; const ym = specificYM || (viewDate.getFullYear() + '-' + String(viewDate.getMonth() + 1).padStart(2, '0')); const myLogs = window.logs.filter(l => l.name === name && l.date.startsWith(ym) && (l.status === 'paid' || l.status === 'unpaid')); let total = 0; const listHtml = myLogs.map(l => { const isPaid = l.status === 'paid'; const income = parseInt(l.income); if(isPaid) total += income; return `<div class="list-item"><div class="list-date">${l.date.slice(5)}<br><span style="font-size:11px;color:#CBD5E0;">(${l.subject||'Ë™≤Á®ã'})</span></div><div style="font-weight:700; color:${isPaid ? 'var(--money-green)' : '#AAA'};">${isPaid ? '' : '(ÂæÖÊî∂) '}$${l.income}</div></div>`; }).join(''); document.getElementById('stu-history-name').innerText = `${name} ${ym} ÊúàË≤¢Áçª`; document.getElementById('stu-history-total').innerText = "$" + total.toLocaleString(); document.getElementById('stu-history-list').innerHTML = listHtml || '<div style="text-align:center; padding:20px; color:#AAA;">Êú¨ÊúàÁÑ°Á¥ÄÈåÑ</div>'; document.getElementById('btn-delete-all-logs').onclick = function() { deleteAllStudentMonthLogs(name, ym); }; document.getElementById('student-history-modal').style.display = 'flex'; }
    function deleteAllStudentMonthLogs(name, ym) { if(confirm(`‚ö†Ô∏è Âç±Èö™ÔºöÁ¢∫ÂÆöË¶ÅÂà™Èô§ ${name} Âú® ${ym} ÁöÑÊâÄÊúâË™≤Á®ãÁ¥ÄÈåÑÂóéÔºü\n(ÂåÖÂê´Â∑≤Êî∂Ê¨æÂíåÊú™Êî∂Ê¨æ)`)) { window.logs = window.logs.filter(l => !(l.name === name && l.date.startsWith(ym))); localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); closeModal('student-history-modal'); openAllScheduleModal(); updateAssets(); renderSchedule(); } }
    
    function openAllScheduleModal(autoExpandKey = null) { 
        const list = document.getElementById('all-schedule-list'); 
        list.innerHTML = ''; 
        const groups = {}; 
        
        window.logs.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(l => { 
            const d = new Date(l.date); 
            const k = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`; 
            if(!groups[k]) groups[k] = []; 
            groups[k].push(l); 
        }); 

        if(Object.keys(groups).length === 0) list.innerHTML = '<div style="text-align:center;padding:20px;color:#999">ÁÑ°Á¥ÄÈåÑ</div>'; 

        for(let [month, items] of Object.entries(groups)) { 
            const total = items.reduce((s, x) => s + (x.status === 'paid' ? (parseInt(x.income)||0) : 0), 0); 
            
            const header = document.createElement('div'); 
            header.className = 'month-group-header'; 
            header.innerHTML = `<span>${month}</span><span>$${total.toLocaleString()} ‚ñº</span>`; 
            header.onclick = function() { toggleMonthView(this); }; 
            
            const container = document.createElement('div'); 
            container.className = 'month-logs'; 
            
            if(autoExpandKey && month === autoExpandKey) {
                container.style.display = 'block';
            } else {
                container.style.display = 'none'; 
            }

            const currentYM = items[0].date.slice(0, 7); 
            container.innerHTML = items.map(l => { 
                const dObj = new Date(l.date); 
                const dayName = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'][dObj.getDay()]; 
                const dayStr = l.date.split('-')[2]; 
                const dateHTML = `${dayStr}Êó• <span style="font-size:11px;font-weight:400">(${dayName})</span>`; 
                const isPaid = l.status === 'paid'; 
                
                let color = '#AAA';
                if(l.status === 'paid') color = 'var(--money-green)';
                if(l.status === 'unpaid') color = 'var(--accent-primary)';

                const income = l.income; 
                return generateSwipeItem(l, dateHTML, color, income, currentYM); 
            }).join(''); 
            
            list.appendChild(header); 
            list.appendChild(container); 
        } 
        document.getElementById('all-schedule-modal').style.display = 'flex'; 
    }
    
    function toggleMonthView(header) { const content = header.nextElementSibling; const allContents = document.querySelectorAll('.month-logs'); const isOpening = content.style.display === 'none'; allContents.forEach(c => c.style.display = 'none'); if(isOpening) content.style.display = 'block'; }
    let pressTimer; function startLongPress(el) { pressTimer = setTimeout(() => { document.querySelectorAll('.student-wrapper').forEach(w => w.classList.add('is-editing')); document.addEventListener('click', () => document.querySelectorAll('.student-wrapper').forEach(w => w.classList.remove('is-editing')), {once:true}); }, 800); }
    document.addEventListener('mouseup', () => clearTimeout(pressTimer)); document.addEventListener('touchend', () => clearTimeout(pressTimer));
</script>
</body>
</html>