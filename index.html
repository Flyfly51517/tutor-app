<!DOCTYPE html>
<html lang="zh-TW">
<head>
<link rel="apple-touch-icon" href="icon.png">
<link rel="shortcut icon" href="icon.png">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂÆ∂ÊïôÂ∞èÊú¨Êú¨ (V182 Urbanist)</title>
    <style>
        /* --- V182: Modern Retro / Urbanist Theme --- */
        :root {
            /* Palette based on Reference Image #MP072 */
            --bg-color: #F5F2EB;  /* Palladian (adjusted for screen) */
            --card-bg: #FFFFFF;
            
            /* Primary Dark (Blue Fantastic) */
            --text-main: #2C3B4D; 
            --text-sub: #7A8699;
            
            /* Accents */
            --accent-primary: #A35139; /* Truffle Trouble (Terracotta) */
            --accent-highlight: #FFB162; /* Burning Flame (Mustard/Orange) */
            --accent-soft: #E0D8C8; /* Oatmeal */
            
            /* Functional */
            --money-green: #4A8568; 
            --money-red: #C95D4E;
            
            /* Modern Shadows */
            --shadow-card: 0 10px 40px -10px rgba(44, 59, 77, 0.08);
            --shadow-float: 0 20px 50px -10px rgba(44, 59, 77, 0.2);
            
            --ui-height: 50px;
        }

        html, body { 
            background-color: var(--bg-color); margin: 0; padding: 0; 
            font-family: "Urbanist", sans-serif; /* The requested font */
            padding-bottom: 30px; 
            -webkit-tap-highlight-color: transparent; user-select: none; 
            overflow-x: hidden; width: 100vw; 
            color: var(--text-main);
        }
        
        body { padding-top: 110px; }

        /* Header: Minimal & Glassy */
        header {
            background: rgba(245, 242, 235, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: 15px; 
            padding-left: 24px; padding-right: 24px;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 5000;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(44, 59, 77, 0.05);
            box-sizing: border-box;
        }
        
        #header-title { 
            font-size: 20px; font-weight: 800; letter-spacing: 0.5px; 
            color: var(--text-main); text-transform: uppercase;
        }
        
        .page-indicator { display: flex; gap: 8px; margin-top: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #D1CDBC; transition: 0.3s; }
        .dot.active { background: var(--accent-primary); width: 24px; border-radius: 12px; }

        .menu-btn { font-size: 28px; color: var(--text-main); cursor: pointer; padding: 5px; }

        /* Sidebar - Glassy & Modern */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 59, 77, 0.3); z-index: 9998; display: none; backdrop-filter: blur(4px); }
        .sidebar { 
            position: fixed; top: 0; right: -300px; width: 280px; height: 100%; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(30px);
            z-index: 9999; transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            padding: 50px 30px; box-sizing: border-box; 
            box-shadow: -10px 0 40px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.5);
        }
        .sidebar.active { right: 0; }
        
        .sidebar-avatar { 
            width: 100px; height: 100px; border-radius: 50%; 
            background: var(--bg-color); 
            margin: 0 auto 20px auto; display: flex; justify-content: center; align-items: center; font-size: 50px;
            box-shadow: var(--shadow-card); border: 4px solid #FFF;
            background-size: cover; background-position: center;
        }
        .sidebar-name { text-align: center; font-size: 24px; font-weight: 800; color: var(--text-main); margin-bottom: 40px; }
        
        .sidebar-item { 
            padding: 18px; border-radius: 16px; margin-bottom: 10px; 
            font-size: 16px; font-weight: 700; color: var(--text-main); 
            display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s;
            background: rgba(255,255,255,0.5);
        }
        .sidebar-item:active { background: var(--text-main); color: #FFF; }

        #main-viewport { width: 100vw; overflow: hidden; }
        #page-slider { display: flex; width: 200vw; transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); transform: translateX(0); }
        .page { width: 100vw; flex-shrink: 0; padding: 20px 24px 100px 24px; box-sizing: border-box; }

        /* Modern Headers */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 4px; }
        .section-title { font-size: 14px; font-weight: 800; color: var(--text-sub); letter-spacing: 2px; text-transform: uppercase; }
        
        /* Modern Card */
        .card { 
            background: var(--card-bg); border-radius: 28px; padding: 24px; 
            margin-bottom: 24px; box-shadow: var(--shadow-card); 
            border: 1px solid rgba(255,255,255,1);
        }

        /* V182: The "Blue Fantastic" Asset Card */
        .asset-card {
            background: var(--text-main); /* Dark Navy */
            border-radius: 32px; padding: 32px 28px; margin-bottom: 30px;
            color: #FFF; position: relative; overflow: hidden;
            box-shadow: var(--shadow-float);
        }
        /* Abstract Geometric shapes like Figure 5 */
        .asset-card::before {
            content: ''; position: absolute; bottom: -50px; right: -50px; width: 200px; height: 200px;
            background: var(--accent-primary); border-radius: 50%; opacity: 0.8; filter: blur(40px);
        }
        .asset-card::after {
            content: ''; position: absolute; top: -50px; left: -50px; width: 150px; height: 150px;
            background: var(--accent-highlight); border-radius: 50%; opacity: 0.3; filter: blur(50px);
        }
        
        .asset-label { font-size: 14px; font-weight: 700; color: rgba(255,255,255,0.6); margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase; position: relative; z-index: 2; }
        .asset-amount { 
            font-size: 52px; font-weight: 800; letter-spacing: -1px; 
            color: var(--accent-highlight); /* Burning Flame Yellow/Orange */
            position: relative; z-index: 2; line-height: 1;
        }

        /* Account Item */
        .account-item {
            display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto;
            padding: 20px 0; border-bottom: 1px solid #EEE; align-items: center; column-gap: 15px;
        }
        .account-item:last-child { border-bottom: none; }
        .acc-name { font-size: 18px; font-weight: 800; color: var(--text-main); grid-column: 1 / 2; grid-row: 1 / 2; }
        .acc-desc { font-size: 14px; color: var(--text-sub); font-weight: 600; grid-column: 1 / 2; grid-row: 2 / 3; margin-top: 4px; }
        .acc-amount { 
            font-size: 20px; font-weight: 800; color: var(--text-main); 
            grid-column: 2 / 3; grid-row: 1 / 3; text-align: right;
        }
        .acc-actions { grid-column: 1 / 3; grid-row: 3 / 4; display: flex; justify-content: flex-end; margin-top: 15px; gap: 10px; }

        /* List Items */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #EEE; width: 100%; box-sizing: border-box; }
        .list-item:last-child { border-bottom: none; }
        .item-main { display: flex; flex-direction: column; flex: 1; min-width: 0; margin-right: 15px; }
        .item-title { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-sub { font-size: 13px; color: var(--text-sub); font-weight: 600; }
        .item-right { text-align: right; display: flex; flex-direction: row; align-items: center; gap: 8px; flex-shrink: 0; }
        .item-val { font-size: 18px; font-weight: 800; color: var(--text-main); white-space: nowrap; }
        
        /* Buttons - Modern Solid Blocks */
        .btn-text { 
            padding: 8px 16px; background: #F5F2EB; border-radius: 12px; 
            color: var(--text-main); font-size: 13px; font-weight: 700; border: none;
            cursor: pointer; transition: 0.2s;
        }
        .btn-text:active { background: #E0D8C8; }
        
        .btn-add { 
            background: var(--text-main); color: #FFF; border: none;
            padding: 10px 24px; border-radius: 30px; font-size: 14px; font-weight: 700; 
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(44, 59, 77, 0.3);
        }
        .btn-add:active { transform: scale(0.96); }
        
        /* Student Scroll - Circles with names below */
        .student-scroll { display: flex; overflow-x: auto; gap: 20px; padding: 5px 5px 20px 5px; scrollbar-width: none; }
        .student-scroll::-webkit-scrollbar { display: none; }
        
        .student-wrapper {
            display: flex; flex-direction: column; align-items: center;
            width: 72px; flex-shrink: 0; position: relative;
        }
        
        .student-chip { 
            width: 72px; height: 72px; border-radius: 50%; 
            background: #FFF; border: 2px solid #FFF; 
            display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
            font-size: 28px; transition: 0.2s; margin-bottom: 10px; 
        }
        .student-wrapper:active .student-chip { transform: scale(0.94); border-color: var(--accent-primary); }
        
        .chip-name { 
            font-size: 14px; font-weight: 700; color: var(--text-main); 
            text-align: center; line-height: 1.2; width: 100%; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .chip-grade { 
            font-size: 11px; color: #FFF; background: var(--text-main); 
            padding: 3px 8px; border-radius: 20px; margin-top: 4px; font-weight: 700;
            text-align: center; display: inline-block;
        }
        
        .av-cloud { background: #E4E9F2; }
        .av-sakura { background: #F2DCD6; }
        .av-lemon { background: #F9E8C0; }
        .av-sky { background: #D6E4F0; }
        
        .delete-x { 
            position: absolute; top: 0; right: 0; width: 24px; height: 24px; 
            background: var(--money-red); color: #FFF; border-radius: 50%; 
            font-size: 14px; display: none; justify-content: center; align-items: center; 
            border: 2px solid #FFF; z-index: 10;
        }
        .is-editing .delete-x { display: flex; }
        .is-editing .student-chip { animation: shake 0.25s infinite; }
        @keyframes shake { 0% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } 100% { transform: rotate(-2deg); } }

        /* Schedule Card */
        .schedule-card { 
            background: #FFFFFF; border-radius: 28px; padding: 24px; margin-bottom: 20px; 
            box-shadow: var(--shadow-card); position: relative;
        }
        .schedule-card.done { opacity: 0.6; filter: grayscale(1); }
        .sch-top { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .sch-title { font-size: 20px; font-weight: 800; color: var(--text-main); }
        .sch-badge { font-size: 12px; padding: 6px 12px; background: var(--bg-color); border-radius: 12px; color: var(--text-main); font-weight: 700; }
        
        .inline-note { 
            width: 100%; padding: 16px; background: #F9F9F9; border: none; border-radius: 20px; 
            font-size: 15px; color: var(--text-main); box-sizing: border-box; outline: none; resize: none; 
            margin-top: 10px; margin-bottom: 0; min-height: 50px;
        }
        .inline-note:focus { background: #FFF; box-shadow: 0 0 0 2px var(--accent-primary); }
        
        .timer-display { font-size: 42px; font-weight: 800; color: var(--text-main); text-align: center; margin: 20px 0; font-feature-settings: "tnum"; }

        .controls { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #F5F2EB; }
        .ctrl-btn { 
            flex: 1; padding: 14px; border-radius: 18px; border: none; 
            font-size: 14px; font-weight: 700; display: flex; justify-content: center; gap: 6px; 
            cursor: pointer; transition: 0.2s; white-space: nowrap; color: var(--text-main); background: #F5F2EB;
        }
        .ctrl-btn:active { transform: scale(0.96); }
        .btn-start { background: var(--text-main); color: #FFF; }
        .btn-stop { background: var(--accent-primary); color: #FFF; }
        
        .income-estimate { font-size: 13px; font-weight: 700; color: var(--text-sub); text-align: center; margin-bottom: 0px; text-transform: uppercase; letter-spacing: 1px;}
        .income-total { 
            font-size: 48px; font-weight: 800; color: var(--accent-primary); 
            text-align: center; margin-bottom: 40px; 
        }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 59, 77, 0.4); justify-content: center; align-items: center; backdrop-filter: blur(10px); z-index: 6000; }
        #log-modal { z-index: 9999 !important; } 
        #all-schedule-modal { z-index: 6000; }
        #student-history-modal { z-index: 7000; } 
        
        .modal-content { background: #FFF; width: 85%; max-width: 340px; border-radius: 36px; padding: 32px; box-shadow: 0 30px 80px rgba(0,0,0,0.3); }
        
        .modal-title { font-size: 20px; font-weight: 800; color: var(--text-main); text-align: center; margin-bottom: 24px; }

        input, select, textarea { 
            width: 100%; padding: 16px; margin-bottom: 16px; 
            border: 2px solid #F5F2EB; border-radius: 20px; 
            font-size: 16px; box-sizing: border-box; outline: none; background: #FFF;
            transition: 0.2s; color: var(--text-main); font-weight: 700; font-family: "Urbanist", sans-serif;
            height: auto; min-height: 52px; 
        }
        input:focus, textarea:focus { border-color: var(--accent-primary); }
        
        .big-input { border: none; background: transparent; font-size: 42px; font-weight: 800; text-align: center; width: 100%; margin-bottom: 20px; color: var(--text-main); }
        .big-input:focus { border: none; }
        
        .modal-btn { width: 100%; padding: 16px; border-radius: 20px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.2s; font-family: "Urbanist", sans-serif; }
        .btn-confirm { background: var(--text-main); color: #FFF; box-shadow: 0 10px 20px rgba(44, 59, 77, 0.2); }
        .btn-confirm:active { transform: scale(0.97); }
        .btn-cancel { background: transparent; color: var(--text-sub); }

        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .tag { padding: 10px 18px; background: #F5F2EB; border-radius: 16px; font-size: 14px; font-weight: 700; color: var(--text-sub); cursor: pointer; border: 2px solid transparent; }
        .tag.selected { background: var(--accent-soft); border-color: var(--text-main); color: var(--text-main); }
        
        .date-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        .date-wrapper input { flex: 1; min-width: 0; margin-bottom: 0; }
        .date-tag { background: #F5F2EB; color: var(--text-main); padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 700; display: flex; align-items: center; cursor: pointer; margin-right:5px; margin-bottom:5px; }

        .photo-row { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0; margin-bottom: 10px; scrollbar-width: none; }
        .photo-thumb { width: 70px; height: 70px; border-radius: 18px; background-size: cover; border: 1px solid #EEE; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex-shrink: 0; }
        
        .more-menu-popover {
            position: absolute; bottom: 100%; left: 0; background: #FFF; border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            display: none; flex-direction: column; overflow: hidden; z-index: 50;
            margin-bottom: 12px; min-width: 140px; border: 1px solid #F0F0F0;
        }
        .more-menu-item { padding: 15px 20px; font-size: 15px; font-weight: 600; color: var(--text-main); border-bottom: 1px solid #F9F9F9; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        
        .student-link { color: var(--text-main); text-decoration: underline; text-decoration-color: var(--accent-primary); text-underline-offset: 4px; cursor: pointer; font-weight: 800; }

        .month-nav { display: flex; justify-content: center; align-items: center; position: relative; height: 44px; margin-bottom: 20px; }
        .month-nav .btn-text { position: absolute; top: 0; margin-top: 0; }
        .month-nav .btn-text:first-child { left: 0; }
        .month-nav .btn-text:last-child { right: 0; }
        .month-display { font-size: 20px; font-weight: 800; color: var(--text-main); }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-avatar" id="sidebar-avatar" onclick="openProfileModal()">üß∏</div>
        <div class="sidebar-name" id="sidebar-name">Shannon</div>
    </div>
    <div class="sidebar-item" onclick="openProfileModal()">üìù ÂøÉÊÉÖÊó•Ë®ò</div>
    <div class="sidebar-item" onclick="switchTab('home')">üóìÔ∏è ÊéíË™≤Á≥ªÁµ±</div>
    <div class="sidebar-item" onclick="switchTab('stats')">üìä Ë≥áÁî¢Â†±Ë°®</div>
    <div class="sidebar-item" onclick="exportData()">üì§ ÂÇô‰ªΩË≥áÊñô</div>
    <div class="sidebar-item" onclick="triggerImport()">üì• ÈÇÑÂéüË≥áÊñô</div>
    <input type="file" id="import-file" style="display:none" onchange="importData(this)">
</div>

<header>
    <div class="menu-btn" style="opacity:0; pointer-events:none;">‚ò∞</div> 
    <div style="display:flex; flex-direction:column; align-items:center;">
        <div id="header-title">Tutor App</div>
        <div class="page-indicator" style="margin-top:5px;">
            <div class="dot active" id="dot-home"></div>
            <div class="dot" id="dot-stats"></div>
        </div>
    </div>
    <div class="menu-btn" onclick="toggleSidebar()">‚ò∞</div>
</header>

<div id="main-viewport">
    <div id="page-slider">
        <div id="home-page" class="page container">
            <div class="section-header">
                <div class="section-title">Students</div>
                <button class="btn-add" onclick="openSetupModal()">+ NEW</button>
            </div>
            <div class="card" style="padding:20px 0;"><div class="student-scroll" id="student-scroll"></div></div>
            
            <div class="section-header" style="margin-top: 30px;">
                <div class="section-title">Schedule</div>
                <button class="btn-text" style="background:#FFF; border:1px solid #EEE;" onclick="openAllScheduleModal()">Ê≠∑Âè≤Á¥ÄÈåÑ</button>
            </div>
            <div id="today-schedule-list"></div>
            <div id="empty-schedule-hint" style="text-align:center; padding: 60px 20px; color:#A0A0A0; font-size:14px; font-weight:700;">
                <div style="font-size:40px; margin-bottom:15px; opacity:0.6;">‚òïÔ∏è</div>
                No classes today.
            </div>
        </div>

        <div id="stats-page" class="page container">
            <div class="asset-card">
                <div class="asset-label">NET ASSETS</div>
                <div class="asset-amount" id="total-assets-val">$0</div>
            </div>
            
            <div class="card">
                <div class="section-header" style="margin-bottom:10px;">
                    <div class="section-title">Accounts</div>
                </div>
                <div class="account-item">
                    <div class="acc-name">üè¶ Âè∞ÁÅ£ÈäÄË°å</div>
                    <div class="acc-desc">Âè∞Âπ£Â≠òÊ¨æ</div>
                    <div class="acc-amount" id="taiwan-bank-balance">$0</div>
                    <div class="acc-actions">
                        <button class="btn-text" onclick="openBankInput('deposit', 'taiwan_bank')">Â≠ò</button>
                        <button class="btn-text" onclick="openBankInput('withdraw', 'taiwan_bank')">Êèê</button>
                        <button class="btn-text" onclick="openBankHistory('taiwan_bank')">ÊòéÁ¥∞</button>
                    </div>
                </div>
                <div class="account-item">
                    <div class="acc-name">üìâ Ê∞∏Ë±êË≠âÂà∏</div>
                    <div class="acc-desc">ËÇ°Á•®Ë≥áÁî¢</div>
                    <div class="acc-amount" id="sinopac-balance">$0</div>
                    <div class="acc-actions">
                        <button class="btn-text" onclick="openBankInput('deposit', 'sinopac')">Â≠ò</button>
                        <button class="btn-text" onclick="openBankInput('withdraw', 'sinopac')">Êèê</button>
                        <button class="btn-text" onclick="openBankHistory('sinopac')">ÊòéÁ¥∞</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="month-nav">
                    <button class="btn-text" onclick="changeMonth(-1)">‚ùÆ</button>
                    <div class="month-display" id="stats-month-display">...</div>
                    <button class="btn-text" onclick="changeMonth(1)">‚ùØ</button>
                </div>
                <div class="income-estimate" id="month-estimate-val">$0</div>
                <div class="income-total" id="month-total">$0</div>
                <div class="section-title" style="border-bottom:1px dashed #EEE; padding-bottom:15px; margin-bottom:20px;">History</div>
                <div id="all-logs"></div>
                <div style="margin-top:30px; text-align:center; font-size:13px; color:var(--text-sub); font-weight:700;">2025 Total: <span id="year-total" style="color:var(--text-main);">$0</span></div>
            </div>
        </div>
    </div>
</div>

<div id="log-modal" class="modal">
    <div class="modal-content">
        <h3 id="log-name-display" class="modal-title">Ë™≤Á®ãË®≠ÂÆö</h3>
        <div style="font-size:12px; color:var(--text-sub); margin-bottom:8px; font-weight:700;">ÊôÇÊï∏</div>
        <div class="tag-container" id="log-hours-group">
            <div class="tag" onclick="forceSelectButton(1.5, this, 'log-hours')">1.5</div>
            <div class="tag" onclick="forceSelectButton(2.0, this, 'log-hours')">2.0</div>
            <div class="tag" onclick="forceSelectButton(2.5, this, 'log-hours')">2.5</div>
            <div class="tag" onclick="forceSelectButton(3.0, this, 'log-hours')">3.0</div>
        </div>
        <input type="number" id="log-hours" placeholder="Ëá™Ë®ÇÊôÇÊï∏">
        <div style="font-size:12px; color:var(--text-sub); margin-bottom:8px; font-weight:700;">ÁßëÁõÆ</div>
        <div class="tag-container" id="subject-group">
            <div class="tag" onclick="selectSubject('Êï∏Â≠∏', this)">Êï∏Â≠∏</div>
            <div class="tag" onclick="selectSubject('ÁêÜÂåñ', this)">ÁêÜÂåñ</div>
            <div class="tag" onclick="selectSubject('Ëã±Êñá', this)">Ëã±Êñá</div>
        </div>
        <input type="hidden" id="log-subject-selected">
        <textarea id="log-content-modal" placeholder="ÂÇôË®ª/ÈÄ≤Â∫¶..." style="height:60px;"></textarea>
        <div class="date-wrapper">
            <input type="date" id="log-date">
            <button onclick="addDateTag()" style="background:var(--accent-primary); border:none; width:52px; height:52px; border-radius:16px; color:#FFF; font-size:24px; flex-shrink:0;">+</button>
        </div>
        <div id="date-tags" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:25px;"></div>
        <button class="modal-btn btn-confirm" onclick="saveBatchPlan()">ÂÑ≤Â≠ò</button>
        <button class="modal-btn btn-cancel" onclick="closeModal('log-modal')">ÂèñÊ∂à</button>
    </div>
</div>

<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">Êñ∞Â¢ûÂ≠∏Áîü</h3>
        <input type="text" id="new-name" placeholder="Â≠∏ÁîüÊö±Á®±">
        <div style="font-size:12px; color:var(--text-sub); margin-bottom:8px; font-weight:700;">Âπ¥Á¥ö</div>
        <div class="tag-container">
            <div class="tag" onclick="forceSelectButton('Âúã‰∏Ä', this, 'new-grade')">Âúã‰∏Ä</div>
            <div class="tag" onclick="forceSelectButton('Âúã‰∫å', this, 'new-grade')">Âúã‰∫å</div>
            <div class="tag" onclick="forceSelectButton('Âúã‰∏â', this, 'new-grade')">Âúã‰∏â</div>
            <div class="tag" onclick="forceSelectButton('È´ò‰∏Ä', this, 'new-grade')">È´ò‰∏Ä</div>
        </div>
        <input type="hidden" id="new-grade">
        <div style="font-size:12px; color:var(--text-sub); margin-bottom:8px; font-weight:700;">ÊôÇËñ™</div>
        <div class="tag-container">
            <div class="tag" onclick="selectRate(600, this)">600</div>
            <div class="tag" onclick="selectRate(700, this)">700</div>
            <div class="tag" onclick="selectRate(800, this)">800</div>
        </div>
        <input type="number" id="new-rate" placeholder="Ëº∏ÂÖ•ÈáëÈ°ç">
        <div style="font-size:12px; color:var(--text-sub); margin-bottom:8px; font-weight:700;">‰ª£Ë°®Ëâ≤</div>
        <div class="tag-container">
            <div class="tag av-cloud" onclick="selectColor('av-cloud', this)"></div>
            <div class="tag av-sakura" onclick="selectColor('av-sakura', this)"></div>
            <div class="tag av-lemon" onclick="selectColor('av-lemon', this)"></div>
            <div class="tag av-sky" onclick="selectColor('av-sky', this)"></div>
        </div>
        <input type="hidden" id="new-color">
        <button class="modal-btn btn-confirm" onclick="addStudent()">Êñ∞Â¢û</button>
        <button class="modal-btn btn-cancel" onclick="closeModal('setup-modal')">ÂèñÊ∂à</button>
    </div>
</div>

<div id="bank-input-modal" class="modal">
    <div class="modal-content">
        <h3 id="bank-input-title" class="modal-title">Â≠òÂÖ•</h3>
        <div id="bank-target-name" style="text-align:center; font-size:14px; color:var(--text-sub); margin-bottom:20px;">Âè∞ÁÅ£ÈäÄË°å</div>
        <input type="number" id="bank-amount" class="big-input" placeholder="$0" autofocus>
        <input type="text" id="bank-note" placeholder="ÂÇôË®ª (Â¶Ç: Ëñ™Ê∞¥)">
        <input type="date" id="bank-date">
        <button class="modal-btn btn-confirm" onclick="submitBankTransaction()">Á¢∫Ë™ç</button>
        <button class="modal-btn btn-cancel" onclick="closeModal('bank-input-modal')">ÂèñÊ∂à</button>
    </div>
</div>

<div id="bank-history-modal" class="modal">
    <div class="modal-content" style="height:60vh; display:flex; flex-direction:column;">
        <h3 id="history-bank-name" class="modal-title">‰∫§ÊòìÊòéÁ¥∞</h3>
        <div id="bank-history-list" style="overflow-y:auto; flex:1;"></div>
        <button class="modal-btn btn-cancel" onclick="closeModal('bank-history-modal')">ÈóúÈñâ</button>
    </div>
</div>

<div id="all-schedule-modal" class="modal">
    <div class="modal-content" style="height:70vh; display:flex; flex-direction:column; z-index:6000;">
        <h3 class="modal-title">Ê≠∑Âè≤Ë™≤Á®ãÁ¥ÄÈåÑ</h3>
        <div id="all-schedule-list" style="overflow-y:auto; flex:1;"></div>
        <button class="modal-btn btn-cancel" onclick="closeModal('all-schedule-modal')">ÈóúÈñâ</button>
    </div>
</div>

<div id="student-history-modal" class="modal">
    <div class="modal-content" style="height:60vh; display:flex; flex-direction:column; z-index:7000;">
        <h3 id="student-history-name" class="modal-title"></h3>
        <div style="text-align:center; font-size:12px; color:var(--text-sub); margin-bottom:5px;">Êú¨ÊúàË≤¢Áçª</div>
        <div class="income-total" id="student-history-total" style="font-size:36px; margin-bottom:20px;">$0</div>
        <div id="student-history-list" style="overflow-y:auto; flex:1;"></div>
        <button class="modal-btn btn-cancel" onclick="closeModal('student-history-modal')">ÈóúÈñâ</button>
    </div>
</div>

<div id="settlement-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">ÁµêÁÆóÁ¢∫Ë™ç</h3>
        <div style="text-align:center; margin-bottom:30px;">
            <div style="font-size:13px; color:var(--text-sub);">È†êÊéí</div>
            <div id="settlement-planned-hours" style="font-size:20px; font-weight:700; color:var(--text-main);">2.0 hr</div>
            <div style="font-size:13px; color:var(--text-sub); margin-top:15px;">ÂØ¶Èöõ</div>
            <div id="settlement-timer-display" style="font-size:40px; font-weight:800; color:var(--accent-primary);">00:00:00</div>
        </div>
        <div style="border-top:1px dashed #DDD; padding-top:20px; margin-bottom:20px;">
            <label style="font-size:12px; color:var(--text-sub); font-weight:700;">Âø´ÈÄüÈÅ∏Êìá</label>
            <div class="tag-container" id="settlement-hours-group" style="margin-top:10px;">
                <div class="tag" onclick="setSettlementInput(1.5, this)">1.5</div>
                <div class="tag" onclick="setSettlementInput(2.0, this)">2.0</div>
                <div class="tag" onclick="setSettlementInput(2.5, this)">2.5</div>
                <div class="tag" onclick="setSettlementInput(3.0, this)">3.0</div>
            </div>
            <label style="font-size:12px; color:var(--text-sub); font-weight:700;">ÊâãÂãïËº∏ÂÖ•</label>
            <input type="number" id="settlement-manual-hours" placeholder="‰æãÂ¶Ç 1.8">
        </div>
        <button class="modal-btn btn-confirm" onclick="confirmSettlement()">Á¢∫Ë™çÁµêÁÆó</button>
        <button class="modal-btn btn-cancel" onclick="closeModal('settlement-modal')">ËøîÂõû</button>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">ÂÄã‰∫∫Ê™îÊ°à</h3>
        <input type="file" id="avatar-upload" style="display:none" accept="image/*" onchange="handleAvatarUpload(this)">
        <div class="sidebar-avatar" id="profile-avatar" onclick="triggerUpload()" style="margin-bottom:10px;">üß∏</div>
        <div style="text-align:center; font-size:12px; color:var(--text-sub); margin-bottom:25px;">ÈªûÊìäÊõ¥ÊèõÈ†≠ÂÉè</div>
        <textarea id="mood-input" placeholder="‰ªäÂ§©ÁöÑÂøÉÊÉÖ..." style="height:100px;"></textarea>
        <button class="modal-btn btn-confirm" onclick="saveMood()">ÂØ´Êó•Ë®ò</button>
        <div style="margin-top:25px; border-top:1px dashed #DDD; padding-top:20px;">
            <div id="mood-list" style="max-height:200px; overflow-y:auto;"></div>
        </div>
        <button class="modal-btn btn-cancel" onclick="closeModal('profile-modal')">ÈóúÈñâ</button>
    </div>
</div>

<script>
    const DB_STU = 'tutor_v10_students';
    const DB_LOG = 'tutor_v15_logs';
    const DB_BANK = 'tutor_v27_bank';
    const DB_PROFILE = 'tutor_v33_profile';

    window.students = JSON.parse(localStorage.getItem(DB_STU)) || [];
    window.logs = JSON.parse(localStorage.getItem(DB_LOG)) || [];
    window.bankLogs = JSON.parse(localStorage.getItem(DB_BANK)) || [];
    let profileData = JSON.parse(localStorage.getItem(DB_PROFILE)) || { avatar: 'üß∏', moods: [] };

    let currentPlanningStuIdx = null;
    let currentBankAction = 'deposit';
    let currentAccountId = 'taiwan_bank';
    let viewDate = new Date();
    let editingLogTs = null;
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    let selectedDates = [];
    let settlingLogTs = null;

    window.onload = function() {
        renderStudents();
        renderSchedule();
        updateAssetDisplay();
        updateProfileDisplay();
        setInterval(updateRunningTimers, 1000);
    };

    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const isActive = sb.classList.contains('active');
        if(isActive) { sb.classList.remove('active'); overlay.style.display = 'none'; }
        else { sb.classList.add('active'); overlay.style.display = 'block'; }
    }

    function switchTab(page) {
        const slider = document.getElementById('page-slider');
        const title = document.getElementById('header-title');
        const dotHome = document.getElementById('dot-home');
        const dotStats = document.getElementById('dot-stats');
        
        if (page === 'home') {
            slider.style.transform = 'translateX(0)';
            title.innerText = 'TUTOR APP';
            dotHome.classList.add('active'); dotStats.classList.remove('active');
        } else {
            slider.style.transform = 'translateX(-50%)'; 
            title.innerText = 'ASSETS';
            dotStats.classList.add('active'); dotHome.classList.remove('active');
        }
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebar-overlay').style.display = 'none';
    }

    document.addEventListener('touchstart', e => { 
        if (!e.target.closest('.student-scroll') && !e.target.closest('.photo-row') && !e.target.closest('.modal')) {
            touchStartX = e.changedTouches[0].screenX; 
            touchStartY = e.changedTouches[0].screenY;
        }
    });
    document.addEventListener('touchend', e => {
        if (!e.target.closest('.student-scroll') && !e.target.closest('.photo-row') && !e.target.closest('.modal')) {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            if (Math.abs(touchEndY - touchStartY) < 30) {
                if (touchEndX < touchStartX - 120) switchTab('stats');
                if (touchEndX > touchStartX + 120) switchTab('home');
            }
        }
    });

    function renderStudents() {
        const div = document.getElementById('student-scroll');
        div.innerHTML = window.students.map((s, idx) => `
            <div class="student-wrapper" onclick="openBatchPlanModal(${idx})" onmousedown="startLongPress(${idx})" ontouchstart="startLongPress(${idx})">
                <div class="student-chip ${s.color || ''}">
                    <div style="font-size:26px;">${s.name.charAt(0)}</div>
                </div>
                <div class="delete-x" onclick="event.stopPropagation(); deleteStudent(${idx})">√ó</div>
                <div class="chip-name">${s.name}</div>
                <div class="chip-grade">${s.grade || 'Â≠∏Áîü'}</div>
            </div>
        `).join('');
    }

    let pressTimer;
    window.startLongPress = function(idx) {
        pressTimer = setTimeout(() => {
            document.querySelectorAll('.student-wrapper').forEach(el => el.classList.add('is-editing'));
            document.addEventListener('click', () => document.querySelectorAll('.student-wrapper').forEach(el => el.classList.remove('is-editing')), {once:true});
        }, 800);
    }
    document.addEventListener('mouseup', () => clearTimeout(pressTimer));
    document.addEventListener('touchend', () => clearTimeout(pressTimer));

    function addStudent() {
        const name = document.getElementById('new-name').value;
        const rate = document.getElementById('new-rate').value;
        const color = document.getElementById('new-color').value || 'av-cloud';
        const grade = document.getElementById('new-grade').value || 'Â≠∏Áîü';
        if(name && rate) {
            window.students.push({name, rate, color, grade});
            localStorage.setItem(DB_STU, JSON.stringify(window.students));
            renderStudents(); closeModal('setup-modal');
        }
    }
    
    function deleteStudent(idx) {
        if(confirm('Âà™Èô§Ê≠§Â≠∏ÁîüÔºü')) {
            window.students.splice(idx, 1);
            localStorage.setItem(DB_STU, JSON.stringify(window.students));
            renderStudents();
        }
    }

    function renderSchedule() {
        const div = document.getElementById('today-schedule-list');
        const dObj = new Date();
        const offset = dObj.getTimezoneOffset() * 60000;
        const todayStr = new Date(dObj - offset).toISOString().split('T')[0];
        
        const todays = window.logs.filter(l => l.date === todayStr);
        document.getElementById('empty-schedule-hint').style.display = todays.length ? 'none' : 'block';
        
        div.innerHTML = todays.map(l => {
            let statusBadge = `<div class="sch-badge" style="background:#F2F0EB; color:#7A8699;">ÂæÖ‰∏äË™≤</div>`;
            let controlsHtml = '';
            
            if(l.status === 'running') {
                statusBadge = `<div class="sch-badge" style="background:#EBF7FA; color:#3A6B70; animation:pulse 2s infinite;">‰∏äË™≤‰∏≠</div>`;
                controlsHtml = `
                    <div class="timer-display" id="timer-${l.ts}">00:00:00</div>
                    <div class="controls">
                         <button class="ctrl-btn btn-stop" onclick="openSettlementModal(${l.ts})">‚èπ ÁµêÊùü & ÁµêÁÆó</button>
                    </div>
                `;
            } else if(l.status === 'done') {
                statusBadge = `<div class="sch-badge" style="background:#E8E8E8; color:#888;">Â∑≤ÂÆåÊàê</div>`;
                controlsHtml = `
                    <div style="display:flex; justify-content:space-between; margin-top:15px; background:#F9F9F9; padding:15px; border-radius:18px;">
                        <div><span style="font-size:11px; color:#AAA;">ÊôÇÊï∏</span> <b style="color:var(--text-main);">${l.hours}</b></div>
                        <div><span style="font-size:11px; color:#AAA;">Êî∂ÂÖ•</span> <b style="color:var(--text-main);">$${l.income}</b></div>
                    </div>
                    <div class="controls">
                        <input type="file" id="file-${l.ts}" hidden onchange="handleLogImageUpload(event, ${l.ts})" accept="image/*" multiple>
                        <button class="ctrl-btn btn-cancel" style="max-width:40px;" onclick="deleteLog(${l.ts})">üóë</button>
                        <button class="ctrl-btn btn-cancel" onclick="openEditModal(${l.ts})">‚úé Á∑®ËºØ</button>
                        <button class="ctrl-btn btn-photo" onclick="triggerLogImageUpload(${l.ts})">ÁÖßÁâá</button>
                        <button class="ctrl-btn btn-report" onclick="shareToLine(${l.ts})">ÂõûÂ†±</button>
                    </div>
                `;
            } else {
                controlsHtml = `
                    <div class="controls">
                        <button class="ctrl-btn btn-cancel" onclick="deleteLog(${l.ts})">‚úñ ÂèñÊ∂à</button>
                        <button class="ctrl-btn btn-start" onclick="startClass(${l.ts})">‚ñ∂ ÈñãÂßã‰∏äË™≤</button>
                    </div>
                `;
            }

            return `
            <div class="schedule-card ${l.status==='done'?'done':''}">
                <div class="sch-top">
                    <div class="sch-title">${l.name}</div>
                    ${statusBadge}
                </div>
                <div class="sch-badge" style="margin-bottom:10px; display:inline-block;">${l.subject || 'Ë™≤Á®ã'}</div>
                <textarea class="inline-note" placeholder="Á¥ÄÈåÑ‰∏äË™≤ÂÖßÂÆπ..." onblur="updateContent(${l.ts}, this.value)">${l.content || ''}</textarea>
                ${l.images ? `<div class="photo-row">${l.images.map((src, i)=>`<div class="photo-thumb" style="background-image:url(${src})"><div class="delete-x" style="display:flex; transform:scale(0.8); top:-5px; right:-5px;" onclick="deletePhoto(${l.ts}, ${i})">√ó</div></div>`).join('')}</div>` : ''}
                ${controlsHtml}
            </div>
            `;
        }).join('');
    }

    function startClass(ts) {
        const log = window.logs.find(l => l.ts === ts);
        if(log) {
            log.status = 'running';
            log.startTime = Date.now();
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            renderSchedule();
        }
    }

    function updateRunningTimers() {
        window.logs.filter(l => l.status === 'running').forEach(l => {
            const el = document.getElementById(`timer-${l.ts}`);
            if (el) {
                const diff = Date.now() - l.startTime;
                const hrs = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                const pad = n => n.toString().padStart(2, '0');
                el.innerText = `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
            }
        });
    }

    function openSettlementModal(ts) {
        settlingLogTs = ts;
        const log = window.logs.find(l => l.ts === ts);
        const el = document.getElementById(`timer-${ts}`);
        const timerVal = el ? el.innerText : "00:00:00";
        document.getElementById('settlement-timer-display').innerText = timerVal;
        document.getElementById('settlement-planned-hours').innerText = (log.hours || 0) + ' hr';
        document.getElementById('settlement-manual-hours').value = '';
        document.getElementById('settlement-modal').style.display = 'flex';
    }

    function setSettlementInput(val, btn) {
        document.getElementById('settlement-manual-hours').value = val;
        btn.parentElement.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function confirmSettlement() {
        const h = document.getElementById('settlement-manual-hours').value;
        if(!h) return alert('Ë´ãËº∏ÂÖ•ÊôÇÊï∏');
        const log = window.logs.find(l => l.ts === settlingLogTs);
        if(log) {
            log.status = 'done';
            log.hours = h;
            log.income = Math.round(h * log.rate);
            log.endTime = Date.now();
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            closeModal('settlement-modal');
            renderSchedule(); updateAssetDisplay();
        }
    }

    function saveBatchPlan() {
        const h = document.getElementById('log-hours').value;
        const subj = document.getElementById('log-subject-selected').value;
        const note = document.getElementById('log-content-modal').value;
        const d = document.getElementById('log-date').value;
        
        if(!h) return alert('Ë´ãËº∏ÂÖ•ÊôÇÊï∏');
        
        let allDates = selectedDates.slice();
        if(d && !allDates.includes(d)) allDates.push(d);
        if(allDates.length === 0) return alert('Ë´ãÈÅ∏ÊìáÊó•Êúü');

        if(editingLogTs) {
             const log = window.logs.find(l => l.ts === editingLogTs);
             if(log) {
                 log.hours = h; log.subject = subj; log.content = note; log.date = d;
                 log.income = Math.round(h * log.rate);
             }
             editingLogTs = null;
        } else {
            const s = window.students[currentPlanningStuIdx];
            allDates.forEach(date => {
                const newLog = {
                    ts: Date.now() + Math.random(),
                    name: s.name,
                    rate: s.rate,
                    hours: h,
                    subject: subj,
                    content: note,
                    date: date,
                    status: 'prepared',
                    income: Math.round(h * s.rate)
                };
                window.logs.unshift(newLog);
            });
        }
        
        localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
        closeModal('log-modal');
        renderSchedule(); updateAssetDisplay();
        if(document.getElementById('all-schedule-modal').style.display === 'flex') openAllScheduleModal();
    }
    
    function addDateTag() {
        const d = document.getElementById('log-date').value;
        if(d && !selectedDates.includes(d)) {
            selectedDates.push(d);
            renderDateTags();
        }
    }
    function renderDateTags() {
        const c = document.getElementById('date-tags');
        c.innerHTML = selectedDates.map(d => `
            <div class="date-tag" onclick="removeDate('${d}')">
                ${d} <span style="margin-left:5px;">√ó</span>
            </div>
        `).join('');
    }
    window.removeDate = function(d) {
        selectedDates = selectedDates.filter(x => x !== d);
        renderDateTags();
    }
    
    function quickSettle(ts) {
        const log = window.logs.find(l => l.ts === ts);
        if(log) {
            log.status = 'done';
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            renderSchedule(); updateAssetDisplay();
            if(document.getElementById('all-schedule-modal').style.display === 'flex') openAllScheduleModal();
        }
    }
    
    function deleteLog(ts) {
        if(confirm('Âà™Èô§Ôºü')) {
            window.logs = window.logs.filter(l => l.ts !== ts);
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            renderSchedule(); updateAssetDisplay();
        }
    }
    
    function deleteLogFromHistory(ts) {
        if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) {
            window.logs = window.logs.filter(l => l.ts !== ts);
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            openAllScheduleModal(); updateAssetDisplay(); renderSchedule();
        }
    }
    
    function updateContent(ts, val) {
        const log = window.logs.find(l => l.ts === ts);
        if(log) { log.content = val; localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); }
    }
    
    function toggleMoreMenu(ts) {
        const m = document.getElementById('more-menu-'+ts);
        if(m) m.style.display = (m.style.display === 'flex' ? 'none' : 'flex');
    }
    
    document.addEventListener('click', function(e) {
         if (!e.target.closest('.controls')) {
             document.querySelectorAll('.more-menu-popover').forEach(m => m.style.display = 'none');
         }
    });

    function updateAssetDisplay() {
        let tw = 100000, sp = 13107;
        window.bankLogs.forEach(b => {
            const amt = parseInt(b.amount);
            if(b.accountId === 'taiwan_bank') tw += (b.type==='deposit'?amt:-amt);
            else sp += (b.type==='deposit'?amt:-amt);
        });
        
        const y = viewDate.getFullYear();
        const m = (viewDate.getMonth()+1).toString().padStart(2, '0');
        const ym = `${y}-${m}`;
        
        let monthReal = 0, monthEst = 0, yearTotal = 0;
        
        window.logs.forEach(l => {
            if(l.date.startsWith(ym)) {
                const inc = parseInt(l.income || (l.hours * l.rate));
                monthEst += inc;
                if(l.status === 'done') monthReal += parseInt(l.income || 0);
            }
            if(l.status === 'done' && l.date.startsWith(`${y}-`)) yearTotal += parseInt(l.income || 0);
        });

        document.getElementById('total-assets-val').innerText = '$' + (tw+sp).toLocaleString();
        document.getElementById('taiwan-bank-balance').innerText = '$' + tw.toLocaleString();
        document.getElementById('sinopac-balance').innerText = '$' + sp.toLocaleString();
        document.getElementById('stats-month-display').innerText = `${y}Âπ¥ ${parseInt(m)}Êúà`;
        document.getElementById('month-total').innerText = '$' + monthReal.toLocaleString();
        document.getElementById('month-estimate-val').innerText = '$' + monthEst.toLocaleString();
        document.getElementById('year-total').innerText = '$' + yearTotal.toLocaleString();
        
        const histDiv = document.getElementById('all-logs');
        histDiv.innerHTML = window.logs
            .filter(l => l.status === 'done' && l.date.startsWith(ym))
            .sort((a,b) => new Date(b.date) - new Date(a.date))
            .map(l => `
                <div class="list-item">
                    <div class="item-main">
                        <div class="item-title"><span class="student-link" onclick="openStudentMonthStats('${l.name}')">${l.name}</span> <span style="font-size:12px; color:var(--text-sub); margin-left:5px;">${l.date.slice(5)}</span></div>
                        <div class="item-sub">${l.subject || 'Ë™≤Á®ã'} ‚Ä¢ ${l.hours}h</div>
                    </div>
                    <div class="item-right">
                        <div class="item-val" style="color:var(--money-green); margin-right:10px;">+$${l.income}</div>
                        <button class="btn-text" onclick="openEditModal(${l.ts})">‚úé</button>
                        <button class="btn-text" style="color:#C95D4E" onclick="deleteLogFromHistory(${l.ts})">üóë</button>
                    </div>
                </div>
            `).join('');
    }

    function submitBankTransaction() {
        const amt = document.getElementById('bank-amount').value;
        const note = document.getElementById('bank-note').value;
        const date = document.getElementById('bank-date').value;
        if(amt) {
            window.bankLogs.unshift({
                ts: Date.now(), accountId: currentAccountId, type: currentBankAction,
                amount: amt, note, date: date || new Date().toISOString().split('T')[0]
            });
            localStorage.setItem(DB_BANK, JSON.stringify(window.bankLogs));
            closeModal('bank-input-modal'); updateAssetDisplay();
        }
    }
    
    function openBankHistory(accId) {
        const list = document.getElementById('bank-history-list');
        const name = (accId === 'taiwan_bank') ? 'Âè∞ÁÅ£ÈäÄË°å' : 'Ê∞∏Ë±êË≠âÂà∏';
        document.getElementById('history-bank-name').innerText = name;
        const myLogs = window.bankLogs.filter(b => b.accountId === accId).sort((a,b) => new Date(b.date) - new Date(a.date));
        list.innerHTML = myLogs.map(b => `
            <div class="list-item">
                <div class="item-main">
                    <div class="item-title">${b.date}</div>
                    <div class="item-sub">${b.note || (b.type==='deposit'?'Â≠òÂÖ•':'ÊèêÈ†ò')}</div>
                </div>
                <div class="item-val" style="color:${b.type==='deposit'?'var(--money-green)':'var(--money-red)'}">
                    ${b.type==='deposit'?'+':'-'}$${parseInt(b.amount).toLocaleString()}
                </div>
            </div>
        `).join('');
        document.getElementById('bank-history-modal').style.display = 'flex';
    }
    
    function openAllScheduleModal() {
        const list = document.getElementById('all-schedule-list');
        list.innerHTML = window.logs.sort((a,b) => new Date(b.date) - new Date(a.date)).map(l => `
            <div class="list-item">
                <div class="item-main">
                    <div class="item-title"><span class="student-link" onclick="openStudentMonthStats('${l.name}')">${l.name}</span> <span style="font-size:12px; color:var(--text-sub); margin-left:5px;">${l.date}</span></div>
                    <div class="item-sub">${l.subject||''} ${l.hours}h ‚Ä¢ $${l.income}</div>
                </div>
                <div class="item-right">
                    ${l.status==='done' ? 
                        `<span style="font-size:12px; color:var(--money-green); font-weight:700; margin-right:10px;">Â∑≤ÂÆåÊàê</span>` : 
                        `<button class="btn-text" style="background:#F5F2EB; color:var(--money-green); margin-right:10px;" onclick="quickSettle(${l.ts})">ÁµêÁÆó</button>`
                    }
                    <button class="btn-text" onclick="openEditModal(${l.ts})">‚úé</button>
                    <button class="btn-text" style="color:#C95D4E" onclick="deleteLogFromHistory(${l.ts})">üóë</button>
                </div>
            </div>
        `).join('');
        document.getElementById('all-schedule-modal').style.display = 'flex';
    }
    
    function openStudentMonthStats(name) {
        const y = viewDate.getFullYear();
        const m = (viewDate.getMonth()+1).toString().padStart(2, '0');
        const ym = `${y}-${m}`;
        
        const myLogs = window.logs.filter(l => l.name === name && l.date.startsWith(ym) && l.status === 'done');
        let total = 0;
        
        const listHtml = myLogs.map(l => {
            total += parseInt(l.income);
            return `
            <div class="list-item">
                <div class="item-main">
                    <div class="item-title">${l.date}</div>
                    <div class="item-sub">${l.hours}Â∞èÊôÇ ‚Ä¢ ${l.subject || ''}</div>
                </div>
                <div class="item-val" style="color:var(--money-green)">+$${l.income}</div>
            </div>`;
        }).join('');
        
        document.getElementById('student-history-name').innerText = name + " - " + m + "Êúà";
        document.getElementById('student-history-total').innerText = '$' + total.toLocaleString();
        document.getElementById('student-history-list').innerHTML = listHtml || '<div style="text-align:center; padding:20px; color:#7A8699;">Êú¨ÊúàÂ∞öÁÑ°ÂÆåË™≤Á¥ÄÈåÑ</div>';
        
        document.getElementById('student-history-modal').style.display = 'flex';
    }
    
    function shareToLine(ts) {
        const log = window.logs.find(l => l.ts === ts); if(!log) return;
        let text = `„Äê‰∏äË™≤Á¥ÄÈåÑ„Äë\nüìÖ Êó•ÊúüÔºö${log.date}\nüßë‚Äçüéì Â≠∏ÁîüÔºö${log.name}\nüìö ÁßëÁõÆÔºö${log.subject || 'Êú™Â°´'}\nüìù ÂÖßÂÆπÔºö${log.content || 'ÁÑ°'}`;
        navigator.clipboard.writeText(text).then(() => {
            window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
        });
    }

    function openSetupModal() {
        document.getElementById('new-name').value = '';
        document.getElementById('setup-modal').style.display = 'flex';
    }
    function openBatchPlanModal(idx) {
        currentPlanningStuIdx = idx;
        const s = window.students[idx];
        document.getElementById('log-name-display').innerText = s.name;
        selectedDates = []; renderDateTags();
        document.getElementById('log-hours').value = ''; 
        document.getElementById('log-content-modal').value = '';
        document.getElementById('log-modal').style.display = 'flex';
    }
    function openEditModal(ts) {
        editingLogTs = ts;
        const log = window.logs.find(l => l.ts === ts);
        if(log) {
            document.getElementById('log-name-display').innerText = "Á∑®ËºØ: " + log.name;
            document.getElementById('log-hours').value = log.hours;
            document.getElementById('log-content-modal').value = log.content || '';
            document.getElementById('log-date').value = log.date;
            document.getElementById('log-subject-selected').value = log.subject || '';
            selectedDates = []; renderDateTags();
            document.getElementById('log-modal').style.display = 'flex';
        }
    }
    function openBankInput(type, accId) {
        currentBankAction = type; currentAccountId = accId;
        document.getElementById('bank-input-title').innerText = (type==='deposit'?'Â≠òÂÖ•':'ÊèêÈ†ò');
        document.getElementById('bank-target-name').innerText = (accId==='taiwan_bank'?'Âè∞ÁÅ£ÈäÄË°å':'Ê∞∏Ë±êË≠âÂà∏');
        document.getElementById('bank-input-modal').style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function forceSelectButton(val, btn, id) {
        document.getElementById(id).value = val;
        btn.parentElement.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
        btn.classList.add('selected');
    }
    function selectSubject(val, btn) {
        document.getElementById('log-subject-selected').value = val;
        btn.parentElement.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
        btn.classList.add('selected');
    }
    function selectRate(val, btn) {
        document.getElementById('new-rate').value = val;
        btn.parentElement.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
        btn.classList.add('selected');
    }
    function selectColor(val, btn) {
        document.getElementById('new-color').value = val;
        btn.parentElement.querySelectorAll('.tag').forEach(t => t.classList.remove('selected'));
        btn.classList.add('selected');
    }
    function changeMonth(delta) {
        viewDate.setMonth(viewDate.getMonth() + delta);
        updateAssetDisplay();
    }
    function updateProfileDisplay() {
        const el = document.getElementById('profile-avatar');
        const sb = document.getElementById('sidebar-avatar');
        if(profileData.avatarImg) {
            el.style.backgroundImage = `url(${profileData.avatarImg})`;
            sb.style.backgroundImage = `url(${profileData.avatarImg})`;
            el.innerText = ''; sb.innerText = '';
        }
    }
    function triggerUpload() { document.getElementById('avatar-upload').click(); }
    function handleAvatarUpload(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profileData.avatarImg = e.target.result;
                localStorage.setItem(DB_PROFILE, JSON.stringify(profileData));
                updateProfileDisplay();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    function openProfileModal() {
        document.getElementById('sidebar').classList.remove('active'); // Close Sidebar
        document.getElementById('sidebar-overlay').style.display = 'none';
        renderMoodList();
        document.getElementById('profile-modal').style.display = 'flex';
    }
    function saveMood() {
        const t = document.getElementById('mood-input').value;
        if(t) {
            const d = new Date().toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}); 
            profileData.moods.unshift({date:d, text:t});
            localStorage.setItem(DB_PROFILE, JSON.stringify(profileData));
            document.getElementById('mood-input').value='';
            renderMoodList();
        }
    }
    function renderMoodList() { 
        const l = document.getElementById('mood-list'); 
        l.innerHTML=''; 
        (profileData.moods||[]).forEach(m => l.innerHTML += `<div class="diary-entry" style="margin-bottom:15px; border-bottom:1px solid #EEE; padding-bottom:10px;"><div class="diary-date" style="font-size:12px; color:#AAA; margin-bottom:4px;">${m.date}</div><div class="diary-text" style="font-size:15px; color:#2C3B4D; line-height:1.5;">${m.text}</div></div>`); 
    }
    function triggerLogImageUpload(ts) { document.getElementById(`file-${ts}`).click(); }
    function handleLogImageUpload(event, ts) {
        const input = event.target;
        if (input.files && input.files.length > 0) {
            const log = window.logs.find(l => l.ts === ts);
            if(log) {
                if(!log.images) log.images = [];
                const files = Array.from(input.files);
                Promise.all(files.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function(e) { log.images.push(e.target.result); resolve(); };
                        reader.readAsDataURL(file);
                    });
                })).then(() => {
                    localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
                    renderSchedule(); 
                });
            }
        }
    }
    function deletePhoto(ts, index) {
        const log = window.logs.find(l => l.ts === ts);
        if(log && log.images) {
            log.images.splice(index, 1);
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs));
            renderSchedule();
        }
    }
    
    function exportData() {
        const data = { students: window.students, logs: window.logs, bankLogs: window.bankLogs, profile: profileData };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tutor_backup_' + new Date().toISOString().slice(0,10) + '.json';
        a.click();
    }
    function triggerImport() { document.getElementById('import-file').click(); }
    function importData(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.students) localStorage.setItem(DB_STU, JSON.stringify(data.students));
                    if(data.logs) localStorage.setItem(DB_LOG, JSON.stringify(data.logs));
                    if(data.bankLogs) localStorage.setItem(DB_BANK, JSON.stringify(data.bankLogs));
                    if(data.profile) localStorage.setItem(DB_PROFILE, JSON.stringify(data.profile));
                    alert('ÂåØÂÖ•ÊàêÂäüÔºÅ');
                    location.reload();
                } catch(err) { alert('ÂåØÂÖ•Â§±Êïó'); }
            };
            reader.readAsText(input.files[0]);
        }
    }
</script>
</body>
</html>