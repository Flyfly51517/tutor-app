<!DOCTYPE html>
<html lang="zh-TW">
<!-- ÂÆ∂ÊïôÂ∞èÊú¨Êú¨ V339 (Layout Fix: Card Overflow & Profile Scroll) -->
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#F7F6F2">
<meta name="format-detection" content="telephone=no">

<title>ÂÆ∂ÊïôÂ∞èÊú¨Êú¨ V339</title>

<link rel="apple-touch-icon" href="icon.png">
<link rel="shortcut icon" href="icon.png">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    /* --- GLOBAL STYLE --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root {
        --bg-color: #F7F6F2; 
        --card-bg: #FFFFFF;
        --text-main: #2D3748; 
        --text-sub: #718096;
        --accent-primary: #E07A5F; 
        --money-green: #059669; 
        --money-red: #E53E3E;
        
        --input-bg: #F7FAFC;
        --input-border: #E2E8F0;
        --std-height: 52px; 
        --radius-std: 16px;
        
        --btn-list-bg: #F0FFF4;
        --btn-list-text: #059669;
        
        --holiday-bg: #FFF5F5;
        --holiday-text: #E53E3E;
    }

    html, body, button, input, textarea, select, div, span, h1, h2, h3 { 
        font-family: "Urbanist", "Noto Sans TC", sans-serif !important; 
        user-select: none; -webkit-user-select: none;
    }
    input, textarea { user-select: text !important; -webkit-user-select: text !important; }

    html { background-color: var(--bg-color); }
    body { 
        background-color: var(--bg-color); margin: 0; padding: 0; 
        padding-bottom: 40px; overflow-x: hidden; width: 100vw; 
        color: var(--text-main); min-height: 100vh;
        overscroll-behavior-y: none; -webkit-font-smoothing: antialiased;
        padding-top: 140px !important;
    }

    #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none !important; z-index: 9999; }
    .btn-bubble { transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .btn-bubble:active { transform: scale(0.94); }

    /* SPLASH */
    #splash-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: var(--bg-color); z-index: 20000;
        display: flex; justify-content: center; align-items: center;
        flex-direction: column; transition: opacity 0.8s ease-out;
    }
    #splash-screen.hidden { opacity: 0; pointer-events: none; }
    .splash-logo-img { 
        width: 140px; height: 140px; border-radius: 35px; 
        box-shadow: 0 20px 40px rgba(0,0,0,0.08); margin-bottom: 20px; 
        animation: float 3s ease-in-out infinite; object-fit: cover;
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    /* HEADER */
    header {
        background: rgba(255, 255, 255, 0.65) !important; 
        backdrop-filter: saturate(180%) blur(25px); 
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); 
        border-bottom: 1px solid rgba(255,255,255,0.6); 
        height: 130px !important; 
        border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
        padding-top: max(10px, env(safe-area-inset-top)); padding-bottom: 15px; 
        padding-left: 20px; padding-right: 20px;
        position: fixed; top: 0; left: 0; width: 100%; z-index: 5000;
        display: grid; grid-template-columns: 44px 1fr 44px; align-items: center;
    }
    .header-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #header-title { font-size: 18px; font-weight: 800; letter-spacing: 1px; color: var(--text-main); text-transform: uppercase; margin-bottom: 6px; }
    .page-indicator { display: flex; gap: 6px; background: rgba(255,255,255,0.4); padding: 4px 8px; border-radius: 20px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(0,0,0,0.3); transition: 0.3s; }
    .dot.active { background: var(--accent-primary); width: 20px; border-radius: 10px; }
    .menu-btn { font-size: 24px; color: var(--text-main); cursor: pointer; display: flex; justify-content: center; align-items: center; height: 44px; width: 44px; border-radius: 50%; background: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.6); }

    /* SIDEBAR */
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); z-index: 9998; display: none; backdrop-filter: blur(4px); }
    .sidebar { 
        position: fixed; top: 2%; bottom: 2%; right: -360px; width: 290px; 
        z-index: 9999; transition: right 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        padding: 60px 30px; display: flex; flex-direction: column;
        padding-top: max(60px, env(safe-area-inset-top));
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.85); backdrop-filter: saturate(180%) blur(30px);
        border-radius: 44px; border: 1px solid rgba(255,255,255,0.8);
        box-shadow: -20px 20px 50px rgba(0,0,0,0.15);
    }
    .sidebar.active { right: 10px; }
    .sidebar-avatar { width: 88px; height: 88px; border-radius: 50%; background: #FFF; margin: 0 auto 20px auto; display: flex; justify-content: center; align-items: center; font-size: 42px; cursor: pointer; border: 4px solid #FFF; box-shadow: 0 10px 25px rgba(0,0,0,0.1); background-size: cover; background-position: center; }
    .sidebar-name { text-align: center; font-size: 20px; font-weight: 800; margin-bottom: 40px; color: var(--text-main); text-decoration: underline; text-decoration-color: rgba(0,0,0,0.1); text-underline-offset: 4px; cursor: pointer; }
    .sidebar-item { padding: 18px; border-radius: 22px; margin-bottom: 12px; font-size: 16px; font-weight: 700; color: var(--text-main); background: rgba(255, 255, 255, 0.6); display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.6); }
    .sidebar-item:active { transform: scale(0.98); background: #FFF; }

    /* LAYOUT */
    #main-viewport { width: 100vw; overflow: hidden; position: relative; z-index: 1; }
    #page-slider { display: flex; width: 200vw; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); transform: translateX(0); }
    .page { width: 100vw; flex-shrink: 0; padding: 10px 16px 100px 16px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 4px; gap: 10px; }
    #today-title-display { font-size: 13px; font-weight: 800; color: var(--text-sub); letter-spacing: 0.5px; text-transform: uppercase; white-space: nowrap; }
    .section-title { font-size: 13px; font-weight: 800; color: var(--text-sub); letter-spacing: 1.5px; text-transform: uppercase; }
    .header-action-btn { height: 42px; padding: 0 16px; border-radius: 21px; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none; transition: transform 0.1s; white-space: nowrap; flex-shrink: 0; }
    .btn-glass-dark { background: var(--text-main); color: #FFF; }
    .btn-style-main { background: var(--text-main); color: #FFF; }
    .btn-toggle-cal { padding: 0 16px; height: 42px; border-radius: 21px; font-size: 14px; font-weight: 700; background: var(--text-main); color: #FFF; border: 2px solid var(--text-main); display: flex; align-items: center; gap: 6px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); white-space: nowrap; flex-shrink: 0; transition: 0.2s; }
    .btn-toggle-cal.active { background: #FFF; color: var(--text-main); border-color: #EDF2F7; }

    /* ASSETS */
    .card { background: var(--card-bg); border-radius: 28px; padding: 24px 12px; margin-bottom: 24px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.02); }
    .asset-card { 
        background: radial-gradient(circle at 10% 10%, rgba(255,255,255,0.15) 0%, transparent 60%), linear-gradient(135deg, #2D3748 0%, #E07A5F 100%);
        border-radius: 32px; padding: 32px 28px; margin-bottom: 30px; color: #FFF; position: relative; overflow: hidden; z-index: 1;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4), inset 20px 20px 60px rgba(255, 255, 255, 0.1), inset -20px -20px 60px rgba(0, 0, 0, 0.2), 0 20px 40px -10px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255,255,255,0.1);
    }
    .asset-card::before { content: ''; position: absolute; top: -20%; right: -20%; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); border-radius: 50%; pointer-events: none; }
    .asset-card::after { content: ''; position: absolute; bottom: -30%; left: -10%; width: 150px; height: 150px; background: radial-gradient(circle, rgba(0,0,0,0.1) 0%, transparent 70%); border-radius: 50%; pointer-events: none; }
    .asset-label { font-size: 14px; font-weight: 700; opacity: 0.9; margin-bottom: 8px; letter-spacing: 1.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .asset-amount { font-size: 48px; font-weight: 800; color: #FFF; line-height: 1; letter-spacing: 0.5px; font-variant-numeric: tabular-nums; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .account-item { display: flex; justify-content: space-between; padding: 20px 6px; border-bottom: 1px solid #EDF2F7; align-items: center; }
    .acc-name { font-size: 16px; font-weight: 800; color: var(--text-main); white-space: nowrap; margin-right: 15px; }
    .acc-right { display: flex; flex-direction: column; align-items: flex-end; width: 100%; }
    .acc-val { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 8px; }
    .btn-group { display: flex; gap: 8px; width: 100%; justify-content: flex-end; }
    .btn-bank { padding: 8px 16px; background: #EDF2F7; border-radius: 12px; font-size: 13px; font-weight: 700; border: none; cursor: pointer; color: var(--text-main); }
    .month-nav-container { display: flex; justify-content: center; align-items: center; gap: 24px; margin-bottom: 8px; }
    .month-nav-btn { background: transparent; border: none; font-size: 24px; color: #A0AEC0; cursor: pointer; padding: 0 10px; font-family: 'Urbanist', sans-serif !important; font-weight: 800; }
    .month-label { font-family: 'Urbanist', 'Noto Sans TC', sans-serif !important; font-size: 18px; font-weight: 800; color: var(--text-main); min-width: 100px; text-align: center; }
    .est-income-val { font-family: 'Urbanist', sans-serif !important; font-size: 15px; font-weight: 700; color: #A0AEC0 !important; margin-bottom: 4px; text-align: center; }
    #month-total { font-family: 'Urbanist', sans-serif !important; font-size: 42px; font-weight: 900; color: var(--text-main); line-height: 1.1; text-align: center; }
    #month-hours-display { font-family: 'Urbanist', sans-serif !important; font-size: 14px; font-weight: 700; color: #718096; margin-top: 4px; letter-spacing: 0.5px; }

    /* SCHEDULE PAGE */
    .student-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 15px 24px 20px 24px; scrollbar-width: none; }
    .student-wrapper { display: flex; flex-direction: column; align-items: center; width: 72px; flex-shrink: 0; user-select:none; position: relative; }
    .student-chip { width: 72px; height: 72px; min-width: 72px; min-height: 72px; border-radius: 50%; background: #FFF; display: flex; justify-content: center; align-items: center; box-shadow: 0 8px 20px rgba(0,0,0,0.08); font-size: 24px; margin-bottom: 10px; border: 4px solid #FFF; transition: 0.2s; color: #FFF; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0; }
    .student-wrapper:active .student-chip { transform: scale(0.95); }
    .chip-name { font-size: 13px; font-weight: 700; color: var(--text-main); text-align: center; width: 100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .delete-x { position: absolute; top: -5px; right: 0; width: 26px; height: 26px; background: var(--money-red); color: #FFF; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 14px; border: 3px solid #FFF; z-index: 10; font-weight: 900; box-shadow: 0 4px 10px rgba(229,62,62,0.4); }
    /* Global Edit Mode */
    .student-scroll.edit-mode .delete-x { display: flex; animation: popIn 0.2s; }
    .student-scroll.edit-mode .student-chip { animation: shake 0.25s infinite; }
    @keyframes shake { 0% {transform:rotate(0deg);} 25% {transform:rotate(2deg);} 75% {transform:rotate(-2deg);} 100% {transform:rotate(0deg);} }
    @keyframes popIn { from{transform:scale(0);} to{transform:scale(1);} }

    /* CALENDAR */
    #calendar-container { display: none; background: #FFF; border-radius: 32px; padding: 20px; box-shadow: var(--shadow-card); }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 800; font-size: 18px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
    .cal-day-label { font-size: 12px; color: #CBD5E0; font-weight: 700; margin-bottom: 10px; }
    .cal-cell { height: 44px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; font-size: 14px; font-weight: 700; border-radius: 12px; cursor: pointer; border: 2px solid transparent; position: relative; }
    .cal-cell.today { background: #F7FAFC; color: var(--accent-primary); }
    .cal-cell.selected { border-color: var(--text-main); }
    .cal-cell.holiday { background-color: var(--holiday-bg); color: var(--holiday-text); } 
    .holiday-label { position: absolute; bottom: 2px; right: 4px; font-size: 10px; color: var(--holiday-text); font-weight: 800; opacity: 0.6; }
    .cal-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-primary); margin-top: 4px; }
    .cal-dot.paid { background: var(--money-green); }

    /* CARDS - V339 Layout Fix */
    #today-schedule-list { display: flex; gap: 20px; overflow-x: auto; padding: 20px 24px 40px 24px; scroll-snap-type: x mandatory; scrollbar-width: none; margin-left: -24px; margin-right: -24px; }
    #today-schedule-list::-webkit-scrollbar { display: none; }
    
    .schedule-card { 
        flex: 0 0 82%; 
        max-width: 320px; 
        height: 420px; 
        scroll-snap-align: center; 
        border-radius: 36px; 
        padding: 28px 24px; 
        position: relative; 
        display: flex; 
        flex-direction: column; 
        justify-content: space-between; 
        transition: transform 0.2s; 
        box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1); 
        border: 1px solid rgba(0,0,0,0.03); 
        background-color: var(--text-main); 
        color: #FFFFFF; 
        overflow: hidden; /* Fix: Prevent overflow */
    }
    .schedule-card:active { transform: scale(0.98); }
    
    .schedule-card.paid { background-color: #F7FAFC !important; color: #A0AEC0 !important; border: 1px solid #EDF2F7; box-shadow: none; }
    .schedule-card.paid .sch-title { color: #A0AEC0 !important; }
    .schedule-card.paid .sch-badge { background: #EDF2F7 !important; color: #A0AEC0 !important; }
    .schedule-card.paid .inline-note { background: #EDF2F7 !important; color: #A0AEC0 !important; }
    .schedule-card.paid .sch-time-info { opacity: 0.5; }
    .sch-badge { font-size: 13px; padding: 6px 14px; border-radius: 20px; font-weight: 800; display: inline-block; background: rgba(255,255,255,0.2); color: #FFF; }
    .cal-top-btn { width: 44px; height: 44px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.15); color: #FFF; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); }
    .schedule-card.paid .cal-top-btn { background: transparent !important; color: #CBD5E0 !important; border: 1px solid #EDF2F7; }
    
    /* V339: Note Wrapper Flex Fix */
    .note-wrapper { position: relative; flex: 1; margin: 15px 0; min-height: 0; display: flex; flex-direction: column; }
    .inline-note { width: 100%; flex: 1; padding: 20px; border: none; border-radius: 28px; font-size: 16px; font-weight: 500; outline: none; resize: none; box-sizing: border-box; background: rgba(255,255,255,0.1); color: #FFF; }
    .inline-note:focus { background: rgba(255,255,255,0.2); color: #FFF; }
    .inline-note::placeholder { color: rgba(255,255,255,0.6); }
    
    .sch-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-shrink: 0; }
    .sch-title { font-size: 28px; font-weight: 800; line-height: 1.1; margin-bottom: 6px; }
    .sch-time-info { font-size: 15px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; opacity: 0.8; }
    .sch-cost-overlay { position: absolute; bottom: 16px; right: 20px; font-size: 13px; font-weight: 800; pointer-events: none; opacity: 0.8; }
    
    /* V339: Card Footer Fix */
    .card-footer { display: flex; gap: 12px; align-items: center; height: 60px; flex-shrink: 0; margin-top: auto; }
    .btn-trash-card { width: 60px; height: 60px; border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: none; cursor: pointer; background: rgba(255,255,255,0.15); color: #FFD1D1; flex-shrink: 0; }
    /* Glassmorphism Buttons */
    .btn-main-action { flex: 1; height: 60px; border-radius: 24px; font-size: 16px; font-weight: 800; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; background: rgba(255, 255, 255, 0.2); color: #FFFFFF; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(4px); white-space: nowrap; }
    .btn-main-action:active { transform: scale(0.95); }
    .timer-display { font-size: 36px; font-weight: 800; text-align: center; font-feature-settings: "tnum"; margin-top: auto; margin-bottom: auto;}

    /* MODALS */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9000; justify-content: center; align-items: center; backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s; }
    .modal.active { opacity: 1; }
    /* V339 Fix: Hidden overflow-x */
    .modal-content { background: #FFF; width: 90%; max-width: 380px; border-radius: 32px; padding: 28px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; overflow-x: hidden; transition: 0.1s; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1); }
    .modal.active .modal-content { transform: scale(1); }
    .modal-content.shake-error { animation: shake 0.3s ease-in-out; border: 2px solid var(--money-red); }
    .modal-title { font-size: 18px; font-weight: 800; color: var(--text-sub); text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
    #edit-log-modal { z-index: 9100 !important; }
    
    .day-detail-card { background: #FFF; border-radius: 20px; padding: 16px; margin-bottom: 12px; border: 1px solid #EDF2F7; box-shadow: 0 4px 12px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
    .day-detail-left { display: flex; flex-direction: column; }
    .day-detail-time { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 4px; }
    .day-detail-info { font-size: 15px; font-weight: 800; color: #A0AEC0; margin-top: 4px; }
    .day-detail-right { display: flex; gap: 8px; }
    .btn-modal-action { width: 36px; height: 36px; border-radius: 12px; background: #EDF2F7; color: var(--text-sub); display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; border: none; }
    .btn-modal-delete { background: #FFF5F5; color: #E53E3E; }
    
    .settle-info-box { background: #F7FAFC; border-radius: 20px; padding: 24px; text-align: center; margin-bottom: 24px; border: 2px dashed #E2E8F0; }
    .settle-info-big { font-size: 24px; font-weight: 800; color: var(--text-main); margin-bottom: 8px; }
    .settle-info-sub { font-size: 15px; color: var(--text-sub); font-weight: 700; }
    
    .export-item { display: flex; align-items: center; padding: 14px 10px; border-bottom: 1px solid #F0F0F0; cursor: pointer; }
    .export-item:active { background-color: #F7FAFC; }
    .export-check { appearance: none; -webkit-appearance: none; width: 22px; height: 22px; margin-right: 15px; flex-shrink: 0; border: 2px solid #E2E8F0; border-radius: 6px; background: #FFF; position: relative; }
    .export-check:checked { background: var(--text-main); border-color: var(--text-main); }
    .export-check:checked::after { content: '‚úî'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #FFF; font-size: 14px; font-weight: 900; }
    
    /* FORM */
    .setup-group { margin-bottom: 16px; }
    .setup-label { font-size: 13px; font-weight: 800; color: var(--text-main); margin-bottom: 8px; margin-left: 2px; }
    input, select, .opt-btn, .modal-btn, .add-date-btn { height: var(--std-height); box-sizing: border-box; border-radius: var(--radius-std); }
    input, select, textarea { width: 100%; padding: 0 16px; border: 2px solid var(--input-border); font-size: 16px; font-weight: 700; outline: none; background: var(--input-bg); color: var(--text-main); -webkit-appearance: none; margin-bottom: 0; display: flex; align-items: center; border-radius: var(--radius-std); }
    textarea { padding: 14px; line-height: 1.4; height: auto; min-height: 80px; align-items: flex-start; }
    input:focus, textarea:focus { border-color: var(--text-main); background: #FFF; }
    #bank-amount { border: none; background: transparent; font-size: 48px; text-align: center; height: auto; border-radius: 0; padding: 20px 0; font-family: 'Urbanist', sans-serif; }
    #bank-amount::placeholder { color: #E2E8F0; }
    .btn-options { display: flex; gap: 6px; flex-wrap: nowrap; overflow-x: auto; scrollbar-width: none; align-items: center; width: 100%; }
    .opt-btn { padding: 0 16px; background: #FFF; font-size: 14px; font-weight: 700; color: var(--text-main); cursor: pointer; border: 2px solid #EDF2F7; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
    .opt-btn.selected { background: var(--text-main); color: #FFF; border-color: var(--text-main); }
    .btn-pill-gray { flex: 1; height: 40px; border-radius: 20px; background: #EDF2F7; color: #4A5568; border: none; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
    .btn-pill-gray:active { background: #CBD5E0; transform: scale(0.98); }
    .vertical-stack { display: flex; flex-direction: column; gap: 8px; width: 100%; }
    .date-row { display: flex; gap: 8px; width: 100%; }
    .date-input-wrapper { flex: 1; }
    .add-date-btn { width: var(--std-height); background: var(--text-main); color: #FFF; font-size: 24px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
    .color-picker { display: flex; gap: 12px; justify-content: center; margin-bottom: 24px; padding: 10px 0; }
    .color-opt { width: 42px; height: 42px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.15s; position: relative; }
    .color-opt.selected { transform: scale(1.15); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .color-opt.selected::after { content:'‚úì'; color:#FFF; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:16px; font-weight:800; }
    .modal-btn { width: 100%; border: none; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; height: 56px; border-radius: 20px; transition:0.2s;}
    .modal-btn:active { transform: scale(0.98); }
    .btn-confirm { background: var(--text-main); color: #FFF; box-shadow: 0 8px 20px -5px rgba(45, 55, 72, 0.3); }
    .btn-cancel { background: #EDF2F7; color: var(--text-sub); margin-top: 8px; }
    .tag-container { display: flex; flex-wrap: wrap; gap: 6px; min-height: 0; margin-bottom: 10px; }
    .date-tag-item { background: var(--text-main); color: #FFF; border-radius: 12px; padding: 6px 12px; font-size: 13px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }

    /* LIST SWIPE */
    .swipe-container { position: relative; overflow: hidden; width: 100%; height: 70px; border-bottom: 1px solid #F0F0F0; background: #FFF; margin-bottom: 0; }
    .swipe-bg-delete { position: absolute; top: 0; right: 0; bottom: 0; width: 90px; background: var(--money-red); color: #FFF; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; z-index: 1; cursor: pointer; }
    .swipe-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #FFF; z-index: 2; display: flex; align-items: center; padding: 0 16px; transition: transform 0.25s cubic-bezier(0.18, 0.89, 0.32, 1.28); will-change: transform; }
    .list-date { width: 40px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-right: 15px; flex-shrink: 0; }
    .date-num { font-size: 18px; font-weight: 800; color: #A0AEC0; line-height: 1; }
    .date-week { font-size: 13px; font-weight: 600; color: #CBD5E0; line-height: 1; margin-top: 4px; }
    .list-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
    .history-name-link { font-size: 16px; font-weight: 800; color: var(--text-main) !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .subject-tag { font-size: 13px; color: #718096; font-weight: 600; white-space: nowrap; margin-top: 2px; }
    .list-right { display: flex; align-items: center; justify-content: flex-end; gap: 8px; flex-shrink: 0; margin-left: 10px; }
    .list-income { font-weight: 800; white-space: nowrap; font-size: 15px; text-align: right; margin-right: 8px; color: #A0AEC0 !important; }
    .btn-action-uniform { width: 30px; height: 30px; border-radius: 8px; background: var(--btn-list-bg); color: var(--btn-list-text); display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; flex-shrink: 0; border: none; transition: 0.1s; }
    .btn-action-uniform:active { transform: scale(0.9); background: #C6F6D5; }
    .btn-mini-pay { padding: 0 10px; height: 30px; background: var(--btn-list-bg); color: var(--btn-list-text); border: none; border-radius: 8px; font-size: 12px; font-weight: 800; cursor: pointer; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .btn-mini-pay:active { transform: scale(0.95); }
    .trans-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px solid #F0F0F0; }
    .trans-date { font-size: 15px; font-weight: 700; color: #718096; white-space: nowrap; font-family: 'Urbanist', sans-serif !important; }
    .trans-amount { font-size: 16px; font-weight: 800; text-align: right; font-family: 'Urbanist', sans-serif !important; }
    .month-group-header { padding: 18px 20px; background: #EDF2F7; border-radius: 20px; margin-bottom: 12px; margin-top: 24px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: var(--text-main); font-size: 16px; border: 1px solid #E2E8F0; }
    .month-logs { display: none; }
    .month-logs.active { display: block; }
    
    /* V330: Monthly Summary */
    #cal-summary-area { border-top: 1px dashed #E2E8F0; margin-top: 20px; padding-top: 15px; }
    .summary-title { font-size: 14px; font-weight: 800; color: var(--text-sub); margin-bottom: 12px; letter-spacing: 1px; }
    .summary-row { display: flex; justify-content: space-between; align-items: center; background: #F9FAFB; padding: 12px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #EDF2F7; }
    .summary-left { display: flex; flex-direction: column; gap: 4px; }
    .summary-name { font-weight: 800; font-size: 16px; color: var(--text-main); }
    .summary-dates { font-size: 12px; color: #718096; line-height: 1.4; max-width: 200px; }
    .btn-line-action { background-color: #06C755; color: white; border: none; padding: 8px 16px; border-radius: 12px; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 4px; box-shadow: 0 4px 10px rgba(6, 199, 85, 0.2); }
    .btn-line-action:active { transform: scale(0.95); }
    .cal-nav-btn { background: transparent; border: none; font-size: 20px; color: #A0AEC0; cursor: pointer; padding: 0 10px; transition: color 0.2s; }
    .cal-nav-btn:active { color: var(--text-main); }

    /* V339 FIX: Profile Header & Layout */
    .profile-header-bg {
        background: linear-gradient(135deg, #E07A5F, #F2CC8F);
        padding: 40px 20px 80px 20px;
        border-radius: 0 0 40px 40px;
        margin: 0; /* V339 FIX: Removed negative margins */
        color: #FFF;
        text-align: center;
        position: relative;
    }
    .profile-avatar-large {
        width: 100px; height: 100px;
        border-radius: 50%;
        background: #FFF;
        font-size: 40px;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto 10px auto;
        border: 4px solid rgba(255,255,255,0.5);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .profile-name-large { font-size: 24px; font-weight: 800; letter-spacing: 1px; }
    
    .profile-tabs {
        display: flex; justify-content: center; gap: 10px;
        margin-top: -50px; margin-bottom: 20px;
        position: relative; z-index: 10;
    }
    .tab-btn {
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(10px);
        padding: 12px 24px;
        border-radius: 20px;
        border: none;
        font-size: 14px; font-weight: 800;
        color: #718096;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: 0.2s;
    }
    .tab-btn.active {
        background: #FFF;
        color: var(--accent-primary);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(224, 122, 95, 0.3);
    }
    
    .profile-section { display: none; padding: 10px; animation: fadeIn 0.3s; }
    .profile-section.active { display: block; }

    /* Chart Placeholder */
    .chart-container {
        height: 200px; background: #FFF;
        border-radius: 20px; margin-bottom: 20px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: 1px solid #E2E8F0;
        position: relative;
        padding: 10px;
    }

    /* Floating Action Button for Profile */
    .btn-float-profile {
        position: absolute; top: 0; right: 0;
        width: 36px; height: 36px;
        background: #EDF2F7; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 18px; cursor: pointer; border: none;
        z-index: 10;
    }

    /* --- V337 NEW STYLES: Charts & Exam Modal --- */
    .chart-svg { width: 100%; height: 100%; overflow: visible; }
    .chart-line { fill: none; stroke-width: 3px; stroke-linecap: round; stroke-linejoin: round; transition: stroke-dasharray 1s ease; }
    .chart-dot { transition: r 0.2s; cursor: pointer; }
    .chart-dot:hover { r: 6; }
    .chart-grid { stroke: #E2E8F0; stroke-width: 1; stroke-dasharray: 4 4; }
    .chart-text { font-size: 10px; fill: #A0AEC0; font-weight: 600; }
    
    .legend-container { display: flex; justify-content: center; gap: 15px; margin-top: -10px; margin-bottom: 20px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 700; color: var(--text-sub); cursor: pointer; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .legend-item.hidden { opacity: 0.3; text-decoration: line-through; }

    /* Exam Card Updates */
    .exam-card { 
        background: #FFF; border-radius: 24px;
        padding: 20px; margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: 1px solid #EDF2F7;
        position: relative; transition: transform 0.2s; 
    }
    .exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .exam-title { font-weight: 800; font-size: 16px; color: var(--text-main); }
    .exam-card:active { transform: scale(0.98); }
    .btn-delete-exam { 
        position: absolute; top: 15px; right: 15px; 
        color: #FEB2B2; background: transparent; border: none; 
        font-size: 16px; font-weight: 800; cursor: pointer;
    }
    
    .score-badge {
        display: inline-flex; flex-direction: column; align-items: center;
        background: #F7FAFC; border-radius: 12px; padding: 6px 10px; min-width: 50px;
        border: 1px solid #EDF2F7;
    }
    .score-val { font-size: 18px; font-weight: 800; color: var(--text-main); line-height: 1; }
    .score-subj { font-size: 11px; color: #A0AEC0; margin-top: 4px; font-weight: 700; }
    
    /* Good Score Highlight */
    .score-val.high { color: var(--money-green); }
    .score-val.low { color: var(--money-red); }
</style>
</head>
<body>

<!-- V303: SPLASH SCREEN -->
<div id="splash-screen">
    <img src="icon.png" class="splash-logo-img" alt="Tutor">
    <div style="font-weight: 800; font-size: 24px; letter-spacing: 2px; color: var(--text-main);">TUTOR</div>
</div>

<canvas id="confetti-canvas"></canvas>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-avatar" id="sidebar-avatar" onclick="toggleSidebar(); openProfileModal()">üß∏</div>
        <div class="sidebar-name" id="sidebar-name" onclick="editProfileName()">Tutor</div>
    </div>
    <div class="sidebar-item" onclick="toggleSidebar(); openProfileModal()">üìí ÂøÉÊÉÖÊó•Ë®ò</div>
    <div class="sidebar-item" onclick="switchTab(0)">üóìÔ∏è ÊéíË™≤Á≥ªÁµ±</div>
    <div class="sidebar-item" onclick="switchTab(1)">üìä Ë≥áÁî¢Â†±Ë°®</div>
    <div class="sidebar-item" onclick="openExportCalendarModal()">üìÖ ‰∏ÄÈçµÂåØÂÖ•Ë°å‰∫ãÊõÜ</div>
    <div class="sidebar-item" onclick="exportData()">üì§ ÂÇô‰ªΩË≥áÊñô</div>
    <div class="sidebar-item" onclick="triggerImport()">üì• ÈÇÑÂéüË≥áÊñô</div>
    <div class="sidebar-item" style="color:red; margin-top:auto;" onclick="hardReset()">‚ö†Ô∏è ÈáçÁΩÆÊâÄÊúâË≥áÊñô</div>
    <input type="file" id="import-file" style="display:none" onchange="importData(this)">
</div>

<header>
    <div class="menu-btn" style="opacity:0; pointer-events:none;">‚ò∞</div> 
    <div class="header-center">
        <div id="header-title">ÊéíË™≤Á≥ªÁµ±</div>
        <div class="page-indicator">
            <div class="dot active"></div>
            <div class="dot"></div>
        </div>
    </div>
    <div class="menu-btn" onclick="toggleSidebar()">‚ò∞</div>
</header>

<div id="main-viewport">
    <div id="page-slider">
        <!-- PAGE 1: SCHEDULE -->
        <div id="page-schedule" class="page">
            <div class="section-header">
                <div class="section-title">Students</div>
                <button class="header-action-btn btn-style-main btn-bubble" onclick="openSetupModal()">+ NEW</button>
            </div>
            
            <div class="card" style="padding: 20px 0;">
                <div class="student-scroll" id="student-scroll" style="padding: 15px 24px 20px 24px;"></div>
            </div>
            
            <div class="section-header" style="margin-top: 30px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div id="today-title-display">TODAY</div>
                    <div id="view-toggle" class="btn-toggle-cal" onclick="toggleViewMode()">
                        <span>üìÖ ÊúàÊõÜ</span>
                    </div>
                </div>
                <button class="header-action-btn btn-glass-dark btn-bubble" onclick="openAllScheduleModal()">Ê≠∑Âè≤Á¥ÄÈåÑ</button>
            </div>
            
            <div id="today-schedule-list"></div>
            
            <div id="calendar-container">
                <div class="cal-header">
                    <span onclick="changeCalMonth(-1)" style="cursor:pointer; padding:10px;">‚ùÆ</span>
                    <span id="cal-month-title"></span>
                    <span onclick="changeCalMonth(1)" style="cursor:pointer; padding:10px;">‚ùØ</span>
                </div>
                <div class="cal-day-label" style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center;">
                    <div>Êó•</div><div>‰∏Ä</div><div>‰∫å</div><div>‰∏â</div><div>Âõõ</div><div>‰∫î</div><div>ÂÖ≠</div>
                </div>
               <div id="cal-grid" class="cal-grid"></div>
                <!-- Êñ∞Â¢ûÔºöÊúàÊéíË™≤ÂàóË°®Ëàá LINE ÊåâÈàïÂçÄ -->
                <div id="cal-summary-area"></div>
            </div>

            <div id="empty-schedule-hint" style="text-align:center; padding: 60px 20px; color:#AAA; font-weight:700;">No classes today üåø</div>
        </div>

        <!-- PAGE 2: ASSETS -->
        <div id="page-assets" class="page">
            <div class="asset-card">
                <div class="asset-label">NET ASSETS</div>
                <div class="asset-amount" id="total-assets-val">$0</div>
            </div>
            
            <div class="card">
                <div class="section-header" style="margin-top:0;">
                    <div class="section-title">Accounts</div>
                </div>
                <div class="account-item">
                    <div class="acc-name">üè¶ Âè∞ÁÅ£ÈäÄË°å</div>
                    <div class="acc-right">
                        <div id="taiwan-bank-balance" class="acc-val">$0</div>
                        <div class="btn-group">
                            <button class="btn-bank btn-bubble" onclick="openBankInput('deposit', 'taiwan_bank')">Â≠ò</button>
                            <button class="btn-bank btn-bubble" onclick="openBankInput('withdraw', 'taiwan_bank')">Êèê</button>
                            <button class="btn-bank btn-bubble" onclick="openBankHistory('taiwan_bank')">ÊòéÁ¥∞</button>
                        </div>
                    </div>
                </div>
                <div class="account-item" style="border-bottom:none;">
                    <div class="acc-name">üìâ Ê∞∏Ë±êË≠âÂà∏</div>
                    <div class="acc-right">
                        <div id="sinopac-balance" class="acc-val">$0</div>
                        <div class="btn-group">
                            <button class="btn-bank btn-bubble" onclick="openBankInput('deposit', 'sinopac')">Â≠ò</button>
                            <button class="btn-bank btn-bubble" onclick="openBankInput('withdraw', 'sinopac')">Êèê</button>
                            <button class="btn-bank btn-bubble" onclick="openBankHistory('sinopac')">ÊòéÁ¥∞</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div style="text-align:center; padding-top:10px;">
                    <div class="month-nav-container">
                        <button class="month-nav-btn btn-bubble" onclick="changeMonth(-1)">‚Äπ</button>
                        <div id="stats-month-display" class="month-label">--</div>
                        <button class="month-nav-btn btn-bubble" onclick="changeMonth(1)">‚Ä∫</button>
                    </div>
                    
                    <div class="est-income-val">$<span id="month-est">0</span></div>
                    <div id="month-total">$0</div>
                    <!-- V335: Total Hours Display -->
                    <div id="month-hours-display">Total: 0 hrs</div>
                </div>
                <div id="all-logs" style="margin-top:20px; border-top:1px dashed #EEE; padding-top:10px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">Êñ∞Â¢ûÂ≠∏Áîü</h3>
        
        <div class="color-picker" id="new-color-picker">
            <div class="color-opt selected" style="background:#D58694;" onclick="selectColor('#D58694', this)"></div> 
            <div class="color-opt" style="background:#E2B268;" onclick="selectColor('#E2B268', this)"></div> 
            <div class="color-opt" style="background:#81B29A;" onclick="selectColor('#81B29A', this)"></div> 
            <div class="color-opt" style="background:#5E7C8D;" onclick="selectColor('#5E7C8D', this)"></div> 
            <div class="color-opt" style="background:#9B8EA9;" onclick="selectColor('#9B8EA9', this)"></div> 
        </div>
        <input type="hidden" id="new-color-val" value="#D58694">

        <div class="setup-group">
            <div class="setup-label">ÂßìÂêç</div>
            <input id="new-name" placeholder="Ëº∏ÂÖ•ÂßìÂêç">
        </div>

        <div class="setup-group">
            <div class="setup-label">ÊôÇËñ™</div>
            <div class="vertical-stack">
                <input type="number" id="new-rate" placeholder="$" inputmode="decimal">
                <div class="btn-options">
                    <div class="opt-btn" onclick="setInputValue('new-rate', 650, this)">650</div>
                    <div class="opt-btn" onclick="setInputValue('new-rate', 750, this)">750</div>
                    <div class="opt-btn" onclick="setInputValue('new-rate', 800, this)">800</div>
                    <div class="opt-btn" onclick="setInputValue('new-rate', 1000, this)">1000</div>
                </div>
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">Âπ¥Á¥ö</div>
            <div class="btn-options" style="flex-wrap: nowrap; overflow-x: auto;">
                <div class="opt-btn" onclick="selectOptionGroup('new-grade', 'ÂúãÂ∞è', this)">ÂúãÂ∞è</div>
                <div class="opt-btn" onclick="selectOptionGroup('new-grade', 'Âúã‰∏Ä', this)">Âúã‰∏Ä</div>
                <div class="opt-btn" onclick="selectOptionGroup('new-grade', 'Âúã‰∫å', this)">Âúã‰∫å</div>
                <div class="opt-btn" onclick="selectOptionGroup('new-grade', 'Âúã‰∏â', this)">Âúã‰∏â</div>
            </div>
            <input type="hidden" id="new-grade">
        </div>
        
        <input type="hidden" id="new-subject-def" value="">
        
        <button onclick="addStudent()" class="modal-btn btn-confirm btn-bubble">Á¢∫Ë™çÊñ∞Â¢û</button>
        <button onclick="closeModal('setup-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<!-- V328: New Day Detail Modal -->
<div id="calendar-day-modal" class="modal">
    <div class="modal-content" style="height:60vh; display:flex; flex-direction:column;">
        <!-- V335: Day Navigation -->
        <h3 class="modal-title" style="display:flex; justify-content:center; align-items:center; gap:15px;">
            <button class="cal-nav-btn" onclick="changeDayInModal(-1)">‚Äπ</button>
            <span id="cal-day-title"></span>
            <button class="cal-nav-btn" onclick="changeDayInModal(1)">‚Ä∫</button>
        </h3>
        <div id="cal-day-list" style="overflow-y:auto; flex:1; padding-bottom:10px;"></div>
        <button onclick="closeModal('calendar-day-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button>
    </div>
</div>

<!-- V339: Student Profile Modal (Fix: Close Button & Layout) -->
<div id="student-profile-modal" class="modal" style="z-index:9200;">
    <div class="modal-content" style="padding:0; max-height:85vh; overflow-y:auto; background:#F7F6F2;">
        
        <div class="profile-header-bg">
            <div class="profile-avatar-large" id="profile-modal-avatar">üòä</div>
            <div class="profile-name-large" id="profile-modal-name">Student</div>
            <div style="font-size:14px; opacity:0.8; margin-top:5px;" id="profile-modal-grade">Grade</div>
            <!-- Fix: display:flex -->
            <div class="delete-x" style="display:flex; top:20px; right:20px; background:rgba(255,255,255,0.2); cursor:pointer;" onclick="closeModal('student-profile-modal')">‚úï</div>
        </div>

        <div class="profile-tabs">
            <button class="tab-btn active btn-bubble" onclick="switchProfileTab('exam')">üìà ÊàêÁ∏æËøΩËπ§</button>
            <button class="tab-btn btn-bubble" onclick="switchProfileTab('note')">üìù Â≠∏ÁøíÁ≠ÜË®ò</button>
            <button class="tab-btn btn-bubble" onclick="switchProfileTab('info')">‚öôÔ∏è Ë®≠ÂÆö</button>
        </div>

        <div style="padding: 0 20px 20px 20px;">
            <!-- Tab 1: Exams -->
            <div id="tab-exam" class="profile-section active">
                <div class="chart-container" id="exam-chart-area">
                    (ÊàêÁ∏æÊäòÁ∑öÂúñÂ∞áÈ°ØÁ§∫ÊñºÊ≠§)
                </div>
                <div id="exam-list-area"></div>
                <button class="modal-btn btn-confirm btn-bubble" style="margin-top:10px;" onclick="addNewExamTerm()">+ Êñ∞Â¢ûÂ≠∏ÊúüÊàêÁ∏æ</button>
            </div>

            <!-- Tab 2: Notes -->
            <div id="tab-note" class="profile-section">
                <div class="setup-group">
                    <div class="setup-label">Âº∑È†Ö (Strengths)</div>
                    <textarea class="inline-note" style="background:#FFF; color:#333; border:2px solid #E2E8F0;" id="profile-strength" placeholder="‰æãÂ¶ÇÔºöË®àÁÆóÈÄüÂ∫¶Âø´..."></textarea>
                </div>
                <div class="setup-group">
                    <div class="setup-label">Âº±È†Ö (Weaknesses)</div>
                    <textarea class="inline-note" style="background:#FFF; color:#333; border:2px solid #E2E8F0;" id="profile-weakness" placeholder="‰æãÂ¶ÇÔºöÊáâÁî®È°åÂÆπÊòìÂç°Èóú..."></textarea>
                </div>
                <div class="setup-group">
                    <div class="setup-label">Áµ¶ÂÆ∂Èï∑ÁöÑÂÇôË®ª</div>
                    <textarea class="inline-note" style="background:#FFF; color:#333; border:2px solid #E2E8F0;" id="profile-memo" placeholder="Á¥ÄÈåÑÂÆ∂Èï∑ÁâπÂà•‰∫§‰ª£ÁöÑ..."></textarea>
                </div>
                <button class="modal-btn btn-confirm btn-bubble" onclick="saveStudentProfile()">ÂÑ≤Â≠òÁ≠ÜË®ò</button>
            </div>

            <!-- Tab 3: Info -->
            <div id="tab-info" class="profile-section">
                <div class="setup-group">
                    <div class="setup-label">Âπ¥Á¥ö</div>
                    <div class="btn-options" id="profile-grade-opt">
                        <div class="opt-btn" onclick="selectOptionGroup('profile-edit-grade', 'ÂúãÂ∞è', this)">ÂúãÂ∞è</div>
                        <div class="opt-btn" onclick="selectOptionGroup('profile-edit-grade', 'Âúã‰∏Ä', this)">Âúã‰∏Ä</div>
                        <div class="opt-btn" onclick="selectOptionGroup('profile-edit-grade', 'Âúã‰∫å', this)">Âúã‰∫å</div>
                        <div class="opt-btn" onclick="selectOptionGroup('profile-edit-grade', 'Âúã‰∏â', this)">Âúã‰∏â</div>
                    </div>
                    <input type="hidden" id="profile-edit-grade">
                </div>
                <div class="setup-group">
                    <div class="setup-label">ÁõÆÂâçÊôÇËñ™</div>
                    <input type="number" id="profile-edit-rate">
                </div>
                <button class="modal-btn btn-confirm btn-bubble" onclick="saveStudentProfile()">Êõ¥Êñ∞Ë≥áÊñô</button>
            </div>
        </div>

        <!-- Fix: Bottom Close Button -->
        <div style="padding: 0 20px 20px 20px;">
            <button onclick="closeModal('student-profile-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button>
        </div>
    </div>
</div>

<div id="log-modal" class="modal">
    <div class="modal-content">
        <h3 id="log-name-display" class="modal-title">ÊéíË™≤Ë®≠ÂÆö</h3>
        
        <div class="setup-group">
            <div class="setup-label">ÊôÇÊï∏</div>
            <div class="vertical-stack">
                <input type="number" id="log-hours" placeholder="hr" inputmode="decimal">
                <div class="btn-options">
                    <div class="opt-btn" onclick="setInputValue('log-hours', 1.5, this)">1.5</div>
                    <div class="opt-btn" onclick="setInputValue('log-hours', 2.0, this)">2.0</div>
                    <div class="opt-btn" onclick="setInputValue('log-hours', 2.5, this)">2.5</div>
                    <div class="opt-btn" onclick="setInputValue('log-hours', 3.0, this)">3.0</div>
                </div>
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÁßëÁõÆ</div>
            <div class="btn-options" id="log-subject-group">
                <div class="opt-btn" onclick="selectOptionGroup('log-subject', 'Êï∏Â≠∏', this)">Êï∏Â≠∏</div>
                <div class="opt-btn" onclick="selectOptionGroup('log-subject', 'Ëã±Êñá', this)">Ëã±Êñá</div>
                <div class="opt-btn" onclick="selectOptionGroup('log-subject', 'ÁêÜÂåñ', this)">ÁêÜÂåñ</div>
                <div class="opt-btn" onclick="selectOptionGroup('log-subject', 'ÁîüÁâ©', this)">ÁîüÁâ©</div>
            </div>
            <input type="hidden" id="log-subject">
        </div>

        <div class="setup-group">
            <div class="setup-label">ÊôÇÈñìËàáÊó•Êúü</div>
            <div class="vertical-stack">
                <input type="time" id="log-time" style="width:100%;">
                <div class="date-row">
                    <div class="date-input-wrapper">
                        <input type="date" id="log-date">
                    </div>
                    <button onclick="addDateTag()" class="add-date-btn btn-bubble">+</button>
                </div>
            </div>
            <div id="date-tags" class="tag-container" style="margin-top:10px;"></div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÂÇôË®ª</div>
            <textarea id="log-content-modal" placeholder="ÂÇôË®ª..." style="height:70px;"></textarea>
        </div>
        
        <button onclick="saveBatchPlan()" class="modal-btn btn-confirm btn-bubble">ÂÑ≤Â≠òË°åÁ®ã</button>
        <button onclick="closeModal('log-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<!-- V337: Add Exam Modal -->
<div id="add-exam-modal" class="modal" style="z-index: 9300;">
    <div class="modal-content">
        <h3 class="modal-title">Êñ∞Â¢ûËÄÉË©¶Á¥ÄÈåÑ</h3>
        
        <div class="setup-group">
            <div class="setup-label">ËÄÉË©¶ÂêçÁ®±</div>
            <input id="exam-term-input" placeholder="‰æãÂ¶ÇÔºöÁ¨¨‰∏ÄÊ¨°ÊÆµËÄÉ" value="Á¨¨‰∏ÄÊ¨°ÊÆµËÄÉ">
        </div>
        
        <div class="setup-group">
            <div class="setup-label">ÂêÑÁßëÂàÜÊï∏ (Êú™ËÄÉÂèØÁïôÁ©∫)</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="vertical-stack">
                    <label class="score-label">Êï∏Â≠∏ (Math)</label>
                    <input type="number" id="score-math" class="score-input" placeholder="-">
                </div>
                <div class="vertical-stack">
                    <label class="score-label">Ëã±Êñá (Eng)</label>
                    <input type="number" id="score-eng" class="score-input" placeholder="-">
                </div>
                <div class="vertical-stack">
                    <label class="score-label">ÂúãÊñá (Chi)</label>
                    <input type="number" id="score-chi" class="score-input" placeholder="-">
                </div>
                <div class="vertical-stack">
                    <label class="score-label">Ëá™ÁÑ∂ (Sci)</label>
                    <input type="number" id="score-sci" class="score-input" placeholder="-">
                </div>
            </div>
        </div>

        <button onclick="saveNewExam()" class="modal-btn btn-confirm btn-bubble">ÂÑ≤Â≠òÊàêÁ∏æ</button>
        <button onclick="closeModal('add-exam-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<div id="edit-log-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">‰øÆÊîπË™≤Á®ã</h3>
        <input type="hidden" id="edit-log-ts">
        
        <div class="setup-group">
            <div class="setup-label">Êó•ÊúüËàáÊôÇÈñì</div>
            <div class="vertical-stack">
                 <input type="time" id="edit-log-time">
                 <input type="date" id="edit-log-date">
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÊôÇÊï∏</div>
            <div class="vertical-stack">
                <input type="number" id="edit-log-hours" inputmode="decimal">
                <div class="btn-options">
                    <div class="opt-btn" onclick="setInputValue('edit-log-hours', 1.5, this)">1.5</div>
                    <div class="opt-btn" onclick="setInputValue('edit-log-hours', 2.0, this)">2.0</div>
                    <div class="opt-btn" onclick="setInputValue('edit-log-hours', 2.5, this)">2.5</div>
                    <div class="opt-btn" onclick="setInputValue('edit-log-hours', 3.0, this)">3.0</div>
                </div>
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÁßëÁõÆ</div>
            <div class="vertical-stack">
                <input type="text" id="edit-log-subject">
                <div class="btn-options" id="edit-subject-group">
                    <div class="opt-btn" onclick="selectOptionGroup('edit-log-subject', 'Êï∏Â≠∏', this)">Êï∏Â≠∏</div>
                    <div class="opt-btn" onclick="selectOptionGroup('edit-log-subject', 'Ëã±Êñá', this)">Ëã±Êñá</div>
                    <div class="opt-btn" onclick="selectOptionGroup('edit-log-subject', 'ÁêÜÂåñ', this)">ÁêÜÂåñ</div>
                    <div class="opt-btn" onclick="selectOptionGroup('edit-log-subject', 'ÁîüÁâ©', this)">ÁîüÁâ©</div>
                </div>
            </div>
        </div>

        <div class="setup-group">
            <div class="setup-label">ÂÇôË®ª</div>
            <textarea id="edit-log-content" style="height:70px;"></textarea>
        </div>

        <button onclick="saveEditedLog()" class="modal-btn btn-confirm btn-bubble">‰øùÂ≠ò‰øÆÊîπ</button>
        <button onclick="closeModal('edit-log-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<div id="bank-input-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title" id="bank-title">Â≠òÂÖ•</h3>
        <div class="setup-group">
            <div class="setup-label">Êó•Êúü</div>
            <input type="date" id="bank-date" style="text-align:center;">
        </div>
        <div class="setup-group" style="margin-top:20px;">
             <div class="setup-label">ÈáëÈ°ç</div>
             <input id="bank-amount" type="number" inputmode="decimal" placeholder="$0">
        </div>
        <button onclick="submitBankTransaction()" class="modal-btn btn-confirm btn-bubble">Á¢∫Ë™ç</button>
        <button onclick="closeModal('bank-input-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<div id="bank-history-modal" class="modal"><div class="modal-content" style="height:60vh; display:flex; flex-direction:column;"><h3 class="modal-title">‰∫§ÊòìÊòéÁ¥∞</h3><div id="bank-history-list" style="overflow-y:auto; flex:1;"></div><button onclick="closeModal('bank-history-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button></div></div>
<div id="all-schedule-modal" class="modal"><div class="modal-content" style="height:70vh; display:flex; flex-direction:column;"><h3 class="modal-title">Ê≠∑Âè≤Á¥ÄÈåÑ</h3><div id="all-schedule-list" style="overflow-y:auto; flex:1;"></div><button onclick="closeModal('all-schedule-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button></div></div>
<div id="settlement-modal" class="modal"><div class="modal-content"><h3 class="modal-title">ÁµêÁÆó</h3><div style="text-align:center; font-size:36px; font-weight:800; margin-bottom:20px; color:var(--text-main);" id="settlement-timer-display">00:00:00</div>
    <div class="setup-label">ÊôÇÊï∏</div>
    <div class="vertical-stack" style="margin-bottom:15px;">
        <input id="settlement-manual-hours" type="number" inputmode="decimal" placeholder="Á¢∫Ë™çÊôÇÊï∏">
        <div class="btn-options"><div class="opt-btn" onclick="setInputValue('settlement-manual-hours', 1.5, this)">1.5</div><div class="opt-btn" onclick="setInputValue('settlement-manual-hours', 2.0, this)">2.0</div><div class="opt-btn" onclick="setInputValue('settlement-manual-hours', 2.5, this)">2.5</div></div>
    </div>
    <button onclick="confirmSettlement()" class="modal-btn btn-confirm btn-bubble">Á¢∫Ë™ç</button>
    <button onclick="closeModal('settlement-modal')" class="modal-btn btn-cancel">ËøîÂõû</button>
</div></div>

<div id="student-history-modal" class="modal"><div class="modal-content modal-stats-content"><h3 id="stu-history-name" class="modal-title"></h3><div style="text-align:center; font-size:36px; font-weight:900; color:var(--accent-primary); margin-bottom:20px;" id="stu-history-total">$0</div><div id="stu-history-list" style="flex:1; overflow-y:auto; margin-bottom:10px; border-top:1px solid #EEE; padding-top:10px;"></div><button id="btn-delete-all-logs" class="modal-btn btn-delete-all btn-bubble" style="background:#FED7D7; color:#E53E3E; margin-top:10px;">üóë Âà™Èô§Êú¨ÊúàÊâÄÊúâÁ¥ÄÈåÑ</button><button onclick="closeModal('student-history-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button></div></div>

<!-- V301: Export Calendar Modal -->
<div id="export-calendar-modal" class="modal">
    <div class="modal-content" style="height:70vh; display:flex; flex-direction:column;">
        <h3 class="modal-title">ÂåØÂá∫Ë°å‰∫ãÊõÜ</h3>
        <!-- V311: Better Select All Buttons -->
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; gap:12px;">
             <button class="btn-pill-gray" onclick="toggleAllExport(true)">ÂÖ®ÈÅ∏</button>
             <button class="btn-pill-gray" onclick="toggleAllExport(false)">ÂèñÊ∂àÂÖ®ÈÅ∏</button>
        </div>
        <div id="export-list" style="overflow-y:auto; flex:1; border:1px solid #EEE; border-radius:16px; padding:5px;"></div>
        <button onclick="performExport()" class="modal-btn btn-confirm btn-bubble">ÂåØÂá∫ÈÅ∏ÂèñÈ†ÖÁõÆ (.ics)</button>
        <button onclick="closeModal('export-calendar-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<!-- V302: Settle Confirm Modal -->
<div id="settle-confirm-modal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">ÁµêÁÆóÁ¢∫Ë™ç</h3>
        <div style="text-align:center; font-weight:700; color:var(--text-main); margin-bottom:15px; font-size:18px;">‰∏äÂÆåË™≤‰∫ÜÂóéÔºü</div>
        <div class="settle-info-box">
            <div id="settle-confirm-name" class="settle-info-big"></div>
            <div id="settle-confirm-detail" class="settle-info-sub"></div>
        </div>
        <div style="text-align:center; color:#E53E3E; font-size:13px; font-weight:700; margin-bottom:20px;">‚ö†Ô∏è ÁµêÁÆóÂæåÂ∞áÈéñÂÆöÁ∑®ËºØ</div>
        <input type="hidden" id="settle-target-ts">
        <button onclick="performSettle()" class="modal-btn btn-confirm btn-bubble">Á¢∫Ë™çÁµêÁÆó (Êú™Êî∂Ê¨æ)</button>
        <button onclick="closeModal('settle-confirm-modal')" class="modal-btn btn-cancel">ÂèñÊ∂à</button>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content" style="max-height:80vh; overflow-y:auto;">
        <h3 class="modal-title">ÂøÉÊÉÖÊó•Ë®ò</h3>
        <input type="file" id="avatar-upload" style="display:none" onchange="handleAvatarUpload(this)">
        <div class="sidebar-avatar" id="profile-avatar" onclick="triggerUpload()" style="margin-bottom:10px; margin-left:auto; margin-right:auto;">üß∏</div>
        <div style="text-align:center; margin-bottom:15px; color:#999; font-size:12px;">ÈªûÊìäÈ†≠ÂÉèÊõ¥ÊèõÁÖßÁâá</div>
        <textarea id="mood-input" placeholder="‰ªäÂ§©ÁôºÁîü‰∫Ü‰ªÄÈ∫ºÂ•ΩÁé©ÁöÑ‰∫ãÔºü" style="height:80px;"></textarea>
        <button onclick="saveMood()" class="modal-btn btn-confirm btn-bubble">Ë®òÈåÑÂøÉÊÉÖ</button>
        <div id="mood-list" style="margin-top:20px; max-height:200px; overflow-y:auto;"></div>
        <button onclick="closeModal('profile-modal')" class="modal-btn btn-cancel">ÈóúÈñâ</button>
    </div>
</div>

<script>
    const DB_STU = 'tutor_v10_students';
    const DB_LOG = 'tutor_v15_logs';
    const DB_BANK = 'tutor_v27_bank';
    const DB_PROF = 'tutor_v33_profile'; 

    let currentPlanningStuIdx = null, selectedDates = [], currentPage = 0;
    let currentBankAction = 'deposit', currentAccountId = 'taiwan_bank';
    let viewDate = new Date();
    viewDate.setDate(1); 
    
    // Calendar Variables
    let calViewDate = new Date();
    let isCalendarView = false;
    
    // [Êñ∞Â¢û] Áî®‰æÜÂà§Êñ∑ÊòØÂê¶Ëß∏ÁôºÈï∑ÊåâÁöÑËÆäÊï∏
    let isLongPress = false; 

    let settlingLogTs = null;
    let currentStatsStudent = null;

    // V301: Swipe Variables
    let pageTouchStartX = 0;
    let pageTouchStartY = 0;
    let longPressTimer; // V326: Timer variable

    function safeLoad(key, defaultVal) {
        try { return JSON.parse(localStorage.getItem(key)) || defaultVal; } 
        catch (e) { console.error("Data Reset:", key); return defaultVal; }
    }

    window.students = safeLoad(DB_STU, []);
    window.logs = safeLoad(DB_LOG, []);
    window.bankLogs = safeLoad(DB_BANK, []);
    let profileData = safeLoad(DB_PROF, { avatar: 'üß∏', moods: [], name: 'Tutor' });

    window.onload = function() {
        renderStudents();
        renderSchedule();
        updateAssets();
        updateProfileDisplay();
        
        setInterval(updateRunningTimers, 1000);

        document.addEventListener('click', (e) => {
            // Â¶ÇÊûúÈªûÊìäÁöÑÂú∞Êñπ‰∏çÊòØÂ≠∏ÁîüÈ†≠ÂÉèÔºå‰∏îÁõÆÂâçÊòØÁ∑®ËºØÊ®°ÂºèÔºåÂ∞±Ëß£Èô§
            if(!e.target.closest('.student-wrapper') && !e.target.closest('.delete-x')) {
                exitEditMode();
            }
            if(!e.target.closest('.swipe-content')) {
                closeAllSwipes();
            }
        });
               // V301: Initialize Page Swipe Listeners
        const viewport = document.getElementById('main-viewport');
        viewport.addEventListener('touchstart', handlePageTouchStart, {passive: true});
        viewport.addEventListener('touchend', handlePageTouchEnd, {passive: true});
        
        // V303: Splash Screen Fade Out
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.classList.add('hidden');
        }, 1000); // 1 second delay
    };

    // V331: iOS-style Delete Mode Logic
    let isEditMode = false; // Ê®ôË®òÊòØÂê¶ËôïÊñºÁ∑®ËºØ(ÊäñÂãï)Ê®°Âºè

    function startLongPress() {
        if (isEditMode) return; // Â∑≤Á∂ìÂú®Á∑®ËºØÊ®°ÂºèÂ∞±‰∏çÁî®ÂÜçË®àÊôÇ‰∫Ü
        
        longPressTimer = setTimeout(() => {
            // Vibrate if supported
            if (navigator.vibrate) navigator.vibrate(50);
            
            // Ëß∏ÁôºÂÖ®ÂüüÁ∑®ËºØÊ®°Âºè
            isEditMode = true;
            isLongPress = true; // Ê®ôË®òÈÄôÊ¨°ÈªûÊìäÊòØÈï∑ÊåâËß∏ÁôºÁöÑÔºåÈÅøÂÖçËß∏Áôº click
            document.getElementById('student-scroll').classList.add('edit-mode');
        }, 800);
    }
    
    function cancelLongPress() {
        // Âè™ÊúâÂú®ÈÇÑÊ≤íÈÄ≤ÂÖ•Á∑®ËºØÊ®°ÂºèÂâçÔºåÊâãÊåáÊîæÈñãÊâçÈúÄË¶ÅÊ∏ÖÈô§Ë®àÊôÇÂô®
        // Â¶ÇÊûúÂ∑≤Á∂ìÈÄ≤ÂÖ•Á∑®ËºØÊ®°ÂºèÔºåÊâãÊåáÊîæÈñã‰∏çÊáâË©≤ÂèñÊ∂àÊ®°Âºè
        clearTimeout(longPressTimer); 
    }

    // ÈªûÊìäÁ©∫ÁôΩËôïÂèñÊ∂àÁ∑®ËºØÊ®°Âºè (ÈÄôÈÉ®ÂàÜÂéüÊú¨Â∞±Âú® window.onload ÁöÑ listener Ë£°ÔºåÈÄôË£°Âä†Âº∑Âà§Êñ∑)
    function exitEditMode() {
        if (isEditMode) {
            isEditMode = false;
            document.getElementById('student-scroll').classList.remove('edit-mode');
        }
    }

    function renderStudents() { 
        const div = document.getElementById('student-scroll'); 
        // ‰øùÊåÅ edit-mode ÁãÄÊÖãÔºåÈÅøÂÖçÈáçÊñ∞Ê∏≤ÊüìÂæåÊäñÂãïÊ∂àÂ§±
        if(isEditMode) div.classList.add('edit-mode');
        else div.classList.remove('edit-mode');

        div.innerHTML = window.students.map((s, idx) => `
            <div class="student-wrapper" 
                 onclick="openBatchPlanModal(${idx})" 
                 onmousedown="startLongPress()" 
                 ontouchstart="startLongPress()"
                 onmouseup="cancelLongPress()"
                 onmouseleave="cancelLongPress()"
                 ontouchend="cancelLongPress()">
                <div class="student-chip" style="background:${s.color || '#FFF'}; border-color:${s.color || '#FFF'}">${s.name[0]}</div>
                <div class="delete-x" onclick="event.stopPropagation(); deleteStudent(${idx})">√ó</div>
                <div class="chip-name">${s.name}</div>
            </div>
        `).join(''); 
    }  
    // V301: Page Swipe Logic
    function handlePageTouchStart(e) {
        if(e.target.closest('.swipe-content')) return;
        if(e.target.closest('.student-scroll')) return;
        pageTouchStartX = e.touches[0].clientX;
        pageTouchStartY = e.touches[0].clientY;
    }

    function handlePageTouchEnd(e) {
        if(!pageTouchStartX) return;
        if(isDragging) return;

        const diffX = e.changedTouches[0].clientX - pageTouchStartX;
        const diffY = e.changedTouches[0].clientY - pageTouchStartY;
        
        if(Math.abs(diffX) > 60 && Math.abs(diffX) > Math.abs(diffY)) {
            if(diffX < 0) { // Swipe Left -> Next Page
                if(currentPage === 0) switchTab(1);
            } else { // Swipe Right -> Prev Page
                if(currentPage === 1) switchTab(0);
            }
        }
        pageTouchStartX = 0;
        pageTouchStartY = 0;
    }

    function hardReset() {
        if(confirm("Ë≠¶ÂëäÔºöÈÄôÂ∞áÂà™Èô§ÊâÄÊúâË≥áÊñô‰∏¶ÈáçÁΩÆÁ≥ªÁµ±„ÄÇÁ¢∫ÂÆöÂóéÔºü")) {
            localStorage.clear();
            location.reload();
        }
    }

    function switchTab(idx) {
        currentPage = idx;
        const slider = document.getElementById('page-slider');
        const titles = ["ÊéíË™≤Á≥ªÁµ±", "Ë≥áÁî¢Â†±Ë°®"];
        document.getElementById('header-title').innerText = titles[idx];
        slider.style.transform = `translateX(-${idx * 100}vw)`;
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => d.classList.toggle('active', i === idx));
        if(idx === 1) {
            updateAssets();
        }
        
        const sb = document.getElementById('sidebar');
        if(sb.classList.contains('active')) {
            toggleSidebar();
        }
    }

    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebar-overlay');
        const active = sb.classList.contains('active');
        if(active) {
            sb.classList.remove('active');
            ov.style.display = 'none';
        } else {
            sb.classList.add('active');
            ov.style.display = 'block';
        }
    }
    
    function openModalWithAnim(id) {
        const modal = document.getElementById(id);
        modal.style.display = 'flex';
        if(id === 'profile-modal') {
             renderMoods();
        }
        setTimeout(() => modal.classList.add('active'), 10);
    }
    
    function closeModal(id) {
        const modal = document.getElementById(id);
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function openSetupModal() { openModalWithAnim('setup-modal'); }
    function openProfileModal() { openModalWithAnim('profile-modal'); }
    
    function openBankInput(t, id) { 
        currentBankAction=t; 
        currentAccountId=id; 
        document.getElementById('bank-title').innerText = t === 'deposit' ? 'Â≠òÂÖ•' : 'ÊèêÈ†ò'; 
        
        const now = new Date(); 
        const y = now.getFullYear(); 
        const m = String(now.getMonth()+1).padStart(2,'0'); 
        const d = String(now.getDate()).padStart(2,'0'); 
        
        document.getElementById('bank-date').value = `${y}-${m}-${d}`; 
        document.getElementById('bank-amount').value = ''; 
        
        openModalWithAnim('bank-input-modal'); 
    }
    
    function submitBankTransaction() { 
        const amt = parseInt(document.getElementById('bank-amount').value); 
        const date = document.getElementById('bank-date').value; 
        
        if(!isNaN(amt) && date) { 
            window.bankLogs.push({
                ts: Date.now(), 
                amount: amt, 
                type: currentBankAction, 
                accountId: currentAccountId, 
                date: date
            }); 
            localStorage.setItem(DB_BANK, JSON.stringify(window.bankLogs)); 
            closeModal('bank-input-modal'); 
            updateAssets(); 
        } else {
            alert("Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°ç");
        }
    }
    
    function openBankHistory(id) { 
        const sortedLogs = window.bankLogs.filter(b => b.accountId === id).sort((a,b) => new Date(b.date) - new Date(a.date)); 
        const listDiv = document.getElementById('bank-history-list');
        
        if(sortedLogs.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ÁÑ°‰∫§ÊòìÁ¥ÄÈåÑ</div>';
        } else {
            listDiv.innerHTML = sortedLogs.map(b => `
                <div class="trans-item">
                    <div class="trans-date">${b.date}</div>
                    <div class="trans-amount" style="color:${b.type==='deposit'?'var(--money-green)':'var(--money-red)'}">
                        ${b.type==='deposit'?'+':'-'}$${b.amount}
                    </div>
                </div>`).join('');
        }
        openModalWithAnim('bank-history-modal'); 
    }
    
    function changeMonth(d) {
        viewDate.setMonth(viewDate.getMonth() + d);
        updateAssets();
    }

    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = "$" + Math.floor(progress * (end - start) + start).toLocaleString();
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    function updateAssets() {
        let tw = 100000; 
        let sp = 13107;
        
        if(window.bankLogs) {
            window.bankLogs.forEach(b => {
                const amt = parseInt(b.amount);
                if(!isNaN(amt)) {
                    if(b.accountId === 'taiwan_bank') {
                        tw += (b.type === 'deposit' ? amt : -amt);
                    } else {
                        sp += (b.type === 'deposit' ? amt : -amt);
                    }
                }
            });
        }
        
        let mTotal = 0; 
        let estTotal = 0; 
        let totalHours = 0; // V335: Total Hours
        const y = viewDate.getFullYear();
        const m = String(viewDate.getMonth() + 1).padStart(2, '0');
        const ym = `${y}-${m}`;

        const histDiv = document.getElementById('all-logs');
        histDiv.innerHTML = '';
        
        const monthlyLogs = window.logs.filter(l => l.date && l.date.startsWith(ym)).sort((a,b) => new Date(b.date) - new Date(a.date));
        
        if(monthlyLogs.length === 0) {
             histDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#AAA;">Êú¨ÊúàÁÑ°Ë™≤Á®ãÁ¥ÄÈåÑ</div>';
        } else {
            monthlyLogs.forEach(l => {
                 const income = parseInt(l.income || Math.round(l.hours * l.rate));
                 
                 // V335: Accumulate Hours
                 if(['paid', 'unpaid', 'prepared', 'running'].includes(l.status)) {
                    estTotal += income;
                    totalHours += parseFloat(l.hours || 0);
                 }
                 if(l.status === 'paid') mTotal += income;

                 const dObj = new Date(l.date);
                 const dayName = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'][dObj.getDay()];
                 const dayStr = l.date.split('-')[2];
                 
                 const stu = window.students.find(s => s.name === l.name);
                 let color = stu ? stu.color : '#2D3748';

                 if(l.status === 'paid') color = 'var(--money-green)';
                 if(l.status === 'unpaid') color = 'var(--accent-primary)';
                 if(l.status === 'running') color = '#C95D4E';

                 const dateHTML = `<div class="date-num">${dayStr}</div><div class="date-week">${dayName}</div>`;
                 histDiv.innerHTML += generateSwipeItem(l, dateHTML, color, income, null, true); 
            });
        }

        const finalTotal = tw + sp;
        animateValue(document.getElementById('total-assets-val'), 0, finalTotal, 800);

        document.getElementById('taiwan-bank-balance').innerText = "$" + tw.toLocaleString();
        document.getElementById('sinopac-balance').innerText = "$" + sp.toLocaleString();
        document.getElementById('stats-month-display').innerText = `${y}Âπ¥ ${parseInt(m)}Êúà`; 
        document.getElementById('month-total').innerText = "$" + mTotal.toLocaleString();
        document.getElementById('month-est').innerText = estTotal.toLocaleString();
        // V335: Update Total Hours Display
        document.getElementById('month-hours-display').innerText = `Total: ${totalHours} hrs`;
    }
    
    function openAllScheduleModal(autoExpandKey = null) { 
        const list = document.getElementById('all-schedule-list'); 
        list.innerHTML = ''; 
        const groups = {}; 
        
        window.logs.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(l => { 
            const d = new Date(l.date); 
            const k = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`; 
            if(!groups[k]) groups[k] = []; 
            groups[k].push(l); 
        }); 

        if(Object.keys(groups).length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:20px;color:#999">ÁÑ°Ê≠∑Âè≤Á¥ÄÈåÑ</div>'; 
        } else {
            for(let [month, items] of Object.entries(groups)) { 
                const total = items.reduce((s, x) => s + (x.status === 'paid' ? (parseInt(x.income)||0) : 0), 0); 
                
                const header = document.createElement('div'); 
                header.className = 'month-group-header'; 
                header.innerHTML = `<span>${month}</span><span>$${total.toLocaleString()} ‚ñº</span>`; 
                header.onclick = function() { toggleMonthView(this); }; 
                
                const container = document.createElement('div'); 
                container.className = 'month-logs'; 
                
                if(autoExpandKey && month === autoExpandKey) {
                    container.classList.add('active'); 
                } 

                const currentYM = items[0].date.slice(0, 7); 
                container.innerHTML = items.map(l => { 
                    const dObj = new Date(l.date); 
                    const dayName = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'][dObj.getDay()]; 
                    const dayStr = l.date.split('-')[2]; 
                    const dateHTML = `<div class="date-num">${dayStr}</div><div class="date-week">${dayName}</div>`;
                    let color = '#AAA'; 
                    if(l.status === 'paid') color = 'var(--money-green)';
                    if(l.status === 'unpaid') color = 'var(--accent-primary)';
                    const income = l.income; 
                    return generateSwipeItem(l, dateHTML, color, income, currentYM); 
                }).join(''); 
                
                list.appendChild(header); 
                list.appendChild(container); 
            }
        }
        openModalWithAnim('all-schedule-modal'); 
    }
    
    function toggleMonthView(header) {
        const content = header.nextElementSibling;
        content.classList.toggle('active');
        const arrow = header.querySelector('span:last-child');
        if(content.classList.contains('active')) {
             arrow.innerText = arrow.innerText.replace('‚ñº', '‚ñ≤');
        } else {
             arrow.innerText = arrow.innerText.replace('‚ñ≤', '‚ñº');
        }
    }
    
    function toggleViewMode() {
        isCalendarView = !isCalendarView;
        const btn = document.getElementById('view-toggle');
        const listView = document.getElementById('today-schedule-list');
        const calView = document.getElementById('calendar-container');
        const emptyHint = document.getElementById('empty-schedule-hint');
        
        btn.classList.toggle('active', isCalendarView);
        
        if(isCalendarView) {
            btn.innerHTML = '<span>üìÑ ‰ªäÊó•Ë™≤Âç°</span>';
            listView.style.display = 'none';
            emptyHint.style.display = 'none';
            calView.style.display = 'block';
            renderCalendar();
        } else {
            btn.innerHTML = '<span>üìÖ ÊúàÊõÜ</span>';
            listView.style.display = 'flex';
            calView.style.display = 'none';
            renderSchedule(); 
        }
    }

    function changeCalMonth(d) {
        calViewDate.setMonth(calViewDate.getMonth() + d);
        renderCalendar();
    }

    // [‰øÆÂæ©] Ê∏≤ÊüìÊúàÊõÜ (ÊîπÁî® HTML onclick Á¢∫‰øù‰∫ã‰ª∂Ëß∏Áôº)
   function renderCalendar() {
        const grid = document.getElementById('cal-grid');
        const title = document.getElementById('cal-month-title');
        grid.innerHTML = '';
        
        const y = calViewDate.getFullYear();
        const m = calViewDate.getMonth();
        title.innerText = `${y}Âπ¥ ${m+1}Êúà`;
        
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m+1, 0).getDate();
        
        for(let i=0; i<firstDay; i++) {
            grid.innerHTML += `<div></div>`;
        }
        
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayLogs = window.logs.filter(l => l.date === dateStr);
            const isToday = new Date().toDateString() === new Date(y, m, d).toDateString();
            
            let cellContent = `<span>${d}</span><div style="display:flex;gap:2px;flex-wrap:wrap;justify-content:center;">`;
            let cellClass = `cal-cell ${isToday?'today':''}`;
            
            if(dayLogs.length === 0) {
                cellClass += ' holiday'; 
                cellContent += `<div class="holiday-label">ÂÅá</div>`;
            } else {
                dayLogs.forEach(l => {
                    const dotClass = l.status === 'paid' ? 'cal-dot paid' : 'cal-dot';
                    cellContent += `<div class="${dotClass}"></div>`;
                });
            }
            cellContent += `</div>`;

            // Áõ¥Êé•Â∞á onclick ÂØ´Âú® HTML Â≠ó‰∏≤‰∏≠ÔºåÈÅøÂÖç JS Á∂ÅÂÆöÂ§±Êïà
            const cell = document.createElement('div');
            cell.className = cellClass;
            cell.innerHTML = cellContent;
            cell.onclick = function() {
                openCalendarDayModal(dateStr);
            };
            grid.appendChild(cell);
        }
        
        // [Êñ∞Â¢û] Ê∏≤ÊüìÂÆåÊúàÊõÜÂæåÔºåÂêåÊ≠•Êõ¥Êñ∞‰∏ãÊñπÁöÑÊéíË™≤ÈÄöÁü•ÂàóË°®
        renderMonthlySummary();
    }
    
    // V335: Change Day in Modal
    function changeDayInModal(offset) {
        const titleEl = document.getElementById('cal-day-title');
        if (!titleEl) return;
        const currentStr = titleEl.innerText;
        const current = new Date(currentStr);
        current.setDate(current.getDate() + offset);
        
        const y = current.getFullYear();
        const m = String(current.getMonth() + 1).padStart(2, '0');
        const d = String(current.getDate()).padStart(2, '0');
        const newStr = `${y}-${m}-${d}`;
        
        // If month changed, update background calendar
        if (current.getMonth() !== calViewDate.getMonth()) {
            calViewDate = new Date(current);
            calViewDate.setDate(1); // avoid overflow
            renderCalendar();
        }

        openCalendarDayModal(newStr);
    }

    // [‰øÆÂæ©] ÈñãÂïüÂñÆÊó•Ë©≥ÊÉÖ (Â¢ûÂä†ÈåØË™§‰øùË≠∑)
    function openCalendarDayModal(dateStr) {
        const listDiv = document.getElementById('cal-day-list');
        const title = document.getElementById('cal-day-title');
        title.innerText = dateStr;
        
        const dayLogs = window.logs.filter(l => l.date === dateStr).sort((a,b) => (a.timeStart||'').localeCompare(b.timeStart||''));
        
        if(dayLogs.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#E53E3E; font-weight:700;">üå¥ ‰ªäÊó•‰ºëÂÅá</div>';
        } else {
            listDiv.innerHTML = dayLogs.map(l => {
                let timeDisplay = '--:--';
                // ÂÆâÂÖ®ÁöÑÊôÇÈñìË®àÁÆó
                if (l.timeStart && l.hours) {
                    try {
                        const [h, m] = l.timeStart.split(':').map(Number);
                        const totalMin = h * 60 + m + (parseFloat(l.hours) * 60);
                        const endH = Math.floor(totalMin / 60) % 24;
                        const endM = Math.floor(totalMin % 60);
                        const endTime = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
                        timeDisplay = `${l.timeStart} ‚Äî ${endTime}`;
                    } catch(e) { console.error(e); }
                }
                
                const stu = window.students.find(s => s.name === l.name);
                const gradeStr = stu ? (stu.grade || '') : '';
                const subjectStr = l.subject || '';
                const fullSubject = `${gradeStr}${subjectStr}`;

                return `
                <div class="day-detail-card">
                    <div class="day-detail-left">
                        <div class="day-detail-time">${timeDisplay}</div>
                        <div class="day-detail-info">${l.name} ÔΩú ${fullSubject}</div>
                    </div>
                    <div class="day-detail-right">
                        <button class="btn-modal-action" onclick="openEditLogModal('${l.ts}')">‚úé</button>
                        <button class="btn-modal-action btn-modal-delete" onclick="deleteLog(event, '${l.ts}')">üóë</button>
                    </div>
                </div>
            `;
            }).join('');
        }
        openModalWithAnim('calendar-day-modal');
    }
    function renderSchedule() {
        const div = document.getElementById('today-schedule-list');
        const now = new Date();
        const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        // V303: English Date Display
        const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
        document.getElementById('today-title-display').innerText = now.toLocaleDateString('en-US', dateOptions).toUpperCase();
        
        const todays = window.logs.filter(l => l.date === todayStr).sort((a,b) => (a.timeStart||'').localeCompare(b.timeStart||''));
        
        if(!isCalendarView) {
            document.getElementById('empty-schedule-hint').style.display = todays.length ? 'none' : 'block';
        }
        
        div.innerHTML = todays.map((l, index) => {
            // V315: Dynamic Color Card
            const stu = window.students.find(s => s.name === l.name);
            const cardColor = stu ? stu.color : '#2D3748';
            // V318: Display Grade + Subject
            const fullSubject = stu ? (stu.grade + ' ' + (l.subject || '')) : (l.subject || 'Ë™≤Á®ã');
            
            let paidClass = '';
            let cardStyle = `background-color: ${cardColor}; color: #FFF;`;
            
            if(l.status === 'paid') {
                paidClass = 'paid';
                cardStyle = ''; // Use CSS class for paid
            }

            let timeDisplay = '';
            if (l.timeStart) {
                const [h, m] = l.timeStart.split(':').map(Number);
                const totalMin = h * 60 + m + (parseFloat(l.hours) * 60);
                const endH = Math.floor(totalMin / 60) % 24;
                const endM = Math.floor(totalMin % 60);
                const endTime = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
                timeDisplay = `<div class="sch-time-info">üïí ${l.timeStart} - ${endTime}</div>`;
            }

            const trashBtn = `<button class="btn-trash-card" onclick="deleteLog(event, '${l.ts}')">üóë</button>`;
            
            let costOverlay = '';
            if(l.status !== 'paid') {
                costOverlay = `<div class="sch-cost-overlay">${l.hours}h ‚Ä¢ $${Math.round(l.rate * l.hours)}</div>`;
            } else {
                costOverlay = `<div class="sch-cost-overlay" style="color:var(--money-green); opacity:1;">Â∑≤ÂÖ•Â∏≥ +$${l.income}</div>`;
            }

            let mainAction = '';

            if(l.status === 'running') {
                mainAction = `
                    <div class="timer-display" id="timer-${l.ts}">00:00:00</div>
                    <div class="card-footer">
                        <button class="btn-main-action" style="background:#C95D4E;" onclick="openSettlementModal('${l.ts}')">‚èπ ÁµêÊùü & ÁµêÁÆó</button>
                    </div>`;
            } else if(l.status === 'unpaid') {
                mainAction = `
                    <div class="card-footer">
                        ${trashBtn}
                        <button class="btn-main-action" style="background:var(--money-green);" onclick="markAsPaid(event, '${l.ts}')">üí∞ Á¢∫Ë™çÊî∂Ê¨æ</button>
                    </div>`;
            } else if(l.status === 'paid') {
                mainAction = `<div class="card-footer" style="justify-content:center; color:var(--money-green); font-weight:800;">(Â∑≤ÂÆåÊàê)</div>`;
            } else {
                mainAction = `
                    <div class="card-footer">
                        ${trashBtn}
                        <button class="btn-main-action" style="background:rgba(255, 255, 255, 0.2); color:#FFFFFF; border:1px solid rgba(255, 255, 255, 0.2); backdrop-filter:blur(4px); flex:0 0 auto; width:80px;" onclick="openSettlementModal('${l.ts}')">ÁµêÁÆó</button>
                        <button class="btn-main-action" style="background:rgba(255, 255, 255, 0.2); color:#FFFFFF; border:1px solid rgba(255, 255, 255, 0.2); backdrop-filter:blur(4px);" onclick="startClass(event, '${l.ts}')">‚ñ∂ ÈñãÂßã</button>
                    </div>`;
            }

            return `
            <div class="schedule-card ${paidClass}" style="${cardStyle}">
                <div class="sch-top">
                    <div>
                        <div class="sch-title" onclick="openStudentMonthStats('${l.name}', '${todayStr.slice(0,7)}')">${l.name}</div>
                        ${timeDisplay}
                        <div class="sch-badge">${fullSubject}</div>
                    </div>
                    <div class="cal-top-btn" onclick="addToCalendar(event, '${l.ts}')">üìÖ</div>
                </div>
                
                <div class="note-wrapper">
                    <textarea class="inline-note" placeholder="Á¥ÄÈåÑ‰∏äË™≤ÂÖßÂÆπ..." onblur="updateContent('${l.ts}', this.value)">${l.content || ''}</textarea>
                    ${costOverlay}
                </div>
                
                ${mainAction}
            </div>`; 
        }).join('');
    }

    // --- V301: Export Calendar Logic (Fixed in V318) ---
    // V313: Fully rewrite Select All logic for reliability
    function openExportCalendarModal() {
        toggleSidebar(); 
        
        const futureLogs = window.logs.filter(l => {
            const logDate = new Date(l.date);
            const today = new Date();
            today.setHours(0,0,0,0);
            return logDate >= today && l.status === 'prepared';
        }).sort((a,b) => new Date(a.date) - new Date(b.date));

        const listDiv = document.getElementById('export-list');
        if(futureLogs.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ÁÑ°ÂèØÂåØÂá∫ÁöÑË™≤Á®ã</div>';
        } else {
            // V303 Fix: Make the whole row clickable
            // V314: Custom Checkbox style + Selected Class
            listDiv.innerHTML = futureLogs.map(l => `
                <div class="export-item selected" onclick="toggleExportItem(this)">
                    <input type="checkbox" class="export-check" value="${l.ts}" checked onclick="event.stopPropagation()">
                    <div style="flex:1;">
                        <div style="font-weight:700;">${l.date} - ${l.name}</div>
                        <div style="font-size:12px; color:#718096;">${l.subject || ''} ${l.timeStart ? '@'+l.timeStart : ''}</div>
                    </div>
                </div>
            `).join('');
        }
        openModalWithAnim('export-calendar-modal');
    }

    // V314: Ensure both checkbox and row style are updated
    function toggleExportItem(div) {
        const checkbox = div.querySelector('.export-check');
        if(checkbox) {
            checkbox.checked = !checkbox.checked;
            updateRowStyle(div, checkbox.checked);
        }
    }

    function toggleAllExport(state) {
        const rows = document.querySelectorAll('.export-item');
        rows.forEach(row => {
            const box = row.querySelector('.export-check');
            if(box) {
                box.checked = state;
                updateRowStyle(row, state);
            }
        });
    }

    function updateRowStyle(row, isChecked) {
        if(isChecked) row.classList.add('selected');
        else row.classList.remove('selected');
    }

    function performExport() {
        const checks = document.querySelectorAll('.export-check:checked');
        if(checks.length === 0) {
            alert("Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÈ†ÖÔºÅ");
            return;
        }

        let icsBody = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TutorApp//EN\n";
        
        checks.forEach(chk => {
            const log = window.logs.find(l => String(l.ts) === String(chk.value));
            if(log) {
                let startHour = 9, startMin = 0;
                if(log.timeStart) {
                    [startHour, startMin] = log.timeStart.split(':').map(Number);
                }
                const d = new Date(log.date);
                const format = (num) => String(num).padStart(2,'0');
                const totalStartMin = startHour * 60 + startMin;
                const totalEndMin = totalStartMin + (parseFloat(log.hours) * 60);
                const endHour = Math.floor(totalEndMin / 60);
                const endMin = totalEndMin % 60;
                const dtStart = `${d.getFullYear()}${format(d.getMonth()+1)}${format(d.getDate())}T${format(startHour)}${format(startMin)}00`;
                const dtEnd = `${d.getFullYear()}${format(d.getMonth()+1)}${format(d.getDate())}T${format(endHour)}${format(endMin)}00`;

                icsBody += `BEGIN:VEVENT\nUID:${log.ts}@tutorapp\nDTSTAMP:${dtStart}Z\nDTSTART:${dtStart}\nDTEND:${dtEnd}\nSUMMARY:${log.subject || 'ÂÆ∂Êïô'} - ${log.name}\nDESCRIPTION:${log.content || ''}\nEND:VEVENT\n`;
            }
        });

        icsBody += "END:VCALENDAR";

        const blob = new Blob([icsBody], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', `tutor_calendar_${new Date().toISOString().split('T')[0]}.ics`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        closeModal('export-calendar-modal');
    }
    
    // Legacy function support
    function batchExportCalendar() { openExportCalendarModal(); }

    function addToCalendar(e, ts) { if(e) e.stopPropagation(); const log = window.logs.find(l => String(l.ts) === String(ts)); if(!log) return; let startHour=9, startMin=0; if(log.timeStart) { [startHour, startMin] = log.timeStart.split(':').map(Number); } else { if(!confirm("ÁÑ°ÊôÇÈñìÔºåÈ†êË®≠09:00Ôºü")) return; } const d = new Date(log.date); const format = (num) => String(num).padStart(2,'0'); const totalStartMin = startHour * 60 + startMin; const totalEndMin = totalStartMin + (parseFloat(log.hours) * 60); const endHour = Math.floor(totalEndMin / 60); const endMin = totalEndMin % 60; const dtStart = `${d.getFullYear()}${format(d.getMonth()+1)}${format(d.getDate())}T${format(startHour)}${format(startMin)}00`; const dtEnd = `${d.getFullYear()}${format(d.getMonth()+1)}${format(d.getDate())}T${format(endHour)}${format(endMin)}00`; const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TutorApp//EN\nBEGIN:VEVENT\nUID:${log.ts}@tutorapp\nDTSTAMP:${dtStart}Z\nDTSTART:${dtStart}\nDTEND:${dtEnd}\nSUMMARY:${log.subject || 'ÂÆ∂Êïô'} - ${log.name}\nDESCRIPTION:${log.content || ''}\nEND:VEVENT\nEND:VCALENDAR`; const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' }); const link = document.createElement('a'); link.href = window.URL.createObjectURL(blob); link.setAttribute('download', `${log.name}_${log.date}.ics`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    function updateContent(ts, val) { const log = window.logs.find(l => String(l.ts) === String(ts)); if(log) { log.content = val; localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); } }
    function startClass(e, ts) { if(e) e.stopPropagation(); const log = window.logs.find(l => String(l.ts) === String(ts)); if(log) { log.status = 'running'; log.startTime = Date.now(); localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); renderSchedule(); } }
    function markAsPaid(e, ts) { if(e) e.stopPropagation(); const log = window.logs.find(l => String(l.ts) === String(ts)); if(log) { if(confirm(`Á¢∫Ë™çÊî∂Âà∞ $${log.income} ‰∫ÜÂóéÔºü`)) { log.status = 'paid'; localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); renderSchedule(); updateAssets(); if(document.getElementById('all-schedule-modal').classList.contains('active')) { const d = new Date(log.date); const targetMonthKey = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`; openAllScheduleModal(targetMonthKey); } } } }
    function updateRunningTimers() { window.logs.filter(l => l.status === 'running').forEach(l => { const el = document.getElementById(`timer-${l.ts}`); if (el) { const diff = Date.now() - l.startTime; const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000); el.innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; } }); }
    function openSettlementModal(ts) { settlingLogTs = ts; const timerEl = document.getElementById(`timer-${ts}`); document.getElementById('settlement-timer-display').innerText = timerEl ? timerEl.innerText : "00:00:00"; openModalWithAnim('settlement-modal'); }
    function confirmSettlement() { const h = document.getElementById('settlement-manual-hours').value; const log = window.logs.find(l => String(l.ts) === String(settlingLogTs)); if(h && log) { log.status = 'unpaid'; log.hours = h; log.income = Math.round(h * log.rate); localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); closeModal('settlement-modal'); renderSchedule(); updateAssets(); } }
    
    // --- ‰ª•‰∏ãÁÇ∫‰øÆÂæ©ËàáÊï¥ÁêÜÂæåÁöÑËºîÂä©ÂáΩÂºè (ÁßªÈô§ÈáçË§áÂÆöÁæ©) ---

    function addStudent() { const name = document.getElementById('new-name').value; const rate = document.getElementById('new-rate').value; const grade = document.getElementById('new-grade').value; const color = document.getElementById('new-color-val').value; if(!name || !rate || !grade) { const m = document.querySelector('#setup-modal .modal-content'); m.classList.add('shake-error'); setTimeout(() => m.classList.remove('shake-error'), 300); return; } window.students.push({name, rate, grade, color}); localStorage.setItem(DB_STU, JSON.stringify(window.students)); renderStudents(); closeModal('setup-modal'); }
    function selectColor(color, el) { document.getElementById('new-color-val').value = color; document.querySelectorAll('.color-opt').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }
    function setInputValue(inputId, val, btn) { document.getElementById(inputId).value = val; Array.from(btn.parentElement.children).forEach(c => c.classList.remove('selected')); btn.classList.add('selected'); }
    function selectOptionGroup(inputId, val, btn) { document.getElementById(inputId).value = val; Array.from(btn.parentElement.children).forEach(c => c.classList.remove('selected')); btn.classList.add('selected'); }
    function deleteStudent(idx) { if(confirm('Âà™Èô§ÈÄô‰ΩçÂ≠∏ÁîüÔºü')) { window.students.splice(idx, 1); localStorage.setItem(DB_STU, JSON.stringify(window.students)); renderStudents(); } }
    
    // [‰øÆÂæ©] ÊéíË™≤Ë¶ñÁ™óÔºöÂä†ÂÖ•Èò≤Ê≠¢ËàáÈï∑ÊåâÁ∑®ËºØÊ®°ÂºèË°ùÁ™ÅÁöÑÈÇèËºØ
    function openBatchPlanModal(idx) { 
        if (isLongPress) {
            isLongPress = false;
            return;
        }
        if (isEditMode) {
            return; // Á∑®ËºØÊ®°Âºè‰∏ãÈªûÊìäÁÑ°Êïà(Âè™ËÉΩÈªûX)
        }
       
        currentPlanningStuIdx = idx; 
        const s = window.students[idx]; 
        
        // Ë®≠ÂÆöÊ®ôÈ°å
        const titleEl = document.getElementById('log-name-display');
        titleEl.innerText = s.name;
        titleEl.style.position = 'relative'; // ÁÇ∫‰∫ÜËÆìÊåâÈàïÂÆö‰Ωç
        
        // [V336] Âä†ÂÖ•„ÄåÂ≠∏ÁîüÊ™îÊ°à„ÄçÂÖ•Âè£ÊåâÈàï (Â¶ÇÊûúÈÇÑÊ≤íÂä†ÈÅé)
        if (!document.getElementById('btn-open-profile')) {
            const btn = document.createElement('button');
            btn.id = 'btn-open-profile';
            btn.className = 'btn-float-profile btn-bubble';
            btn.innerHTML = 'üìÇ';
            btn.onclick = function(e) {
                e.stopPropagation(); // ÈÅøÂÖçÈªûÊìäËß∏ÁôºÂÖ∂‰ªñ‰∫ã‰ª∂
                openStudentProfile(currentPlanningStuIdx); // ÊâìÈñãÊñ∞È†ÅÈù¢
            };
            titleEl.appendChild(btn);
        } else {
            // Â¶ÇÊûúÊåâÈàïÂ∑≤Á∂ìÂ≠òÂú®ÔºåÊõ¥Êñ∞ÂÆÉÁöÑÈªûÊìä‰∫ã‰ª∂
            document.getElementById('btn-open-profile').onclick = function(e) {
                e.stopPropagation();
                openStudentProfile(currentPlanningStuIdx);
            };
        }

        document.getElementById('log-subject').value = s.subject || ''; 
        const subjContainer = document.getElementById('log-subject-group'); 
        if(subjContainer && s.subject) { 
            Array.from(subjContainer.children).forEach(btn => { 
                if(btn.innerText === s.subject) btn.classList.add('selected'); 
                else btn.classList.remove('selected'); 
            }); 
        } 
        selectedDates = []; 
        renderDateTags(); 
        document.getElementById('log-date').value = new Date().toISOString().split('T')[0]; 
        document.getElementById('log-time').value = ''; 
        openModalWithAnim('log-modal'); 
    }

    function renderDateTags() { const container = document.getElementById('date-tags'); container.innerHTML = selectedDates.map(date => `<div class="date-tag-item" onclick="removeDateTag('${date}')"><span>${date.slice(5)}</span><span style="font-size:16px;">‚úï</span></div>`).join(''); }
    function addDateTag() { const d = document.getElementById('log-date').value; if(d && !selectedDates.includes(d)) { selectedDates.push(d); renderDateTags(); } }
    function removeDateTag(date) { selectedDates = selectedDates.filter(d => d !== date); renderDateTags(); }
    
    function saveBatchPlan() { 
        const h = document.getElementById('log-hours').value; 
        const subj = document.getElementById('log-subject').value; 
        const note = document.getElementById('log-content-modal').value; 
        const timeVal = document.getElementById('log-time').value; 
        const s = window.students[currentPlanningStuIdx]; 
        
        if (selectedDates.length === 0) { 
            const pickerDate = document.getElementById('log-date').value; 
            if (pickerDate) selectedDates.push(pickerDate); 
        } 
        
        if (!h || !subj || selectedDates.length === 0 || !timeVal) { 
            const modalContent = document.querySelector('#log-modal .modal-content'); 
            modalContent.classList.add('shake-error'); 
            setTimeout(() => modalContent.classList.remove('shake-error'), 300); 
            return; 
        } 
        
        const duplicateDates = selectedDates.filter(date => window.logs.some(l => l.date === date && l.name === s.name)); 
        if(duplicateDates.length > 0) { 
            alert(`‚ö†Ô∏è Ê≥®ÊÑèÔºö${duplicateDates.join(', ')} Â∑≤Á∂ìÊéíÈÅé ${s.name} ÁöÑË™≤‰∫ÜÔºÅ`); 
            selectedDates = selectedDates.filter(date => !duplicateDates.includes(date)); 
            if(selectedDates.length === 0) return; 
        } 
        
        selectedDates.forEach(date => { 
            window.logs.push({ ts: Date.now() + Math.random(), name: s.name, rate: s.rate, hours: h, subject: subj, content: note, date: date, timeStart: timeVal, status: 'prepared', income: Math.round(h * s.rate) }); 
        }); 
        
        localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); 
        closeModal('log-modal'); 
        
        // --- Âà∑Êñ∞‰ªãÈù¢ÈÇèËºØ ---
        renderSchedule(); 
        updateAssets();
        
        // [Êñ∞Â¢û] ÈáùÂ∞çÊúàÊõÜ‰ªãÈù¢ÁöÑÂç≥ÊôÇÂà∑Êñ∞
        if (document.getElementById('calendar-day-modal').classList.contains('active')) {
            const currentViewDate = document.getElementById('cal-day-title').innerText;
            openCalendarDayModal(currentViewDate);
            renderCalendar();
        } else if (isCalendarView) {
            renderCalendar();
        }
    }
    
    function openEditLogModal(ts) { closeAllSwipes(); const log = window.logs.find(l => String(l.ts) === String(ts)); if(!log) return; document.getElementById('edit-log-ts').value = log.ts; document.getElementById('edit-log-date').value = log.date; document.getElementById('edit-log-time').value = log.timeStart || ''; document.getElementById('edit-log-hours').value = log.hours; document.getElementById('edit-log-subject').value = log.subject; document.getElementById('edit-log-content').value = log.content || ''; const hoursContainer = document.querySelector('#edit-log-modal .btn-options'); if(hoursContainer) { Array.from(hoursContainer.children).forEach(btn => { if(btn.innerText === String(log.hours)) btn.classList.add('selected'); else btn.classList.remove('selected'); }); } const subjContainer = document.getElementById('edit-subject-group'); if(subjContainer) { Array.from(subjContainer.children).forEach(btn => { if(btn.innerText === log.subject) btn.classList.add('selected'); else btn.classList.remove('selected'); }); } openModalWithAnim('edit-log-modal'); }
    
    function saveEditedLog() { 
        const ts = document.getElementById('edit-log-ts').value; 
        const log = window.logs.find(l => String(l.ts) === String(ts)); 
        if(!log) return; 
        
        const newDate = document.getElementById('edit-log-date').value; 
        const newTime = document.getElementById('edit-log-time').value; 
        const newHours = document.getElementById('edit-log-hours').value; 
        
        if(!newDate || !newHours) { alert('Êó•ÊúüÂíåÊôÇÊï∏ÁÇ∫ÂøÖÂ°´'); return; } 
        
        log.date = newDate; 
        log.timeStart = newTime; 
        log.hours = newHours; 
        log.subject = document.getElementById('edit-log-subject').value; 
        log.content = document.getElementById('edit-log-content').value; 
        log.income = Math.round(newHours * log.rate); 
        
        localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); 
        closeModal('edit-log-modal'); 
        
        // --- Âà∑Êñ∞‰ªãÈù¢ ---
        updateAssets(); 
        renderSchedule(); 
        
        // 1. Âà∑Êñ∞Ê≠∑Âè≤Á¥ÄÈåÑ (Â¶ÇÊûúÊúâÈñã)
        if(document.getElementById('all-schedule-modal').classList.contains('active')) { 
            const d = new Date(newDate); 
            const targetMonthKey = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`; 
            openAllScheduleModal(targetMonthKey); 
        } 

        // 2. [Ë£ú‰∏ä] Âà∑Êñ∞ÊúàÊõÜÁï∂Êó•Ë©≥ÊÉÖ (Â¶ÇÊûúÊúâÈñã)
        if (document.getElementById('calendar-day-modal').classList.contains('active')) {
            const currentViewDate = document.getElementById('cal-day-title').innerText;
            openCalendarDayModal(currentViewDate);
            // ÂêåÊ≠•Âà∑Êñ∞ËÉåÊôØÊúàÊõÜÁ¥ÖÈªû
            renderCalendar();
        } 
        // 3. [Ë£ú‰∏ä] Âà∑Êñ∞ÊúàÊõÜË¶ñÂúñ (Â¶ÇÊûúÂú®ÊúàÊõÜÊ®°Âºè)
        else if (isCalendarView) {
            renderCalendar();
        }
    }
    
    // [‰øÆÂæ©] Âà™Èô§Ë™≤Á®ãÈÇèËºØ
    function deleteLog(e, ts) { 
        if(e) { e.preventDefault(); e.stopPropagation(); } 
        if(confirm('Âà™Èô§Ê≠§Ë™≤Á®ãÁ¥ÄÈåÑÔºü')) { 
            const targetLog = window.logs.find(l => String(l.ts) === String(ts)); 
            let targetMonthKey = null, targetDateStr = null, targetName = null;
            if(targetLog) { 
                const d = new Date(targetLog.date); 
                targetMonthKey = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`; 
                targetDateStr = targetLog.date;
                targetName = targetLog.name;
            } 
            window.logs = window.logs.filter(l => String(l.ts) !== String(ts)); 
            localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); 
            updateAssets(); renderSchedule(); 
            if(document.getElementById('all-schedule-modal').classList.contains('active')) openAllScheduleModal(targetMonthKey); 
            if(document.getElementById('calendar-day-modal').classList.contains('active') && targetDateStr) { openCalendarDayModal(targetDateStr); renderCalendar(); }
            if(document.getElementById('student-history-modal').classList.contains('active') && targetName) {
                const titleText = document.getElementById('stu-history-name').innerText;
                const specificYM = titleText.includes('-') ? targetDateStr.slice(0, 7) : null;
                openStudentMonthStats(targetName, specificYM);
            }
            if(isCalendarView) renderCalendar();
        } 
    }
    
    function generateSwipeItem(l, dateHTML, color, income, specificYM = null, isAssetList = false) { 
        let actionBtn = ''; const clickYM = specificYM || l.date.slice(0, 7); 
        const containerId = isAssetList ? `swipe-${l.ts}-asset` : `swipe-${l.ts}`;
        const editBtn = `<div class="btn-action-uniform btn-bubble" onclick="openEditLogModal('${l.ts}')">‚úé</div>`; 
        const calBtn = `<div class="btn-action-uniform btn-bubble" onclick="addToCalendar(event, '${l.ts}')">üìÖ</div>`; 
        const settleBtn = `<div class="btn-action-uniform btn-bubble" style="background:#EBF8FF; color:#4299E1; border:none;" onclick="openSettleConfirmModal(event, '${l.ts}')">‚úî</div>`; 
        if(l.status === 'paid') { actionBtn = ''; } 
        else if (l.status === 'unpaid') { actionBtn = `<button class="btn-mini-pay btn-bubble" onclick="markAsPaid(event, '${l.ts}')">üí∞ Êî∂Ê¨æ</button>`; } 
        else if (l.status === 'running') { actionBtn = `<span style="font-size:11px; color:#C95D4E; font-weight:700;">(ÈÄ≤Ë°å‰∏≠)</span>`; } 
        else { actionBtn = `${editBtn}${calBtn}${settleBtn}`; } 
        return `<div class="swipe-container" id="${containerId}"><div class="swipe-bg-delete" onclick="deleteLog(event, '${l.ts}')">Âà™Èô§</div><div class="swipe-content" ontouchstart="handleSwipeStart(event, '${containerId}')" ontouchmove="handleSwipeMove(event, '${containerId}')" ontouchend="handleSwipeEnd(event, '${containerId}')"><div class="list-date">${dateHTML}</div><div class="list-info"><span class="history-name-link" onclick="event.stopPropagation(); openStudentMonthStats('${l.name}', '${clickYM}')">${l.name}</span><span class="subject-tag">${l.subject || 'Ë™≤Á®ã'}</span></div><div class="list-right"><div class="list-income" style="color:${color}">${l.status === 'paid' ? '+' : ''}$${income}</div>${actionBtn}</div></div></div>`; 
    }
    
    let listSwipeStartX = 0; let listSwipeCurrentX = 0; let activeSwipeId = null; let isDragging = false;
    function handleSwipeStart(e, id) { if(activeSwipeId && activeSwipeId !== id) closeAllSwipes(); listSwipeStartX = e.touches[0].clientX; listSwipeCurrentX = listSwipeStartX; isDragging = false; e.currentTarget.style.transition = 'none'; }
    function handleSwipeMove(e, id) { listSwipeCurrentX = e.touches[0].clientX; const diff = listSwipeCurrentX - listSwipeStartX; if(Math.abs(diff) > 10) isDragging = true; if (diff < 0) { if(e.cancelable && Math.abs(diff) > 5) e.preventDefault(); const el = e.currentTarget; if (diff > -100) el.style.transform = `translateX(${diff}px)`; } }
    function handleSwipeEnd(e, id) { if (!isDragging) return; const diff = listSwipeCurrentX - listSwipeStartX; const el = e.currentTarget; el.style.transition = 'transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28)'; if (diff < -60) { el.style.transform = 'translateX(-90px)'; activeSwipeId = id; } else { el.style.transform = 'translateX(0)'; activeSwipeId = null; } listSwipeStartX = 0; listSwipeCurrentX = 0; isDragging = false; }
    function closeAllSwipes() { document.querySelectorAll('.swipe-content').forEach(el => { el.style.transition = 'transform 0.2s ease-out'; el.style.transform = 'translateX(0)'; }); activeSwipeId = null; }
    
    function openStudentMonthStats(name, specificYM) {
        currentStatsStudent = name;
        const modal = document.getElementById('student-history-modal');
        const list = document.getElementById('stu-history-list');
        const title = document.getElementById('stu-history-name');
        const totalDisplay = document.getElementById('stu-history-total');
        const delAllBtn = document.getElementById('btn-delete-all-logs');
        title.innerText = `${name} - ${specificYM || 'Á∏ΩË¶Ω'}`;
        let targetLogs = window.logs.filter(l => l.name === name);
        if(specificYM) { targetLogs = targetLogs.filter(l => l.date.startsWith(specificYM)); }
        targetLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
        let total = 0;
        targetLogs.forEach(l => { if(l.status === 'paid' || l.status === 'unpaid') total += (parseInt(l.income) || 0); });
        totalDisplay.innerText = `$${total.toLocaleString()}`;
        if(targetLogs.length === 0) { list.innerHTML = '<div style="text-align:center;padding:20px;color:#999">ÁÑ°Á¥ÄÈåÑ</div>'; delAllBtn.style.display = 'none'; } 
        else { delAllBtn.style.display = 'block'; delAllBtn.onclick = () => deleteAllStudentLogs(name, specificYM); list.innerHTML = targetLogs.map(l => { const dObj = new Date(l.date); const dayName = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'][dObj.getDay()]; const dayStr = l.date.split('-')[2]; const dateHTML = `${dayStr} <span class="list-date-day">${dayName}</span>`; let color = '#AAA'; if(l.status === 'paid') color = 'var(--money-green)'; if(l.status === 'unpaid') color = 'var(--accent-primary)'; return generateSwipeItem(l, dateHTML, color, l.income, specificYM, false); }).join(''); }
        openModalWithAnim('student-history-modal');
    }

    function deleteAllStudentLogs(name, specificYM) {
        const msg = specificYM ? `Á¢∫ÂÆöÂà™Èô§ ${name} Âú® ${specificYM} ÁöÑÊâÄÊúâÁ¥ÄÈåÑÂóéÔºü` : `Á¢∫ÂÆöÂà™Èô§ ${name} ÁöÑÊâÄÊúâÁ¥ÄÈåÑÂóéÔºü`;
        if(confirm(msg)) { window.logs = window.logs.filter(l => { if(l.name !== name) return true; if(specificYM && !l.date.startsWith(specificYM)) return true; return false; }); localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); closeModal('student-history-modal'); updateAssets(); renderSchedule(); if(document.getElementById('all-schedule-modal').classList.contains('active')) { openAllScheduleModal(); } }
    }

    function openSettleConfirmModal(e, ts) { if(e) e.stopPropagation(); closeAllSwipes(); const log = window.logs.find(l => String(l.ts) === String(ts)); if(log) { document.getElementById('settle-target-ts').value = ts; document.getElementById('settle-confirm-name').innerText = log.name; document.getElementById('settle-confirm-detail').innerText = `${log.hours}hr ‚Ä¢ ${log.subject || 'Ë™≤Á®ã'}`; openModalWithAnim('settle-confirm-modal'); } }
    function performSettle() { const ts = document.getElementById('settle-target-ts').value; const log = window.logs.find(l => String(l.ts) === String(ts)); if(log) { log.status = 'unpaid'; localStorage.setItem(DB_LOG, JSON.stringify(window.logs)); updateAssets(); closeModal('settle-confirm-modal'); if(document.getElementById('all-schedule-modal').classList.contains('active')) { const d = new Date(log.date); const targetMonthKey = `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`; openAllScheduleModal(targetMonthKey); } } }
    function editProfileName() { const newName = prompt("Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂêçÂ≠ó (‰æãÂ¶Ç: Tutor)", profileData.name || "Tutor"); if(newName) { profileData.name = newName; localStorage.setItem(DB_PROF, JSON.stringify(profileData)); updateProfileDisplay(); } }
    function triggerUpload() { document.getElementById('avatar-upload').click(); }
    function handleAvatarUpload(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { profileData.avatar = `url(${e.target.result})`; localStorage.setItem(DB_PROF, JSON.stringify(profileData)); updateProfileDisplay(); }; reader.readAsDataURL(input.files[0]); } }
    function updateProfileDisplay() { const avatars = [document.getElementById('sidebar-avatar'), document.getElementById('profile-avatar')]; avatars.forEach(el => { if(el) { if(profileData.avatar.startsWith('url')) { el.style.backgroundImage = profileData.avatar; el.innerText = ''; } else { el.style.backgroundImage = 'none'; el.innerText = profileData.avatar; } } }); document.getElementById('sidebar-name').innerText = profileData.name || "Tutor"; }
    function saveMood() { const txt = document.getElementById('mood-input').value; if(!txt) return; const now = new Date(); const entry = { date: `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`, text: txt, ts: Date.now() }; profileData.moods.unshift(entry); localStorage.setItem(DB_PROF, JSON.stringify(profileData)); document.getElementById('mood-input').value = ''; renderMoods(); }
    function renderMoods() { const list = document.getElementById('mood-list'); list.innerHTML = (profileData.moods || []).map(m => ` <div style="padding:10px; border-bottom:1px solid #EEE;"> <div style="font-size:12px; color:#999; margin-bottom:4px;">${m.date}</div> <div style="font-size:14px; color:var(--text-main); font-weight:700;">${m.text}</div> </div> `).join(''); }
    function exportData() { const data = { students: window.students, logs: window.logs, bank: window.bankLogs, profile: profileData }; const blob = new Blob([JSON.stringify(data)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `tutor_backup_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    function triggerImport() { document.getElementById('import-file').click(); }
    function importData(input) { if(input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if(confirm("Á¢∫ÂÆöË¶ÅÈÇÑÂéüÂÇô‰ªΩË≥áÊñôÂóéÔºüÁèæÊúâË≥áÊñôÂ∞áË¢´Ë¶ÜËìãÔºÅ")) { if(data.students) localStorage.setItem(DB_STU, JSON.stringify(data.students)); if(data.logs) localStorage.setItem(DB_LOG, JSON.stringify(data.logs)); if(data.bank) localStorage.setItem(DB_BANK, JSON.stringify(data.bank)); if(data.profile) localStorage.setItem(DB_PROF, JSON.stringify(data.profile)); alert("ÈÇÑÂéüÊàêÂäüÔºÅ"); location.reload(); } } catch(err) { alert("Ê™îÊ°àÊ†ºÂºèÈåØË™§"); } }; reader.readAsText(input.files[0]); } }
    
    // V334: Render Monthly Summary & LINE Button (Add Weekday)
    function renderMonthlySummary() {
        const container = document.getElementById('cal-summary-area');
        const y = calViewDate.getFullYear();
        const m = calViewDate.getMonth() + 1;
        const monthPrefix = `${y}-${String(m).padStart(2,'0')}`;
        
        let summaryHTML = `<div class="summary-title">Êú¨ÊúàÊéíË™≤ÈÄöÁü• (${m}Êúà)</div>`;
        let hasData = false;

        window.students.forEach(s => {
            const stuLogs = window.logs
                .filter(l => l.name === s.name && l.date.startsWith(monthPrefix))
                .sort((a,b) => new Date(a.date) - new Date(b.date));
            
            if(stuLogs.length > 0) {
                hasData = true;
                const dateDisplay = stuLogs.map(l => { const d = new Date(l.date); return `${d.getMonth()+1}/${d.getDate()}`; }).join(', ');
                
                let lineMsg = `${s.name}Â™ΩÂ™Ω‰Ω†Â•ΩÔºåÈÄôÂÄãÊúàÂπ´${s.name}ÊéíË™≤‰∫ÜÔºå‰ª•‰∏ãÊòØ${s.name} ${m}ÊúàÁöÑË™≤Á®ãÂÆâÊéíÔºö\n`;
                
                stuLogs.forEach(l => {
                    // 1. Ë®àÁÆóÊôÇÈñìÁØÑÂúç
                    let timeRange = "";
                    if (l.timeStart) {
                        if (l.hours) {
                            const [h, min] = l.timeStart.split(':').map(Number);
                            const totalMin = h * 60 + min + (parseFloat(l.hours) * 60);
                            const endH = Math.floor(totalMin / 60) % 24;
                            const endM = Math.floor(totalMin % 60);
                            const endTime = `${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
                            timeRange = `${l.timeStart}-${endTime}`;
                        } else { 
                            timeRange = `${l.timeStart}`; 
                        }
                    }
                    
                    // 2. ËôïÁêÜÊó•ÊúüËàáÊòüÊúü
                    const d = new Date(l.date);
                    const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                    const dayChar = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'][d.getDay()];
                    
                    // 3. ÁµÑÂêàË®äÊÅØ
                    lineMsg += `${dateStr} ${dayChar} ${l.subject || 'Ë™≤Á®ã'} ${timeRange}\n`;
                });
                
                // [‰øÆÊîπ] Êõ¥Êñ∞ÁµêÂ∞æÊñáÂ≠ó
                lineMsg += `È∫ªÁÖ©Â™ΩÂ™ΩÂÜçÂπ´ÊàëÁ¢∫Ë™ç‰∏Ä‰∏ãÔºåË™≤Á®ãÊôÇÈñìÊúâÊ≤íÊúâÈúÄË¶ÅÁï∞ÂãïÁöÑÔºåÊ≤íÊúâÂïèÈ°åÁöÑË©±ÔºåË¨ùË¨ù„ÄÇ`;
                
                const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(lineMsg)}`;

                summaryHTML += `
                    <div class="summary-row">
                        <div class="summary-left">
                            <div class="summary-name">${s.name} <span style="font-size:12px;color:#CBD5E0;font-weight:600;">(${stuLogs.length}Â†Ç)</span></div>
                            <div class="summary-dates">${dateDisplay}</div>
                        </div>
                        <button class="btn-line-action" onclick="window.open('${lineUrl}', '_blank')">
                            LINE ÈÄöÁü•
                        </button>
                    </div>
                `;
            }
        });

        if(!hasData) {
            container.innerHTML = `<div style="text-align:center; color:#CBD5E0; padding:20px; font-size:13px;">Êú¨ÊúàÂ∞öÁÑ°ÊéíË™≤Á¥ÄÈåÑ</div>`;
        } else {
            container.innerHTML = summaryHTML;
        }
    }
    
    // --- V336: Student Profile Logic ---
    let currentProfileIdx = null;

    function switchProfileTab(tabName) {
        // Èö±ËóèÊâÄÊúâÂàÜÈ†Å
        document.querySelectorAll('.profile-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // È°ØÁ§∫ÁõÆÊ®ôÂàÜÈ†Å
        document.getElementById(`tab-${tabName}`).classList.add('active');
        // ÊåâÈàïÈ´ò‰∫ÆÈÇèËºØ (ÈÄôË£°Á∞°ÂñÆËôïÁêÜÔºåÂª∫Ë≠∞‰æùÈ†ÜÂ∫èÁ∂ÅÂÆö)
        const buttons = document.querySelectorAll('.profile-tabs .tab-btn');
        if(tabName === 'exam') buttons[0].classList.add('active');
        if(tabName === 'note') buttons[1].classList.add('active');
        if(tabName === 'info') buttons[2].classList.add('active');
    }

    function saveStudentProfile() {
        const s = window.students[currentProfileIdx];
        
        // ÂÑ≤Â≠òË®≠ÂÆö
        s.rate = document.getElementById('profile-edit-rate').value;
        s.grade = document.getElementById('profile-edit-grade').value;
        
        // ÂÑ≤Â≠òÁ≠ÜË®ò
        s.strength = document.getElementById('profile-strength').value;
        s.weakness = document.getElementById('profile-weakness').value;
        s.memo = document.getElementById('profile-memo').value;
        
        localStorage.setItem(DB_STU, JSON.stringify(window.students));
        
        // Âà∑Êñ∞Â§ñËßÄ
        renderStudents();
        document.getElementById('profile-modal-name').innerText = s.name;
        document.getElementById('profile-modal-grade').innerText = s.grade;
        
        alert('Ë≥áÊñôÂ∑≤Êõ¥Êñ∞ÔºÅ');
    }

    /* --- V337 JS IMPLEMENTATION --- */

    // ÂÆöÁæ©ÁßëÁõÆËàáÈ°èËâ≤
    const SUBJECT_CONFIG = {
        math: { label: 'Êï∏Â≠∏', color: '#E07A5F' },
        eng:  { label: 'Ëã±Êñá', color: '#3D5A80' },
        chi:  { label: 'ÂúãÊñá', color: '#98C1D9' },
        sci:  { label: 'Ëá™ÁÑ∂', color: '#81B29A' }
    };
    
    // Áî®‰æÜË®òÈåÑÁõÆÂâçÂúñË°®ÊÉ≥Èö±ËóèÁöÑÁßëÁõÆ (ToggleÂäüËÉΩ)
    let hiddenSubjects = [];

    // 1. ‰øÆÊîπÈñãÂïüÂÄã‰∫∫Ê™îÊ°àÈÇèËºØÔºöÂä†ÂÖ•ÂúñË°®Áπ™Ë£Ω
    function openStudentProfile(idx) {
        currentProfileIdx = idx;
        const s = window.students[idx];
        
        // Âü∫Êú¨Ë≥áÊñôÂ°´ÂÖ• (Á∂≠ÊåÅ‰∏çËÆä)
        document.getElementById('profile-modal-name').innerText = s.name;
        document.getElementById('profile-modal-avatar').innerText = s.name[0];
        document.getElementById('profile-modal-avatar').style.background = s.color || '#FFF';
        document.getElementById('profile-modal-grade').innerText = s.grade || 'Êú™Ë®≠ÂÆöÂπ¥Á¥ö';
        
        // Ë®≠ÂÆöÈ†ÅË≥áÊñô (Á∂≠ÊåÅ‰∏çËÆä)
        document.getElementById('profile-edit-rate').value = s.rate;
        const gradeOpt = document.getElementById('profile-grade-opt');
        if(gradeOpt) {
            Array.from(gradeOpt.children).forEach(btn => {
                if(btn.innerText === s.grade) btn.classList.add('selected');
                else btn.classList.remove('selected');
            });
        }
        document.getElementById('profile-edit-grade').value = s.grade;
        
        // Á≠ÜË®òË≥áÊñô (Á∂≠ÊåÅ‰∏çËÆä)
        document.getElementById('profile-strength').value = s.strength || '';
        document.getElementById('profile-weakness').value = s.weakness || '';
        document.getElementById('profile-memo').value = s.memo || '';

        // V337: ÂàùÂßãÂåñÊàêÁ∏æÂàóË°®ËàáÂúñË°®
        if (!s.exams) s.exams = []; // Á¢∫‰øùÊúâÈô£Âàó
        renderExamList(s.exams);
        drawExamChart(s.exams);

        switchProfileTab('exam');
        openModalWithAnim('student-profile-modal');
    }

    // 2. Ê∏≤ÊüìÊàêÁ∏æÂàóË°® (Âç°ÁâáÂºè)
    function renderExamList(exams) {
        const div = document.getElementById('exam-list-area');
        
        if(!exams || exams.length === 0) {
            div.innerHTML = `
                <div style="text-align:center;color:#AAA;padding:40px 20px; opacity:0.6;">
                    <div style="font-size:40px;margin-bottom:10px;">üìâ</div>
                    Â∞öÊú™Êñ∞Â¢ûËÄÉË©¶Á¥ÄÈåÑ<br>ÈªûÊìä‰∏ãÊñπÊåâÈàïÈñãÂßãËøΩËπ§ÊàêÁ∏æ
                </div>`;
            return;
        }

        // ‰æùÁÖßÊôÇÈñìÂÄíÂ∫èÊéíÂàó (Êñ∞ÁöÑÂú®‰∏äÈù¢)
        const sortedExams = [...exams].reverse();

        div.innerHTML = sortedExams.map((ex, i) => {
            // Ë®àÁÆóÂéüÂßãÁ¥¢Âºï‰ª•‰æøÂà™Èô§
            const originalIndex = exams.length - 1 - i;
            
            // Áî¢ÁîüÂêÑÁßëÂ∞èÂç°
            let scoreHtml = '';
            Object.keys(SUBJECT_CONFIG).forEach(key => {
                const val = ex.scores[key];
                if(val) {
                    const numVal = parseInt(val);
                    const colorClass = numVal >= 90 ? 'high' : (numVal < 60 ? 'low' : '');
                    scoreHtml += `
                        <div class="score-badge">
                            <span class="score-val ${colorClass}">${val}</span>
                            <span class="score-subj">${SUBJECT_CONFIG[key].label}</span>
                        </div>
                    `;
                }
            });

            return `
            <div class="exam-card">
                <div class="exam-header" style="margin-bottom:10px;">
                    <span class="exam-title">${ex.term}</span>
                    <button class="btn-delete-exam" onclick="deleteExam(${originalIndex})">√ó</button>
                </div>
                <div style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;">
                    ${scoreHtml || '<span style="font-size:12px;color:#CBD5E0;">ÁÑ°ÊàêÁ∏æË≥áÊñô</span>'}
                </div>
            </div>
            `;
        }).join('');
    }

    // 3. Áπ™Ë£Ω SVG ÊäòÁ∑öÂúñ (Ê†∏ÂøÉÂäüËÉΩ)
    function drawExamChart(exams) {
        const container = document.getElementById('exam-chart-area');
        
        if (!exams || exams.length < 2) {
            container.innerHTML = '<div style="font-size:12px; color:#CBD5E0; text-align:center;">Ëá≥Â∞ëÈúÄË¶ÅÂÖ©Á≠ÜË≥áÊñôÊâçËÉΩÁπ™Ë£ΩË∂®Âã¢Âúñ</div>';
            return;
        }

        // SVG Ë®≠ÂÆö
        const W = container.offsetWidth - 20; // Padding
        const H = 200;
        const P = 30; // Padding inside SVG
        
        // ÊâæÂá∫ÊâÄÊúâÊúâÂàÜÊï∏ÁöÑÁßëÁõÆ
        let activeSubjects = [];
        exams.forEach(e => {
            Object.keys(e.scores).forEach(s => {
                if(e.scores[s] && !activeSubjects.includes(s)) activeSubjects.push(s);
            });
        });

        // Áî¢Áîü SVG ÂÖßÂÆπ
        let svgContent = '';
        
        // Áπ™Ë£ΩËÉåÊôØÊ†ºÁ∑ö (0, 60, 80, 100)
        [0, 60, 80, 100].forEach(score => {
            const y = H - P - ((score / 100) * (H - 2 * P));
            svgContent += `<line x1="${P}" y1="${y}" x2="${W-P}" y2="${y}" class="chart-grid" />`;
            svgContent += `<text x="${5}" y="${y+3}" class="chart-text">${score}</text>`;
        });

        // Áπ™Ë£ΩÊäòÁ∑ö
        activeSubjects.forEach(subj => {
            if(hiddenSubjects.includes(subj)) return; // Â¶ÇÊûúË¢´Èö±ËóèÂâá‰∏çÁï´

            const color = SUBJECT_CONFIG[subj] ? SUBJECT_CONFIG[subj].color : '#333';
            let points = [];
            
            exams.forEach((ex, i) => {
                const score = parseInt(ex.scores[subj] || 0);
                if(score > 0) {
                    const x = P + (i * ((W - 2 * P) / (exams.length - 1)));
                    const y = H - P - ((score / 100) * (H - 2 * P));
                    points.push({x, y, score});
                }
            });

            if(points.length > 0) {
                // Áï´Á∑ö
                let pathD = `M ${points[0].x} ${points[0].y}`;
                points.slice(1).forEach(p => pathD += ` L ${p.x} ${p.y}`);
                svgContent += `<path d="${pathD}" class="chart-line" stroke="${color}" />`;

                // Áï´Èªû
                points.forEach(p => {
                    svgContent += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="${color}" class="chart-dot"><title>${p.score}</title></circle>`;
                });
            }
        });

        // Áî¢ÁîüÂúñ‰æã (Legend)
        let legendHtml = Object.keys(SUBJECT_CONFIG).map(key => {
            const isHidden = hiddenSubjects.includes(key);
            return `
                <div class="legend-item ${isHidden?'hidden':''}" onclick="toggleChartSubject('${key}')">
                    <div class="legend-dot" style="background:${SUBJECT_CONFIG[key].color}"></div>
                    ${SUBJECT_CONFIG[key].label}
                </div>
            `;
        }).join('');

        container.innerHTML = `
            <div class="legend-container">${legendHtml}</div>
            <svg class="chart-svg" viewBox="0 0 ${W} ${H}">${svgContent}</svg>
        `;
    }

    // Toggle ÂúñË°®ÁßëÁõÆÈ°ØÁ§∫
    function toggleChartSubject(subj) {
        if(hiddenSubjects.includes(subj)) {
            hiddenSubjects = hiddenSubjects.filter(s => s !== subj);
        } else {
            hiddenSubjects.push(subj);
        }
        // ÈáçÊñ∞Áπ™Ë£Ω
        const s = window.students[currentProfileIdx];
        drawExamChart(s.exams);
    }

    // 4. ÈñãÂïüÊñ∞Â¢ûËÄÉË©¶ÂΩàÁ™ó
    function addNewExamTerm() {
        // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
        document.getElementById('score-math').value = '';
        document.getElementById('score-eng').value = '';
        document.getElementById('score-chi').value = '';
        document.getElementById('score-sci').value = '';
        
        // È†êË®≠ÂêçÁ®±ÔºöÁ¨¨ X Ê¨°ÊÆµËÄÉ
        const s = window.students[currentProfileIdx];
        const count = (s.exams ? s.exams.length : 0) + 1;
        document.getElementById('exam-term-input').value = `Á¨¨ ${count} Ê¨°ÊÆµËÄÉ`;
        
        openModalWithAnim('add-exam-modal');
    }

    // 5. ÂÑ≤Â≠òÊñ∞ËÄÉË©¶
    function saveNewExam() {
        const term = document.getElementById('exam-term-input').value;
        const math = document.getElementById('score-math').value;
        const eng = document.getElementById('score-eng').value;
        const chi = document.getElementById('score-chi').value;
        const sci = document.getElementById('score-sci').value;

        if(!term) {
            alert("Ë´ãËº∏ÂÖ•ËÄÉË©¶ÂêçÁ®±");
            return;
        }

        const newExam = {
            ts: Date.now(),
            term: term,
            scores: {
                math: math,
                eng: eng,
                chi: chi,
                sci: sci
            }
        };

        const s = window.students[currentProfileIdx];
        if(!s.exams) s.exams = [];
        s.exams.push(newExam);

        localStorage.setItem(DB_STU, JSON.stringify(window.students));
        
        closeModal('add-exam-modal');
        
        // Âà∑Êñ∞‰ªãÈù¢
        renderExamList(s.exams);
        drawExamChart(s.exams);
    }

    // 6. Âà™Èô§ËÄÉË©¶
    function deleteExam(examIndex) {
        if(confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÊàêÁ∏æÁ¥ÄÈåÑÂóéÔºü")) {
            const s = window.students[currentProfileIdx];
            s.exams.splice(examIndex, 1);
            localStorage.setItem(DB_STU, JSON.stringify(window.students));
            
            renderExamList(s.exams);
            drawExamChart(s.exams);
        }
    }
</script>
</body>
</html>
